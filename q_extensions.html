<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="Doxygen Awesome" />
<meta property="og:image" content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452" />
<meta property="og:description" content="Custom CSS theme for doxygen html-documentation with lots of customization parameters." />
<meta property="og:url" content="https://jothepro.github.io/doxygen-awesome-css/" />
<!-- END opengraph metadata -->
<!-- BEGIN twitter metadata -->
<meta name="twitter:image:src" content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452" />
<meta name="twitter:title" content="Doxygen Awesome" />
<meta name="twitter:description" content="Custom CSS theme for doxygen html-documentation with lots of customization parameters." />
<!-- END twitter metadata -->
<title>OS: Extensions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/svg+xml" href="logo.drawio.svg"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/jothepro/doxygen-awesome-css" class="github-corner" title="View source on GitHub" target="_blank">
    <svg viewBox="0 0 250 250" width="40" height="40" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="quarktslogo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OS
   &#160;<span id="projectnumber">v7.2.4</span>
   </div>
   <div id="projectbrief">Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('q_extensions.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Extensions </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#q_stimers">STimers</a><ul><li class="level2"><a href="#q_stimerusage">Using a STimer</a></li>
<li class="level2"><a href="#q_stimerexample">STimer example</a></li>
</ul>
</li>
<li class="level1"><a href="#q_fsm">Finite State Machines (FSM)</a><ul><li class="level2"><a href="#qfsm_approach">The provided approach</a></li>
<li class="level2"><a href="#q_fsmsetup">Setting up a state machine</a></li>
<li class="level2"><a href="#q_fsm_subscribe_states">Subscribing states and defining callbacks</a></li>
<li class="level2"><a href="#q_fsmhandler">The state callback handler: performing transitions and retreiving data</a></li>
<li class="level2"><a href="#q_fsm_surrounding">The surrounding callback</a></li>
<li class="level2"><a href="#q_fsm_astask">Adding a state machine as a task</a></li>
<li class="level2"><a href="#q_fsm_example1">A demonstrative example for a FSM</a></li>
<li class="level2"><a href="#q_fsmsendsignals">Sending signals</a></li>
<li class="level2"><a href="#q_fsminstallsignalqueue">Installing a signal queue</a></li>
<li class="level2"><a href="#q_fsm_ttable">Using a transition table</a></li>
<li class="level2"><a href="#q_fsm_sigactions">Signal actions and guards</a></li>
<li class="level2"><a href="#q_fsm_timeout">FSM Timeout specification</a></li>
<li class="level2"><a href="#q_fsm_example2">Demonstrative example using transition tables</a></li>
<li class="level2"><a href="#qfsm_happroach">Using the hierarchical approach</a><ul><li class="level3"><a href="#q_fsm_example3">Example usign a hierarchical FSM</a></li>
<li class="level3"><a href="#q_fsm_example4">Example with history pseudo-states</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#q_qcoroutines">Co-Routines</a><ul><li class="level2"><a href="#q_coroutine_code">Coding a Co-Routine</a></li>
<li class="level2"><a href="#q_coroutine_blocking">Blocking calls in a Co-routine</a></li>
<li class="level2"><a href="#q_coroutine_example1">Co-Routine usage example</a></li>
<li class="level2"><a href="#q_coroutine_positions">Positional jumps</a></li>
<li class="level2"><a href="#q_coroutine_semaphores">Semaphores</a></li>
<li class="level2"><a href="#q_coroutine_example2">Co-Routine example with semaphores.</a></li>
<li class="level2"><a href="#q_coroutine_ext">External control</a></li>
</ul>
</li>
<li class="level1"><a href="#q_atcli">AT Command Line Interface (CLI)</a><ul><li class="level2"><a href="#q_atcli_components">The components of the CLI</a></li>
<li class="level2"><a href="#q_atcli_syntax">Supported syntax</a></li>
<li class="level2"><a href="#q_atcli_setup">Setting up an AT-CLI instance</a></li>
<li class="level2"><a href="#q_atcli_sub_commands">Subscribing commands to the parser</a></li>
<li class="level2"><a href="#q_atcli_cmd_callback">Writting a command callback</a></li>
<li class="level2"><a href="#q_atcli_inputh">Handling the input</a></li>
<li class="level2"><a href="#q_atcli_run">Running the CLI parser</a></li>
<li class="level2"><a href="#q_atcli_example1">A CLI example</a></li>
</ul>
</li>
<li class="level1"><a href="#q_memmang">Memory Management</a><ul><li class="level2"><a href="#q_memmang_principle">Principle of operation</a></li>
<li class="level2"><a href="#q_memmang_pools">Memory pools</a></li>
<li class="level2"><a href="#q_memmang_usage">Usage example</a></li>
</ul>
</li>
<li class="level1"><a href="#q_trace">Trace and debugging</a><ul><li class="level2"><a href="#q_trace_viewvars">Viewing variables</a></li>
<li class="level2"><a href="#q_trace_mblock">Viewing a memory block</a></li>
<li class="level2"><a href="#q_trace_usage">Usage</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="q_stimers"></a>
STimers</h1>
<p >There are several situations where the application does not need such hard real-time precision for timing actions and we just need that a section of code will execute when at least, some amount of time has elapsed. For these purposes, STimers (Software-Timers) is the right extension to use.</p>
<p >The STimers implementation does not access resources from the interrupt context, does not consume any significant processing time unless a timer has actually expired, does not add any processing overhead to the sys-tick interrupt, and does not walk any other data structures. The timer service just takes the value of the existing kernel clock source for reference \( t_{sys}\) , allowing timer functionality to be added to an application with minimal impact.</p>
<center>  
<!DOCTYPE html>
<html>
<head>
<title>stimer</title>
<meta charset="utf-8"/>
</head>
<body><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;zoom&quot;:1.2,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-10-18T15:06:53.012Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\&quot; etag=\&quot;D0ASMuxQqJpFRMXpmBB_\&quot; version=\&quot;20.2.2\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;rcvfuREYuiKnwBi7l4OG\&quot; name=\&quot;Página-1\&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
</body>
</html>
 <em>STimers operation</em> </center><p >As illustrated in the figure, the time expiration check is roll-over safe by restricting it, to the only calculation that make sense for timestamps, \( t_{sys} − X_{T_x} \), that yields a duration namely the amount of time elapsed between the current instant \( t_{sys}\) and the later instant, specifically, the tick taken at the arming instant with <a class="el" href="group__qstimers.html#ga3eb4d7620b2b14a28ea7bbe39935976a" title="Set the expiration time for a STimer. On success, the STimer gets armed immediately.">qSTimer_Set()</a>, \( X_{t_i}\) Thanks to modular arithmetic, both of these are guaranteed to work fine across the clock-source rollover (a 32bit unsigned-counter), at least, as long the delays involved are shorter than <code>49.7</code> days.</p>
<p ><b> Features </b></p>
<ul>
<li>Provides a non-blocking equivalent to delay function.</li>
<li>Each STimer encapsulates its own expiration (timeout) time.</li>
<li>Provides elapsed and remaining time APIs.</li>
<li>As mentioned before, STimers uses the same kernel clock source, this means the time-elapsed calculation use the <a class="el" href="group__qclock.html#ga79880b62c3e70848faa0ecb315482147" title="Return the current tick used by the OS.">qClock_GetTick()</a> API, therefore, the time resolution has the same value passed when the scheduler has been initialized with <a class="el" href="group__qtaskcreation.html#gac97ca3bd669135e0adcf07fcc2852313" title="Task Scheduler Setup. This function is required and must be called once in the application main threa...">qOS_Setup()</a></li>
</ul>
<h2><a class="anchor" id="q_stimerusage"></a>
Using a STimer</h2>
<p >A STimer is referenced by a handle, a variable of type <a class="el" href="structq_s_timer__t.html" title="A STimer(Software Timer) object.">qSTimer_t</a> and preferably, should be initialized by the <code>QSTIMER_INITIALIZER</code> constant before any usage.</p>
<p >To use them, the code should follow a specific pattern that deals with the states of this object. All related APIs are designed to be non-blocking, this means there are ideal for use in cooperative environments as the one provided by the OS itself. To minimize the implementation, this object is intentionally created to behave like a binary object, this implies that it only handles two states, <em>Armed</em> and <em>Disarmed</em>. An <em>Armed</em> timer means that it is already running with a specified preset value and a <em>Disarmed</em> timer is the opposite, which means that it does not have a preset value, so consequently, it is not running at all.</p>
<p >The arming action can be performed with <a class="el" href="group__qstimers.html#ga3eb4d7620b2b14a28ea7bbe39935976a" title="Set the expiration time for a STimer. On success, the STimer gets armed immediately.">qSTimer_Set()</a> or <a class="el" href="group__qstimers.html#ga7b25e8ad7bb0b4e87bc07262a6f402d0" title="Non-Blocking STimer check with automatic arming.">qSTimer_FreeRun()</a> and disarming with <a class="el" href="group__qstimers.html#ga56ac8d637d8078647931f1846201a570" title="Disarms the STimer object.">qSTimer_Disarm()</a>. For <a class="el" href="group__qstimers.html#ga7b25e8ad7bb0b4e87bc07262a6f402d0" title="Non-Blocking STimer check with automatic arming.">qSTimer_FreeRun()</a>, it checks the timer and performs the arming. If disarmed, it gets armed immediately with the specified time. If armed, the time argument is ignored and the API only checks for expiration. When the time expires,the STimer gets armed immediately taking the specified time.</p>
<p >All possible checking actions are also provided for this object, including <a class="el" href="group__qstimers.html#ga1c707ea49120d558336f5be41f4c08e5" title="Retrieve the elapsed time in epochs.">qSTimer_Elapsed()</a>, <a class="el" href="group__qstimers.html#ga90373b67fa8c27df60e5bdb1183f3076" title="Retrieve the remaining time in epochs.">qSTimer_Remaining()</a> and <a class="el" href="group__qstimers.html#ga0d76c7505a0aa2f10af0f867843afa5a" title="Non-Blocking STimer check.">qSTimer_Expired()</a> , with the last one being the most commonly used for timing applications. Finally, to get the current status of the STimer (check if is <em>Armed</em> or <em>Disarmed</em>) the <a class="el" href="group__qstimers.html#ga633dce3b82f46a68a86a3aff37cb22cf" title="Get the current status of the STimer (Armed or Disarmed)">qSTimer_Status()</a> API should be used.</p>
<h2><a class="anchor" id="q_stimerexample"></a>
STimer example</h2>
<p >The example below shows a simple usage of this object. It is noteworthy that arming is performed once using the <a class="el" href="structq_event__t.html#ab6b771f59e71f08d49c14466b88edb04" title="This field indicates that a task is running for the first time. Can be used for data initialization p...">qEvent_t::FirstCall</a> flag. This prevents the timer from being re-armed every time the task runs. After the timer expires, it should be disarmed explicitly</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Example_Task( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e ) {</div>
<div class="line">    <span class="keyword">static</span> <a class="code hl_struct" href="structq_s_timer__t.html">qSTimer_t</a> timeout = <a class="code hl_define" href="group__qstimers.html#ga7cf1635dc6c882c4db956c25d53f7874">QSTIMER_INITIALIZER</a>;</div>
<div class="line">    <span class="keywordflow">if</span> ( e-&gt;<a class="code hl_variable" href="structq_event__t.html#ab6b771f59e71f08d49c14466b88edb04">FirstCall</a> ) {</div>
<div class="line">        <span class="comment">/*Arming the stimer for  3.5 seg*/</span></div>
<div class="line">        <a class="code hl_function" href="group__qstimers.html#ga3eb4d7620b2b14a28ea7bbe39935976a">qSTimer_Set</a>( &amp;timeout, 3.5f );</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/*non-blocking delay, true when timeout expires*/</span></div>
<div class="line">    <span class="keywordflow">if</span> ( <a class="code hl_function" href="group__qstimers.html#ga0d76c7505a0aa2f10af0f867843afa5a">qSTimer_Expired</a>( &amp;timeout ) ) {</div>
<div class="line">        <span class="comment">/* TODO: Code when STimer expires */</span></div>
<div class="line">        <a class="code hl_function" href="group__qstimers.html#ga56ac8d637d8078647931f1846201a570">qSTimer_Disarm</a>( &amp;timeout );</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">return</span>; <span class="comment">/*Yield*/</span></div>
<div class="line">}</div>
<div class="ttc" id="agroup__qstimers_html_ga0d76c7505a0aa2f10af0f867843afa5a"><div class="ttname"><a href="group__qstimers.html#ga0d76c7505a0aa2f10af0f867843afa5a">qSTimer_Expired</a></div><div class="ttdeci">qBool_t qSTimer_Expired(const qSTimer_t *const t)</div><div class="ttdoc">Non-Blocking STimer check.</div><div class="ttdef"><b>Definition:</b> qstimers.c:55</div></div>
<div class="ttc" id="agroup__qstimers_html_ga3eb4d7620b2b14a28ea7bbe39935976a"><div class="ttname"><a href="group__qstimers.html#ga3eb4d7620b2b14a28ea7bbe39935976a">qSTimer_Set</a></div><div class="ttdeci">qBool_t qSTimer_Set(qSTimer_t *const t, const qTime_t tTime)</div><div class="ttdoc">Set the expiration time for a STimer. On success, the STimer gets armed immediately.</div><div class="ttdef"><b>Definition:</b> qstimers.c:22</div></div>
<div class="ttc" id="agroup__qstimers_html_ga56ac8d637d8078647931f1846201a570"><div class="ttname"><a href="group__qstimers.html#ga56ac8d637d8078647931f1846201a570">qSTimer_Disarm</a></div><div class="ttdeci">qBool_t qSTimer_Disarm(qSTimer_t *const t)</div><div class="ttdoc">Disarms the STimer object.</div><div class="ttdef"><b>Definition:</b> qstimers.c:94</div></div>
<div class="ttc" id="agroup__qstimers_html_ga7cf1635dc6c882c4db956c25d53f7874"><div class="ttname"><a href="group__qstimers.html#ga7cf1635dc6c882c4db956c25d53f7874">QSTIMER_INITIALIZER</a></div><div class="ttdeci">#define QSTIMER_INITIALIZER</div><div class="ttdoc">Macro that can be used to initialize a disarmed STimer instance.</div><div class="ttdef"><b>Definition:</b> qstimers.h:44</div></div>
<div class="ttc" id="astructq_event__t_html"><div class="ttname"><a href="structq_event__t.html">qEvent_t</a></div><div class="ttdoc">The task argument with all the regarding information of the task execution.</div><div class="ttdef"><b>Definition:</b> qtasks.h:162</div></div>
<div class="ttc" id="astructq_event__t_html_ab6b771f59e71f08d49c14466b88edb04"><div class="ttname"><a href="structq_event__t.html#ab6b771f59e71f08d49c14466b88edb04">qEvent_t::FirstCall</a></div><div class="ttdeci">qBool_t FirstCall</div><div class="ttdoc">This field indicates that a task is running for the first time. Can be used for data initialization p...</div><div class="ttdef"><b>Definition:</b> qtasks.h:185</div></div>
<div class="ttc" id="astructq_s_timer__t_html"><div class="ttname"><a href="structq_s_timer__t.html">qSTimer_t</a></div><div class="ttdoc">A STimer(Software Timer) object.</div><div class="ttdef"><b>Definition:</b> qstimers.h:33</div></div>
</div><!-- fragment --><h1><a class="anchor" id="q_fsm"></a>
Finite State Machines (FSM)</h1>
<p >The state machine is one of the fundamental programming patterns that are most commonly used. This approach breaks down the design into a series of finite steps called "states" that perform some narrowly defined actions. Every state can change to another as a consequence of incoming stimuli also called events or signals. This elemental mechanism allows designers to solve complex engineering problems in a very straightforward way. Knowing the importance of this approach in the development of embedded applications, the OS adopts this design pattern as a kernel extension.</p>
<p >In an effort to maximize efficiency and minimize complexity, the extension implements the basic features of the Harel statecharts to represent hierarchical state machines. This features form a proper subset that approaches in a very minimalist way, some of the specifications of the UML statecharts, including:</p>
<ul>
<li>Nested states with proper handling of group transitions and group reactions.</li>
<li>Guaranteed execution of entry/exit actions upon entering/exiting states.</li>
<li>Straightforward transitions and guards.</li>
</ul>
<p >In addition to this, the provided implementation also features a powerful coding abstraction including transition tables and timeout signals, allowing to build scalable solutions from simple flat state-machines to complex statecharts.</p>
<h2><a class="anchor" id="qfsm_approach"></a>
The provided approach</h2>
<p >In QuarkTS, a state-machine must be instantiated with an object of type <a class="el" href="structq_s_m__t.html" title="A FSM(Finite State Machine) object.">qSM_t</a>. States are represented as instances of the <a class="el" href="structq_s_m___state__t.html" title="A state object.">qSM_State_t</a> object.</p>
<center>  
<!DOCTYPE html>
<html>
<head>
<title>fsmdesign</title>
<meta charset="utf-8"/>
</head>
<body><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-10-18T18:10:14.990Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\&quot; etag=\&quot;Pus0kYQw-gJYphxEF1EV\&quot; version=\&quot;20.2.2\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;64UyDokTRLeBllNpieF3\&quot; name=\&quot;Página-1\&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
</body>
</html>
 <em>FSM module design</em> </center><p >One important attribute of the <a class="el" href="structq_s_m___state__t.html" title="A state object.">qSM_State_t</a> object is the callback function, which is used to describe the behavior specific to the state. Also there is a pointer to the parent state to define nesting of the state and its place in the hierarchical topology. As shown in figure above, a state machine consist of a least one state, the "top level" state. So concrete state machine are built by adding an arbitrary number states and defining callback functions. The only purpose of the top state is to provide the root of the hierarchy, so that the highest level can return to top as their parent state.</p>
<h2><a class="anchor" id="q_fsmsetup"></a>
Setting up a state machine</h2>
<p >Like any other OS object, a Finite State Machine (FSM) must be explicitly initialized before it can be used. The <a class="el" href="group__qfsm.html#gabf14a12eeeb56b06ffca7341c302293c" title="Initializes a Finite State Machine (FSM).">qStateMachine_Setup()</a> API initializes the instance, sets the callback for the top state, sets the initial state and the surrounding callback function.</p>
<h2><a class="anchor" id="q_fsm_subscribe_states"></a>
Subscribing states and defining callbacks</h2>
<p >State machines are constructed by composition, therefore, the topology of a state machine is determined upon construction. In this FSM implementation, there are not distinction between composite states(states containing substates) and leaf states. All states are potentially composite. The API <a class="el" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3" title="This function subscribes the FSM instance to a specific state with an associated callback function.">qStateMachine_StateSubscribe()</a> should be used to initialize the state and define its position in the topology.</p>
<p >A state callback-functions takes a <a class="el" href="structq_s_m___handler__t.html" title="The callback argument to handle the state-machine dynamics and provide execution information....">qSM_Handler_t</a> object as input argument and returns a <a class="el" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> value. An example is shown in the following code snippet:</p>
<div class="fragment"><div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> ExampleState_Callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="comment">/* TODO: State code */</span></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a>;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qfsm_html_gae3b8425bb28440f3b2d9decfb65ec5bb"><div class="ttname"><a href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a></div><div class="ttdeci">qSM_Status_t</div><div class="ttdoc">This enumeration defines the built-in state-execution status values that can be used as return value ...</div><div class="ttdef"><b>Definition:</b> qfsm.h:175</div></div>
<div class="ttc" id="agroup__qfsm_html_ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9"><div class="ttname"><a href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a></div><div class="ttdeci">@ qSM_STATUS_EXIT_SUCCESS</div><div class="ttdef"><b>Definition:</b> qfsm.h:179</div></div>
<div class="ttc" id="astructq_s_m___handler__t_html"><div class="ttname"><a href="structq_s_m___handler__t.html">qSM_Handler_t</a></div><div class="ttdoc">The callback argument to handle the state-machine dynamics and provide execution information....</div><div class="ttdef"><b>Definition:</b> qfsm.h:233</div></div>
</div><!-- fragment --><h2><a class="anchor" id="q_fsmhandler"></a>
The state callback handler: performing transitions and retreiving data</h2>
<p >Because callback functions are methods derived from the state-machine object, they have direct access to some attributes via the <a class="el" href="structq_s_m___handler__t.html" title="The callback argument to handle the state-machine dynamics and provide execution information....">qSM_Handler_t</a> argument. The usage of this object it's required to make the FSM moves between states and additionally get extra data. The provided attributes are:</p>
<ul>
<li><a class="el" href="structq_s_m___handler__t.html#a4c1b6f2888b8fd07e4bb8ec65d85b86a">qSM_Handler_t::NextState</a> : Desired next state. The application writer should change this field to another state to produce a state transition in the next FSM's cycle. Changing this field will only take effect when the state is executed under user custom-defined signals or in the absence of signals <a class="el" href="group__qfsm.html#ga411e8ec0a25cfb3c039c1eeb26984280" title="Built-in signal to indicate that there is not signal available.">QSM_SIGNAL_NONE</a>.</li>
<li><a class="el" href="structq_s_m___handler__t.html#a10e59c21e0e6763803fcb9f4414858ef">qSM_Handler_t::StartState</a> : Desired nested initial state (substate). The application writer should change this field to set the initial transition if the current state its a parent(or composite state). Changing this field attribute only take effect when the state is executed under the <a class="el" href="group__qfsm.html#ga8ddab447f500ece9fc2c0264b9af7368" title="Built-in signal that can be used to set a nested initial-transition (aka default transition) by writi...">QSM_SIGNAL_START</a> signal.</li>
<li><a class="el" href="structq_s_m___handler__t.html#a185fb13f4184b5f4cc05b01059e31964">qSM_Handler_t::Signal</a> (read-only) : Received signal. Can have any of the following values:<ul>
<li><a class="el" href="group__qfsm.html#ga411e8ec0a25cfb3c039c1eeb26984280" title="Built-in signal to indicate that there is not signal available.">QSM_SIGNAL_NONE</a> if no signal available.</li>
<li><a class="el" href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062" title="Built-in signal to indicate if the current state has just entered from another state.">QSM_SIGNAL_ENTRY</a> if the current state has just entered from another state.</li>
<li><a class="el" href="group__qfsm.html#ga8ddab447f500ece9fc2c0264b9af7368" title="Built-in signal that can be used to set a nested initial-transition (aka default transition) by writi...">QSM_SIGNAL_START</a> to set nested initial transitions by using the <a class="el" href="structq_s_m___handler__t.html#a10e59c21e0e6763803fcb9f4414858ef">qSM_Handler_t::StartState</a> attribute.</li>
<li><a class="el" href="group__qfsm.html#ga79160319d03d53c51e372bf6c8319e33" title="Built-in signal to indicate if the current state has just exit to another state.">QSM_SIGNAL_EXIT</a> if the current state has just exit to another state.</li>
<li>Any other user-defined signal will reside here, including the <a class="el" href="group__qfsm.html#ga53dd98439f50052d457f50f0fccccec4" title="Built-in signal to indicate that a timeout expiration event occurs.">QSM_SIGNAL_TIMEOUT</a> signals.</li>
</ul>
</li>
<li><a class="el" href="structq_s_m___handler__t.html#a57bd1782dce058f1af8d9ac429ae8e7c">qSM_Handler_t::SignalData</a> (read-only) : Pointer to the data associated with the signal. For internal signals, including timeout signals, its value will be <code>NULL</code>.</li>
<li><a class="el" href="structq_s_m___handler__t.html#acde5467a47c845d8f84629204ffb0a9d">qSM_Handler_t::TransitionHistory</a> : Use this option if the transition is to a composite state. This attribute defines how the story should be handled. If this field is not established, <a class="el" href="group__qfsm.html#ggaa410ec930ead4964eaf0d75fc24d230bab923ff14a3651b5af267827a6ad08dd7">qSM_TRANSITION_NO_HISTORY</a> is assumed. The possible values for this attribute are:<ul>
<li><a class="el" href="group__qfsm.html#ggaa410ec930ead4964eaf0d75fc24d230bab923ff14a3651b5af267827a6ad08dd7">qSM_TRANSITION_NO_HISTORY</a> : History is not preserved. Composite states will start according to their default transition.</li>
<li><a class="el" href="group__qfsm.html#ggaa410ec930ead4964eaf0d75fc24d230ba713b2659619305f641ed9531081573e9">qSM_TRANSITION_SHALLOW_HISTORY</a> : History will be kept to allow the return to only the top-most sub-state of the most recent state configuration, which is entered using the default entry rule.</li>
<li><a class="el" href="group__qfsm.html#ggaa410ec930ead4964eaf0d75fc24d230ba4dfa279e192e2c5df451d33f87389253">qSM_TRANSITION_DEEP_HISTORY</a> : History will be kept to allow full state configuration of the most recent visit to the containing region.</li>
</ul>
</li>
<li><a class="el" href="structq_s_m___handler__t.html#a9a9b417b18be359dcef7d0c979db078a">qSM_Handler_t::Status</a> (read-only) : The exit(or return) status of the last state. Should be used in the Surrounding callback to perform the corresponding actions for every value. On states callback will take the value <a class="el" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bba699222ad9e29dfcdf790f23aa184ab68">qSM_STATUS_NULL</a></li>
<li><a class="el" href="structq_s_m___handler__t.html#ad5adc63e3c09cd2b4239310d6668e31c">qSM_Handler_t::machine</a> (read-only) : A generic pointer to the container state machine.</li>
<li><a class="el" href="structq_s_m___handler__t.html#afd75d67662a1d310a64c44f30a50f088">qSM_Handler_t::Data</a> (read-only) : State-machine associated data. If the FSM is running as a task, the associated event data can be queried through this field. (here, a cast to <a class="el" href="structq_event__t.html" title="The task argument with all the regarding information of the task execution.">qEvent_t</a> is mandatory).</li>
<li><a class="el" href="structq_s_m___handler__t.html#a1e16ba53a2dd6f04b0ce0d8ecf128542">qSM_Handler_t::StateData</a> (read-only) : State associated data. Storage-pointer.</li>
</ul>
<p >Within the callback function of every state, only one level of dispatching (based on the signal) is necessary. Typically this is archived using a single-level switch statement. Callback functions communicate with the state machine engine through the <a class="el" href="structq_s_m___handler__t.html" title="The callback argument to handle the state-machine dynamics and provide execution information....">qSM_Handler_t</a> and the return value of type <a class="el" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a>.</p>
<p >The semantic is simple, if a signal is processed, the callback functions returns the status value <a class="el" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbafd557f39ede0a55582ca9103a169e39e">qSM_STATUS_SIGNAL_HANDLED</a>. otherwise it throws the signal for further processing by higher-level states. Also, this returning mechanism can be used to handle exceptions by using the surrounding callback.</p>
<p ><em>Entry/Exit</em> actions and default transitions are also implemented inside the callback function in response of pre-defined signals. <a class="el" href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062" title="Built-in signal to indicate if the current state has just entered from another state.">QSM_SIGNAL_ENTRY</a>, <a class="el" href="group__qfsm.html#ga79160319d03d53c51e372bf6c8319e33" title="Built-in signal to indicate if the current state has just exit to another state.">QSM_SIGNAL_EXIT</a> and <a class="el" href="group__qfsm.html#ga8ddab447f500ece9fc2c0264b9af7368" title="Built-in signal that can be used to set a nested initial-transition (aka default transition) by writi...">QSM_SIGNAL_START</a>. The state machine generates and dispatches this signals to appropriates handlers upon state transitions.</p>
<p >The example below shows what a status callback should look like including the use of the handler.</p>
<div class="fragment"><div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> ExampleState_Callback ( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="keywordflow">switch</span>( h ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga8ddab447f500ece9fc2c0264b9af7368">QSM_SIGNAL_START</a>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062">QSM_SIGNAL_ENTRY</a>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga79160319d03d53c51e372bf6c8319e33">QSM_SIGNAL_EXIT</a>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> USER_DEFINED_SIGNAL :</div>
<div class="line">            h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a4c1b6f2888b8fd07e4bb8ec65d85b86a">NextState</a> = &amp;OtherState; <span class="comment">/*transition*/</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a>;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qfsm_html_ga66ead48ca76fb2f583f2c7aef8371062"><div class="ttname"><a href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062">QSM_SIGNAL_ENTRY</a></div><div class="ttdeci">#define QSM_SIGNAL_ENTRY</div><div class="ttdoc">Built-in signal to indicate if the current state has just entered from another state.</div><div class="ttdef"><b>Definition:</b> qfsm.h:82</div></div>
<div class="ttc" id="agroup__qfsm_html_ga79160319d03d53c51e372bf6c8319e33"><div class="ttname"><a href="group__qfsm.html#ga79160319d03d53c51e372bf6c8319e33">QSM_SIGNAL_EXIT</a></div><div class="ttdeci">#define QSM_SIGNAL_EXIT</div><div class="ttdoc">Built-in signal to indicate if the current state has just exit to another state.</div><div class="ttdef"><b>Definition:</b> qfsm.h:76</div></div>
<div class="ttc" id="agroup__qfsm_html_ga8ddab447f500ece9fc2c0264b9af7368"><div class="ttname"><a href="group__qfsm.html#ga8ddab447f500ece9fc2c0264b9af7368">QSM_SIGNAL_START</a></div><div class="ttdeci">#define QSM_SIGNAL_START</div><div class="ttdoc">Built-in signal that can be used to set a nested initial-transition (aka default transition) by writi...</div><div class="ttdef"><b>Definition:</b> qfsm.h:70</div></div>
<div class="ttc" id="astructq_s_m___handler__t_html_a4c1b6f2888b8fd07e4bb8ec65d85b86a"><div class="ttname"><a href="structq_s_m___handler__t.html#a4c1b6f2888b8fd07e4bb8ec65d85b86a">qSM_Handler_t::NextState</a></div><div class="ttdeci">void * NextState</div><div class="ttdef"><b>Definition:</b> qfsm.h:235</div></div>
</div><!-- fragment --><p >As shown above, the return value represents the exit status of the state, and it can be handled with an additional surrounding callback function \( S_u \) established at the moment of the FSM setup. The values allowed to return are listed below.</p>
<ul>
<li><a class="el" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a></li>
<li><a class="el" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbad2d1f8cd380738706b06dc39aa44788e">qSM_STATUS_EXIT_FAILURE</a></li>
<li><a class="el" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbafd557f39ede0a55582ca9103a169e39e">qSM_STATUS_SIGNAL_HANDLED</a></li>
<li>Any other integer value between <code>-32762</code> and <code>32767</code> </li>
</ul>
<p >To code initial transitions, application writer should catch the <a class="el" href="group__qfsm.html#ga8ddab447f500ece9fc2c0264b9af7368" title="Built-in signal that can be used to set a nested initial-transition (aka default transition) by writi...">QSM_SIGNAL_START</a>, perform the required actions and then designate the target sub-state by assigning the <code>StartState</code> attribute of the <a class="el" href="structq_s_m___handler__t.html" title="The callback argument to handle the state-machine dynamics and provide execution information....">qSM_Handler_t</a> argument. Regular transitions are coded in a very similar way, except that here, you catch the custom-defined signal and then assign the <code>NextState</code> attribute of the <a class="el" href="structq_s_m___handler__t.html" title="The callback argument to handle the state-machine dynamics and provide execution information....">qSM_Handler_t</a> argument. The developer is free to write and control state transitions. Transitions are only allowed under the availability of user custom-defined signals. Regular transitions are not allowed at an entry point (<a class="el" href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062" title="Built-in signal to indicate if the current state has just entered from another state.">QSM_SIGNAL_ENTRY</a>), exit point (<a class="el" href="group__qfsm.html#ga79160319d03d53c51e372bf6c8319e33" title="Built-in signal to indicate if the current state has just exit to another state.">QSM_SIGNAL_EXIT</a>), or a start point (<a class="el" href="group__qfsm.html#ga8ddab447f500ece9fc2c0264b9af7368" title="Built-in signal that can be used to set a nested initial-transition (aka default transition) by writi...">QSM_SIGNAL_START</a>).</p>
<dl class="section note"><dt>Note</dt><dd>User should not target the top state in a transition and use it as transition source either. The only customizable aspect of the top state is the initial transition.</dd></dl>
<h2><a class="anchor" id="q_fsm_surrounding"></a>
The surrounding callback</h2>
<p >It is a checkpoint before and after each state executes its activities through its state callback. The behavior of this surrounding callback must be defined by the programmer.</p>
<center>  
<!DOCTYPE html>
<html>
<head>
<title>surrounding</title>
<meta charset="utf-8"/>
</head>
<body><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-10-19T05:34:37.293Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\&quot; etag=\&quot;poDBqKg0qx6tawrUZqnR\&quot; version=\&quot;20.2.2\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;4V9vBTZxQXj7jBstcZzX\&quot; name=\&quot;Página-1\&quot;&gt;7Zpdb6M4FIZ/TS7HMgaDuWzSdEejdlRttZqdq5ULboLGwZEx+dhfvzYxgWDSyc6kKbuTpFLx8fd5H7CPycifLDa/SbqcP4iU8RGC6Wbk344Q8iCO9D9j2VpLDHeGmcxSa2oMT9nfrK5prWWWsuKgoBKCq2x5aExEnrNEHdiolGJ9WOxF8MNel3TGHMNTQrlr/ZKlam6tXhg3GR9ZNpvbrgmyE17QurCdSTGnqVi3TP505E+kEGp3tdhMGDfOq/2yq3d3JHc/MMlydUqFh+jz/GG6Wtze/5X+8eUTI58W+INtZUV5aSdsB6u2tQekKPOUmUbgyB+v55liT0uamNy11lzb5mrBdcrTl4WS4hubCC5kVduPq4/Oeck4r+25yJkxiVzd0UXGDRsfGV8xlSV030rtb+2pcUqLeTUG04kdM5OKbY46w9u7WLPJxIIpudVFbIUwhICQXa2aTIz8nWHdCK15BZ71ybwlc00xtXjN9j00CugLK8K/EAQ5gjw6iuhmNP7s+2pw+sz4mCbfZpWIXfdrRZ5sq4XgZliHktyXSZZS3fdE5LpALZm9ST1s0y21CTTfPg4gjO7u7nq1bZOhS04mU1yVrPqy4/POoHmEESCoo7nvA0Qc2QMMfM9VPfABjN5IeN8R/mmEQq6My8pnfTkzl2Vt0320zP8LRDo5ryAyDc33DRAhKNwrPDxEgisi749IGBG9csD9xxsqLbhvJXFoGaGxdwWmtSFpWDn/riOGROvdsDPYxSg8iZ0PV3IuRU4IIYDwP0BO5JAzKWU1yy4U2hnKcXxL6Y6J8myW62Si22LaPjb+1OECv7EZiyxNK8kLjVeWz+7Zi5lv0Fh+ty4wJqGrv/AqHpvriky3MF6KLFeVQ/BY/+kt/gQCPMJ6tBOd9pq0/jPFpTKgKUmzSkVGC7VmhZmVFIoq+lzNtYKoDv68Vxg8Gg8dhmAukGfZHMMOUgQ6PGFvHzS1eUIQIPxGPBGHpzF7EZLd5NsrUYMmKozM1L7LVBhcnKm4b3WDkqlS5iNziqKXP98zjtkVuXI2ZM6IFwEUnABaDLzIBc1/q5Oc+gSzhdlnA86VpkHTRHyAg+PhXQ9YcQzCCz/BPPfc9lGyVSbK4srXoPnCelV0DiEHApV79uxGcnl6Y96qGEA4LYosOQzg+jzYewpc62SKJaVc7YMl1+vas3L7py1bJb6aBMB18nbTzrzd2tRu8Cx1XvB0tEJQUTlj6hXXBP2atrfG0BWrtknGqcpWh8Pok8/28Gjuj9ZGKghA90wSBwCTw4YKUcqE2brt90Dd5kLS11zsxftPp+Wde5yWK8j23vgJ7tyj70Fwdyo/78UFjsIeKqJGRvyDgMBuKGjwQJdlwj3rHgQTA3gWofdkLkI+6K5e56EuwhHwm2bCbuioeyEeviyE7hH6LwHhu8EVE4De5plGUARI0wzqYfjidLmH7L8EXSc84vB7UkjMDj0+HgGeB0jdAcCwAXIAPLpH9wAAB8lrOHm2cLL1bgqd6T0RDrrr5pE3Qz33DwpBhI7fLUdiS51sfsO2Y7H5JaA//Qc=&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
</body>
</html>
 <em>Surrounding callback invocation after and before the current state</em> </center><p >The surrounding callback \( S_u \) invocation occurs after and before the current state \( P \). When the surrounding callback is executed, indicates its own checkpoint through the <code>Status</code> attribute of the <a class="el" href="structq_s_m___handler__t.html" title="The callback argument to handle the state-machine dynamics and provide execution information....">qSM_Handler_t</a> argument. Unlike a state callback, the surrounding callback should not return anything, thus, the callback should be written as:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SurroundingCallback_Example( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> m ) {</div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a9a9b417b18be359dcef7d0c979db078a">Status</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bba8a53c46b5ae14d7e952b5619c94364cc">qSM_STATUS_BEFORE_ANY</a>:</div>
<div class="line">            <span class="comment">/* TODO: before any code */</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbad2d1f8cd380738706b06dc39aa44788e">qSM_STATUS_EXIT_FAILURE</a>:</div>
<div class="line">            <span class="comment">/* TODO: failure code */</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a>:</div>
<div class="line">            <span class="comment">/* TODO: success code */</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbafd557f39ede0a55582ca9103a169e39e">qSM_STATUS_SIGNAL_HANDLED</a>:</div>
<div class="line">            <span class="comment">/* TODO: signal handled code */</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 5: <span class="comment">/*user defined return value*/</span></div>
<div class="line">            <span class="comment">/* TODO: used defined*/</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="comment">/*handle the unexpected*/</span></div>
<div class="line">            <span class="keywordflow">break</span></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qfsm_html_ggae3b8425bb28440f3b2d9decfb65ec5bba8a53c46b5ae14d7e952b5619c94364cc"><div class="ttname"><a href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bba8a53c46b5ae14d7e952b5619c94364cc">qSM_STATUS_BEFORE_ANY</a></div><div class="ttdeci">@ qSM_STATUS_BEFORE_ANY</div><div class="ttdef"><b>Definition:</b> qfsm.h:176</div></div>
<div class="ttc" id="agroup__qfsm_html_ggae3b8425bb28440f3b2d9decfb65ec5bbad2d1f8cd380738706b06dc39aa44788e"><div class="ttname"><a href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbad2d1f8cd380738706b06dc39aa44788e">qSM_STATUS_EXIT_FAILURE</a></div><div class="ttdeci">@ qSM_STATUS_EXIT_FAILURE</div><div class="ttdef"><b>Definition:</b> qfsm.h:178</div></div>
<div class="ttc" id="agroup__qfsm_html_ggae3b8425bb28440f3b2d9decfb65ec5bbafd557f39ede0a55582ca9103a169e39e"><div class="ttname"><a href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbafd557f39ede0a55582ca9103a169e39e">qSM_STATUS_SIGNAL_HANDLED</a></div><div class="ttdeci">@ qSM_STATUS_SIGNAL_HANDLED</div><div class="ttdef"><b>Definition:</b> qfsm.h:180</div></div>
<div class="ttc" id="astructq_s_m___handler__t_html_a9a9b417b18be359dcef7d0c979db078a"><div class="ttname"><a href="structq_s_m___handler__t.html#a9a9b417b18be359dcef7d0c979db078a">qSM_Handler_t::Status</a></div><div class="ttdeci">const qSM_Status_t Status</div><div class="ttdef"><b>Definition:</b> qfsm.h:242</div></div>
</div><!-- fragment --><p >As you can see in the example below, the surrounding execution case its verified through the FSM handle by reading the <code>Status</code> field.</p>
<h2><a class="anchor" id="q_fsm_astask"></a>
Adding a state machine as a task</h2>
<p >The best strategy to run a FSM is delegating it to a task. For this, the <a class="el" href="group__qtaskcreation.html#gaeea76a6e287011694689c658f7e204ca" title="Add a task to the scheduling scheme running a dedicated state-machine. The task is scheduled to run e...">qOS_Add_StateMachineTask()</a> API should be used. Here, the task does not have a specific callback, instead, it will evaluate the active state of the FSM, and later, all the other possible states in response to events that mark their own transition. The task will be scheduled to run every <code>t</code> seconds in <a class="el" href="group__qtaskcreation.html#gae3758e719245db560b090d90fce96301" title="A directive indicating that the task will run every time its timeout has expired.">qPeriodic</a> mode.</p>
<p >By using this API, the kernel will take care of the FSM by itself, so the usage of <a class="el" href="group__qfsm.html#ga0b56645c3980372fc55ed5e3f5c8c31e" title="Execute the Finite State Machine (FSM).">qStateMachine_Run()</a> can be omitted.</p>
<p >Now that a task is running a dedicated state-machine, the specific task event-information can be obtained in every state callback through the <code>Data</code> field of the <a class="el" href="structq_s_m___handler__t.html" title="The callback argument to handle the state-machine dynamics and provide execution information....">qSM_Handler_t</a> argument.</p>
<p >Check the example below:</p>
<div class="fragment"><div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> Example_State( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e = h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#afd75d67662a1d310a64c44f30a50f088">Data</a>; </div>
<div class="line">    <span class="comment">/* Get the event info of the task that owns this state-machine*/</span></div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a185fb13f4184b5f4cc05b01059e31964">Signal</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062">QSM_SIGNAL_ENTRY</a>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga79160319d03d53c51e372bf6c8319e33">QSM_SIGNAL_EXIT</a>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">switch</span> ( e-&gt;<a class="code hl_variable" href="structq_event__t.html#a61ae4900215e528bd801c8ee156ac0df">Trigger</a> ) {</div>
<div class="line">                <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qtaskmanip.html#ggaf68e9306308b42db48932211e1c40334af1705218462d9dc718e24c89fd141e18">byTimeElapsed</a>:</div>
<div class="line">                    <span class="comment">/* TODO: Code for this case */</span></div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qtaskmanip.html#ggaf68e9306308b42db48932211e1c40334a9ab4cc29730ffdb14a249913dfbd609e">byNotificationSimple</a>:</div>
<div class="line">                    <span class="comment">/* TODO: Code for this case */</span></div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qtaskmanip.html#ggaf68e9306308b42db48932211e1c40334a890d2e612bdf3c6214a5668c71f09acb">byQueueCount</a>:</div>
<div class="line">                    <span class="comment">/* TODO: Code for this case */</span></div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">/* TODO: State code */</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a>;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qtaskmanip_html_ggaf68e9306308b42db48932211e1c40334a890d2e612bdf3c6214a5668c71f09acb"><div class="ttname"><a href="group__qtaskmanip.html#ggaf68e9306308b42db48932211e1c40334a890d2e612bdf3c6214a5668c71f09acb">byQueueCount</a></div><div class="ttdeci">@ byQueueCount</div><div class="ttdoc">When the element-count of the attached queue reaches the specified value. A pointer to the queue will...</div><div class="ttdef"><b>Definition:</b> qtasks.h:83</div></div>
<div class="ttc" id="agroup__qtaskmanip_html_ggaf68e9306308b42db48932211e1c40334a9ab4cc29730ffdb14a249913dfbd609e"><div class="ttname"><a href="group__qtaskmanip.html#ggaf68e9306308b42db48932211e1c40334a9ab4cc29730ffdb14a249913dfbd609e">byNotificationSimple</a></div><div class="ttdeci">@ byNotificationSimple</div><div class="ttdoc">When the execution chain does, according to a requirement of asynchronous notification event prompted...</div><div class="ttdef"><b>Definition:</b> qtasks.h:65</div></div>
<div class="ttc" id="agroup__qtaskmanip_html_ggaf68e9306308b42db48932211e1c40334af1705218462d9dc718e24c89fd141e18"><div class="ttname"><a href="group__qtaskmanip.html#ggaf68e9306308b42db48932211e1c40334af1705218462d9dc718e24c89fd141e18">byTimeElapsed</a></div><div class="ttdeci">@ byTimeElapsed</div><div class="ttdoc">When the time specified for the task elapsed.</div><div class="ttdef"><b>Definition:</b> qtasks.h:51</div></div>
<div class="ttc" id="astructq_event__t_html_a61ae4900215e528bd801c8ee156ac0df"><div class="ttname"><a href="structq_event__t.html#a61ae4900215e528bd801c8ee156ac0df">qEvent_t::Trigger</a></div><div class="ttdeci">qTrigger_t Trigger</div><div class="ttdoc">This member indicates the event source that triggers the task execution. Possible values are describe...</div><div class="ttdef"><b>Definition:</b> qtasks.h:180</div></div>
<div class="ttc" id="astructq_s_m___handler__t_html_a185fb13f4184b5f4cc05b01059e31964"><div class="ttname"><a href="structq_s_m___handler__t.html#a185fb13f4184b5f4cc05b01059e31964">qSM_Handler_t::Signal</a></div><div class="ttdeci">const qSM_SigId_t Signal</div><div class="ttdef"><b>Definition:</b> qfsm.h:241</div></div>
<div class="ttc" id="astructq_s_m___handler__t_html_afd75d67662a1d310a64c44f30a50f088"><div class="ttname"><a href="structq_s_m___handler__t.html#afd75d67662a1d310a64c44f30a50f088">qSM_Handler_t::Data</a></div><div class="ttdeci">const void * Data</div><div class="ttdef"><b>Definition:</b> qfsm.h:238</div></div>
</div><!-- fragment --><h2><a class="anchor" id="q_fsm_example1"></a>
A demonstrative example for a FSM</h2>
<p >In this example, one press of the button turn on the LED, a second push of the button will make the LED blink and if the button is pressed again, the LED will turn off. Also, our system must turn off the LED after a period of inactivity. If the button hasn't been pressed in the last 10 seconds, the LED will turn off.</p>
<center>  
<html>
<head>
<title>fsmled</title>
<meta charset="utf-8"/>
</head>
<body><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;zoom&quot;:1.2,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-10-19T16:44:19.377Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\&quot; etag=\&quot;2qA6oxdCwsuBkRDcJq6T\&quot; version=\&quot;20.2.2\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;rT_7VhNZph5krCK22-1H\&quot; name=\&quot;Página-1\&quot;&gt;7VrbUts6FP2azLQPeOSr5Edyg85wgDacOfSJMbGSaOpYqaJA0q+vZEuOLZtgKAk9TAgD1pa0tb0vS0t2Om5vvj5j0WL2D41x0nFAvO64/Y7j2J4fin9SssklfpC3p4zEasxWMCK/sBICJV2RGC8rAzmlCSeLqnBM0xSPeUUWMUYfq8MmNKmuuoimuCYYjaOkLv2PxHympHYQbjvOMZnO1NLIgXnHPNKD1Z0sZ1FMH0sid9Bxe4xSnl/N1z2cSN9pv+Tzhk/0FoYxnPI2E06cL+TXl68L1D2/+upfuPAyuD6xvVzNQ5Ss1B13nCARCrsTKvQ6wVRea9m9FlxNJlomVrw3xwlZdXrmAL7RXmV0lcZYGgZE9+OMcDxaRGPZ+yjSSMhmfJ6Ili0ul5zRH7hHE8qy2S4C8iNNJElSkg8C+VGmD6M5SWTOnePkAXMyjgpVOpCOGtqkWrkFM47XTzrcLsIo0h/TOeZsI4aoCVDn8EbXAkC54LGUSUANmpWSSKdMpJJ3WujexldcqBC/JNx+U7ijufR4er9cNIVa3K1cuSHY7mkxmJUyoKKuO7q+uxj0766Gw0+fD5QKKU2xmQUXqzGJI7F0j6ZLKhdvSIYoIdNUXCd4oitAIZINDp0rTstc8faWK8EroSE9IsMz0UbIiLbrO7VoO4dFBvhuyHCpgOG5CT9HN2SO2d0I808d6QjVnf/loo+uRGKJ+wc2sIDYoMARcV6Qg7BlDu4PcdDrEKebkPTHEXSeC7jjGVsMBPWAw4OCTnho0Hk1hjQortplrhTjSbSSQ5qtasrVynwykQZqe4cM42+rtMHme5n8YkxuNLD8yefMaDEQtgDVssKnRRqrb67Ozi4GLfG6A/tH7G1ZimHLUkT7KkVd45VSNII3XrGHLHZ2VofxqTxfi+Y4iZZLMq4Grxrp4vALWoSqbSRq+QEAHA6HjcHGa8Jv5fqWr1rflTXyur8uNza6IaHmttzI5liOr9vbeVlLT8w9h+PaowUjQYR36YqN8S6IVJnCIzbF/FkCV0+5Ukb5DQmlZQwnEScPVYObskytcE2J3FB1RofAYBMO9C2/qiW/VzWx/KDC0GUD11Bm+zVluT9qykRKRpvSsIUcsHzabuSZLCioPEURF7nKbWUVvv2DYrM/eLEVhWN5QVguHtsCgfdM9WSta8zEpsYxKxXmben6e6WWm+v3LcswbFuG/nuWITLL0PeNDaN9EdpIAl11m0LC5Wg/heiYlrtgp4EwMCc4h6hcp1a53X9vbq4u766/DUajQT/jXT35m7GogiKVSjv4uaKacJwss9ITHBGgxTonUapb0ypNAQfrBWE43kVbJe0zYESQFF7FCk17WJ59XclkxHEkOVXyOYnjDBkYFsZF95kmWU4qhEKt3+34falqxelSYUcNIjQva6ZqCnJQS4TaExELfN/MOtsKvBoXs4OGmnX3xsXcD749FFwsQF4Jz8XmAOBuRiYa5s7wligP/x8o77kWQgZvQd7rgB7ZgWW7Bs57zr5wPgyBuRbabZ9vTjgIQ6u/Fzvi8B4PxAAaQXbrB+JGEN7bsymn6VXZRwLhEkeHxYE2p9XAKUj7Szh6WyR+L9y0gS84LQxc24co9KBrwp4NLGhobc+XTQIrTj6WE+4FRG0QQAua5NxB2vr9QmPTe8FjYewqjKWIO9c+oMJxWjYkifbC3148AQytsPRj8o/wlQdNCHbq9QBs6n7jggrMl2EeOATJqL9zNQ+TRxbxki9RPPUwr1wi4duQCNHcfnUrT4jt99/cwW8=&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
</body>
</html>
 <em>Flat FSM example with three states</em> </center><p >To start the implementation, let's define the necessary global variables...</p>
<div class="fragment"><div class="line"><a class="code hl_struct" href="structq_task__t.html">qTask_t</a> LED_Task; <span class="comment">/*The task node*/</span></div>
<div class="line"><a class="code hl_struct" href="structq_s_m__t.html">qSM_t</a> LED_FSM; <span class="comment">/*The state -machine handle*/</span></div>
<div class="line"><a class="code hl_struct" href="structq_s_m___state__t.html">qSM_State_t</a> State_LEDOff, State_LEDOn, State_LEDBlink;</div>
<div class="ttc" id="astructq_s_m___state__t_html"><div class="ttname"><a href="structq_s_m___state__t.html">qSM_State_t</a></div><div class="ttdoc">A state object.</div><div class="ttdef"><b>Definition:</b> qfsm.h:347</div></div>
<div class="ttc" id="astructq_s_m__t_html"><div class="ttname"><a href="structq_s_m__t.html">qSM_t</a></div><div class="ttdoc">A FSM(Finite State Machine) object.</div><div class="ttdef"><b>Definition:</b> qfsm.h:388</div></div>
<div class="ttc" id="astructq_task__t_html"><div class="ttname"><a href="structq_task__t.html">qTask_t</a></div><div class="ttdoc">A task node object.</div><div class="ttdef"><b>Definition:</b> qtasks.h:268</div></div>
</div><!-- fragment --><p >Then, we define our states as the flow-diagram showed in the figure above.</p>
<div class="fragment"><div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> State_LEDOff_Callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a185fb13f4184b5f4cc05b01059e31964">Signal</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062">QSM_SIGNAL_ENTRY</a>:</div>
<div class="line">            BSP_LED_OFF();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga79160319d03d53c51e372bf6c8319e33">QSM_SIGNAL_EXIT</a>: <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga8ddab447f500ece9fc2c0264b9af7368">QSM_SIGNAL_START</a>: <span class="comment">/*Ignore*/</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">if</span> ( BUTTON_PRESSED ) {</div>
<div class="line">                h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a4c1b6f2888b8fd07e4bb8ec65d85b86a">NextState</a> = &amp;State_LEDOn;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> State_LEDOn_Callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="keyword">static</span> <a class="code hl_struct" href="structq_s_timer__t.html">qSTimer_t</a> timeout;</div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a185fb13f4184b5f4cc05b01059e31964">Signal</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062">QSM_SIGNAL_ENTRY</a>:</div>
<div class="line">            <a class="code hl_function" href="group__qstimers.html#ga3eb4d7620b2b14a28ea7bbe39935976a">qSTimer_Set</a>( &amp;timeout, 10.0f ); <span class="comment">/*STimer gets armed*/</span></div>
<div class="line">            BSP_LED_ON();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga79160319d03d53c51e372bf6c8319e33">QSM_SIGNAL_EXIT</a>: <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga8ddab447f500ece9fc2c0264b9af7368">QSM_SIGNAL_START</a>: <span class="comment">/*Ignore*/</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">if</span> ( <a class="code hl_function" href="group__qstimers.html#ga0d76c7505a0aa2f10af0f867843afa5a">qSTimer_Expired</a>( &amp;timeout) ) { <span class="comment">/*check if the timeout expired*/</span></div>
<div class="line">                h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a4c1b6f2888b8fd07e4bb8ec65d85b86a">NextState</a> = &amp;State_LEDOff;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> ( BUTTON_PRESSED  {</div>
<div class="line">                h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a4c1b6f2888b8fd07e4bb8ec65d85b86a">NextState</a> = &amp;State_LEDBlink;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> State_LEDBlink_Callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="keyword">static</span> <a class="code hl_struct" href="structq_s_timer__t.html">qSTimer_t</a> timeout; </div>
<div class="line">    <span class="keyword">static</span> <a class="code hl_struct" href="structq_s_timer__t.html">qSTimer_t</a> blinktime;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a185fb13f4184b5f4cc05b01059e31964">Signal</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062">QSM_SIGNAL_ENTRY</a>:</div>
<div class="line">            <a class="code hl_function" href="group__qstimers.html#ga3eb4d7620b2b14a28ea7bbe39935976a">qSTimer_Set</a>( &amp;timeout, 10.0f );</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga79160319d03d53c51e372bf6c8319e33">QSM_SIGNAL_EXIT</a>: <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga8ddab447f500ece9fc2c0264b9af7368">QSM_SIGNAL_START</a>: <span class="comment">/*Ignore*/</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">if</span> ( <a class="code hl_function" href="group__qstimers.html#ga0d76c7505a0aa2f10af0f867843afa5a">qSTimer_Expired</a>( &amp;timeout ) || BUTTON_PRESSED ) {</div>
<div class="line">                h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a4c1b6f2888b8fd07e4bb8ec65d85b86a">NextState</a> = &amp;State_LEDOff;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> ( <a class="code hl_function" href="group__qstimers.html#ga7b25e8ad7bb0b4e87bc07262a6f402d0">qSTimer_FreeRun</a>( &amp;blinktime, 0.5f ) ) {</div>
<div class="line">               BSP_LED_TOGGLE();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a>;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qstimers_html_ga7b25e8ad7bb0b4e87bc07262a6f402d0"><div class="ttname"><a href="group__qstimers.html#ga7b25e8ad7bb0b4e87bc07262a6f402d0">qSTimer_FreeRun</a></div><div class="ttdeci">qBool_t qSTimer_FreeRun(qSTimer_t *const t, const qTime_t tTime)</div><div class="ttdoc">Non-Blocking STimer check with automatic arming.</div><div class="ttdef"><b>Definition:</b> qstimers.c:36</div></div>
</div><!-- fragment --><p >Finally, we add the task to the scheduling scheme running the dedicated state machine. Remember that you must set up the scheduler before adding a task to the scheduling scheme.</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="group__qfsm.html#gabf14a12eeeb56b06ffca7341c302293c">qStateMachine_Setup</a>( &amp;LED_FSM , NULL , &amp;State_LEDOff , NULL , NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;LED_FSM , &amp;State_LEDOff , NULL ,</div>
<div class="line">                              State_LEDOff_Callback , NULL , NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;LED_FSM , &amp;State_LEDOn , NULL ,</div>
<div class="line">                              State_LEDOn_Callback , NULL , NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;LED_FSM , &amp;State_LEDBlink , NULL ,</div>
<div class="line">                              State_LEDBlink_Callback , NULL , NULL );</div>
<div class="line"><a class="code hl_function" href="group__qtaskcreation.html#gaeea76a6e287011694689c658f7e204ca">qOS_Add_StateMachineTask</a>( &amp;LED_Task , &amp;LED_FSM , <a class="code hl_define" href="group__qtaskcreation.html#ga32c8bd0870414e10a6e72b743627da5a">qHigh_Priority</a> , 0.1f, <a class="code hl_define" href="group__qtypes.html#ga1743f4a545347fa50ab81f1e4e21b095">qEnabled</a> , NULL );</div>
<div class="ttc" id="agroup__qfsm_html_ga723ec7aca70eb94880625d78bbe3cac3"><div class="ttname"><a href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a></div><div class="ttdeci">qBool_t qStateMachine_StateSubscribe(qSM_t *const m, qSM_State_t *const s, qSM_State_t *const parent, qSM_StateCallback_t sFcn, qSM_State_t *const init, void *pData)</div><div class="ttdoc">This function subscribes the FSM instance to a specific state with an associated callback function.</div><div class="ttdef"><b>Definition:</b> qfsm.c:560</div></div>
<div class="ttc" id="agroup__qfsm_html_gabf14a12eeeb56b06ffca7341c302293c"><div class="ttname"><a href="group__qfsm.html#gabf14a12eeeb56b06ffca7341c302293c">qStateMachine_Setup</a></div><div class="ttdeci">qBool_t qStateMachine_Setup(qSM_t *const m, qSM_StateCallback_t topFcn, qSM_State_t *const init, qSM_SurroundingCallback_t sFcn, void *pData)</div><div class="ttdoc">Initializes a Finite State Machine (FSM).</div><div class="ttdef"><b>Definition:</b> qfsm.c:521</div></div>
<div class="ttc" id="agroup__qtaskcreation_html_ga32c8bd0870414e10a6e72b743627da5a"><div class="ttname"><a href="group__qtaskcreation.html#ga32c8bd0870414e10a6e72b743627da5a">qHigh_Priority</a></div><div class="ttdeci">#define qHigh_Priority</div><div class="ttdoc">A macro directive to indicate the highest priority level.</div><div class="ttdef"><b>Definition:</b> qkernel.h:77</div></div>
<div class="ttc" id="agroup__qtaskcreation_html_gaeea76a6e287011694689c658f7e204ca"><div class="ttname"><a href="group__qtaskcreation.html#gaeea76a6e287011694689c658f7e204ca">qOS_Add_StateMachineTask</a></div><div class="ttdeci">qBool_t qOS_Add_StateMachineTask(qTask_t *const Task, qSM_t *m, const qPriority_t p, const qTime_t t, const qState_t init, void *arg)</div><div class="ttdoc">Add a task to the scheduling scheme running a dedicated state-machine. The task is scheduled to run e...</div><div class="ttdef"><b>Definition:</b> qkernel.c:482</div></div>
<div class="ttc" id="agroup__qtypes_html_ga1743f4a545347fa50ab81f1e4e21b095"><div class="ttname"><a href="group__qtypes.html#ga1743f4a545347fa50ab81f1e4e21b095">qEnabled</a></div><div class="ttdeci">#define qEnabled</div><div class="ttdoc">A state value that enables a task.</div><div class="ttdef"><b>Definition:</b> qtypes.h:167</div></div>
</div><!-- fragment --><h2><a class="anchor" id="q_fsmsendsignals"></a>
Sending signals</h2>
<p >To communicate within and between state-machines or even other contexts, use signals. A signal is a simple value who can be used to abstract an incoming event. In the receiving state-machine, a queue or a exclusion variable receives the signal and holds it until the state-machine can evaluate it.</p>
<p >When coding state-machines, the application writer can benefit from this simple event-abstraction mechanism. On the one hand, there would be a more uniform programming when writing states callbacks and on the other hand, the communication of the state machine from other contexts becomes easier.</p>
<p >To send a signal to a state machine, use the <a class="el" href="group__qfsm.html#gaba0e1b16789eb0c7c0a45e924c272e7e" title="Sends a signal to a specific state machine or to all its subscribers (if available).">qStateMachine_SendSignal()</a> API. This API can manage their delivery to one of these possible destinations: an <em>exclusion variable</em> or a <em>signal queue</em>:</p><ul>
<li>An <em>exclusion variable</em> its a variable with an important distinction, it can only be written if it is empty. The empty situation only happens, if the engine has already propagated the signal within the state machine. If the signal has not yet propagated, the signal sending cannot be carried out.</li>
<li>When a <em>signal queue</em> is used, the signal is put into a FIFO structure and the engine takes care of dispatching the signal in an orderly manner. The only situation where the signal cannot be delivered is if the queue is full. This its the preferred destination, as long as there is a previously installed signal queue.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>If the signal-queue its available, the <a class="el" href="group__qfsm.html#gaba0e1b16789eb0c7c0a45e924c272e7e" title="Sends a signal to a specific state machine or to all its subscribers (if available).">qStateMachine_SendSignal()</a> will always select it as destination. </dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>If a state-machine, a task, or another context sends a signal to a full queue, a queue-overflow occurs. The result of the queue overflow it that the state-machine drops the new signal.</dd></dl>
<h2><a class="anchor" id="q_fsminstallsignalqueue"></a>
Installing a signal queue</h2>
<p >A state machine can have a FIFO queue to allow the delivery of signals from another contexts. If the signal queue its installed, the state-machine engine constantly monitors the queue for available signals. The engine then propagates the signal through the hierarchy until it is processed. To enable this functionality in your state machine, the queue must be installed by using the <a class="el" href="group__qfsm.html#ga238feabe2db7825556f716c6a403a556" title="Install a signal queue to the provided Finite State Machine (FSM).">qStateMachine_InstallSignalQueue()</a> API.</p>
<p >The install operation should be performed after both, the queue and the FSM are correctly initialized by using <a class="el" href="group__qqueues.html#gac7b44df16c76bdf45d82f3b7621eec63" title="Configures a Queue. Here, the RAM used to hold the queue data pData is statically allocated at compil...">qQueue_Setup()</a> and <a class="el" href="group__qfsm.html#gabf14a12eeeb56b06ffca7341c302293c" title="Initializes a Finite State Machine (FSM).">qStateMachine_Setup()</a> respectively.</p>
<dl class="section note"><dt>Note</dt><dd>Make sure that queues are enabled in the <code>qconfig.h</code> header file </dd></dl>
<dl class="section attention"><dt>Attention</dt><dd>When configuring a signal queue with <a class="el" href="group__qqueues.html#gac7b44df16c76bdf45d82f3b7621eec63" title="Configures a Queue. Here, the RAM used to hold the queue data pData is statically allocated at compil...">qQueue_Setup()</a>, remember to size it based on the type <a class="el" href="structq_s_m___signal__t.html">qSM_Signal_t</a>. </dd></dl>
<dl class="section note"><dt>Note</dt><dd>If the state-machines its delegated to a task, make sure to install the queue prior to setting up the task. In this way, a kernel connection can be performed between the FSM signal-queue and the FSM-task, allowing the OS to catch signals to produce a task event, this prevents the wait of the task for the specified period, resulting in a faster handling of incoming signals.</dd></dl>
<h2><a class="anchor" id="q_fsm_ttable"></a>
Using a transition table</h2>
<p >In this approach, the FSM is coded in tables with the outgoing transitions of every state, where each entry relates signals, actions and the target state. This is an elegant method to translate the FSM to actual implementation as the handling for every state and event combination is encapsulated in the table.</p>
<p >Here, the application writer get a quick picture of the FSM and the embedded software maintenance is also much more under control. A transition table should be explicitly installed in the target state with the corresponding entries, an n-sized array of <a class="el" href="structq_s_m___transition__t.html" title="This structure should be used to define an item for a state transition table.">qSM_Transition_t</a> elements following the layout described below:</p>
<p >The API <a class="el" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727" title="Installs a table with the outgoing transitions for the supplied state.">qStateMachine_Set_StateTransitions()</a>, should be used to perform the transition table installation to a specific state.</p>
<center> <a class="anchor" id="multi_row"></a>
<table class="doxtable">
<caption>Transition table layout for a state</caption>
<tr>
<th>Signal Id </th><th>Signal action/guard </th><th>Target state </th><th>History mode </th><th>Signal data </th></tr>
<tr>
<td><code>Signal1</code> </td><td><code>NULL</code> </td><td><code>StateB</code> </td><td><code>0</code> </td><td><code>NULL</code> </td></tr>
<tr>
<td><code>Signal3</code> </td><td><code>DoOnSignal3</code> </td><td><code>StateD</code> </td><td><code>0</code> </td><td><code>&amp;sig3data</code> </td></tr>
<tr>
<td>... </td><td>... </td><td>... </td><td>... </td><td>... </td></tr>
<tr>
<td><code>Signal6</code> </td><td><code>NULL</code> </td><td><code>StateA</code> </td><td><code>0</code> </td><td><code>NULL</code> </td></tr>
</table>
</center><p ><b> Caveats: </b></p>
<ul>
<li>State transitions are not limited to the specification of the transition table. A state callback owns the higher precedence to change a state. The application writer can use both, a transition table and direct <code>NextState</code> field manipulation in state callbacks to perform a transition to the FSM.</li>
<li>Special care is required when the table grows very large, that is, when there are many invalid state/event combinations, leading to a waste of memory. There is also a memory penalty as the number of states and events grow. The application writer need to accurately account for this during initial design. A statechart pattern can be used to improve the design and reduce the number of transition entries.</li>
<li>The user is responsible for defining the transitions according to the topology of the state machine. Undefined behaviors can occur if the topology is broken with poorly defined transitions.</li>
</ul>
<h2><a class="anchor" id="q_fsm_sigactions"></a>
Signal actions and guards</h2>
<p >Transition tables allow the usage of this feature. When an event-signal is received from the queue, the signal-action, if available, is evaluated before the transition is triggered. This action is user-defined and should be coded as a function that takes a <a class="el" href="structq_s_m___handler__t.html" title="The callback argument to handle the state-machine dynamics and provide execution information....">qSM_Handler_t</a> object and returns a value of type <a class="el" href="group__qtypes.html#ga131b2258b5135d0b1e3ded5ecbe309d7">qBool_t</a>.</p>
<div class="fragment"><div class="line"><a class="code hl_typedef" href="group__qtypes.html#ga131b2258b5135d0b1e3ded5ecbe309d7">qBool_t</a> Signal_Action( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="comment">/* TODO : Event -signal action*/</span></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_define" href="group__qtypes.html#ga9cd31c446d7a5ead8f65aa28e4d1f2cd">qTrue</a>; <span class="comment">/*allow the state transition*/</span></div>
<div class="line">}</div>
<div class="ttc" id="agroup__qtypes_html_ga131b2258b5135d0b1e3ded5ecbe309d7"><div class="ttname"><a href="group__qtypes.html#ga131b2258b5135d0b1e3ded5ecbe309d7">qBool_t</a></div><div class="ttdeci">qUINT8_t qBool_t</div><div class="ttdoc">A type to instantiate an OS boolean variable.</div><div class="ttdef"><b>Definition:</b> qtypes.h:139</div></div>
<div class="ttc" id="agroup__qtypes_html_ga9cd31c446d7a5ead8f65aa28e4d1f2cd"><div class="ttname"><a href="group__qtypes.html#ga9cd31c446d7a5ead8f65aa28e4d1f2cd">qTrue</a></div><div class="ttdeci">#define qTrue</div><div class="ttdoc">A boolean value that represents true/success/On or High.</div><div class="ttdef"><b>Definition:</b> qtypes.h:162</div></div>
</div><!-- fragment --><p >The return value is checked after to allow or reject the state transition. The application writer can code a boolean expression to implement <em>statechart guards</em> or perform some pre-transition procedure.</p>
<dl class="section remark"><dt>Remarks</dt><dd>If a signal-action returns <a class="el" href="group__qtypes.html#gabcfc51cee68e399f81b5c109c8e615c7">qFalse</a>, the event-signal is rejected, preventing the state transition to be performed in the calling FSM. </dd></dl>
<dl class="section note"><dt>Note</dt><dd>When a transition entry is defined. the signal-action should be located as the third parameter of the entry. Please see the transition layout. A <code>NULL</code> value will act as a NOT-defined, always allowing the state-transition.</dd></dl>
<h2><a class="anchor" id="q_fsm_timeout"></a>
FSM Timeout specification</h2>
<p >A timeout specification is mechanism to simplify the notion of time passage inside states. The basic usage model of the timeout signals is as follows:</p>
<p >A timeout specification allocates one or more timer objects. The user relates in a table each specific timeout operations within the state where are they going to operate. So, according to the table, when a state needs to arrange for a timeout, the engine can set or reset the given timer. When the FSM engine detects that the appropriate moment has arrived (a timer expiration occurs), it inserts the timeout signal directly into the recipient's event queue. The recipient then processes the timeout signal just like any other signal.</p>
<p >Given the above explanation, it is evident that for its operation, the state machine requires an installed signal queue. A timeout specification is referenced by an object of type <a class="el" href="structq_s_m___timeout_spec__t.html" title="A FSM Timeout-specification object.">qSM_TimeoutSpec_t</a> and must be installed inside the state machine using the API <a class="el" href="group__qfsm.html#ga81a3c55cd5811420bdbb4383eabd542a" title="Install the Timeout-specification object to target FSM to allow timed signals within states ( See the...">qStateMachine_InstallTimeoutSpec()</a>. Then, timeout operations can be defined in a table for each state by using the <a class="el" href="group__qfsm.html#gacb92e74ae8f68e2535a81860600f876f" title="Setup fixed timeouts for the specified state using a lookup-table.">qStateMachine_Set_StateTimeouts()</a>.</p>
<p >A timeout specification element is defined as an structure of type <a class="el" href="structq_s_m___timeout_state_definition__t.html" title="This structure should be used to define an item for a timeout-specification table.">qSM_TimeoutStateDefinition_t</a> and should follow this layout:</p>
<center> <a class="anchor" id="multi_row"></a>
<table class="doxtable">
<caption>Timeout specification layout</caption>
<tr>
<th>Timeout value </th><th>Options </th></tr>
</table>
</center><p >The options for every timeout its a bitwise value that indicates which timeout should be used and the operations than should be performed internally by the state-machine engine. This options can be combined with a bitwise OR and are detailed as follows:</p>
<ul>
<li><a class="el" href="group__qfsm.html#gab629172b64616333ffd6c69206a52538" title="Timeout-specification option. Should be used to specify the timeout index.">QSM_TSOPT_INDEX(index)</a> : To select the timeout to be used in the specification. Should be a value between <code>0</code> and <code>Q_FSM_MAX_TIMEOUTS-1</code> </li>
<li><a class="el" href="group__qfsm.html#gae435e391de4b3994106042603697b663" title="This timeout-specification option its used to specify that the engine should set the timeout when the...">QSM_TSOPT_SET_ENTRY</a> : To set the timeout when the specified state its entering.</li>
<li><a class="el" href="group__qfsm.html#ga05e46fa20d248f3437f4148d34e72bbe" title="This timeout-specification option its used to specify that the engine should reset the timeout when t...">QSM_TSOPT_RST_ENTRY</a> : To reset the timeout when the specified state its entering.</li>
<li><a class="el" href="group__qfsm.html#ga25157125e94e3a2e37ca5d8565814520" title="This timeout-specification option its used to specify that the engine should set the timeout when the...">QSM_TSOPT_SET_EXIT</a> : To set the timeout when the specified state its exiting.</li>
<li><a class="el" href="group__qfsm.html#ga92cba13d703eed68d7534c1ab188c8cd" title="This timeout-specification option its used to specify that the engine should reset the timeout when t...">QSM_TSOPT_RST_EXIT</a> : To reset the timeout when the specified state its exiting.</li>
<li><a class="el" href="group__qfsm.html#gaee44e3c75626ba161a51a82a86f934bd" title="This timeout-specification option its used to specify that the engine should set the timeout only if ...">QSM_TSOPT_KEEP_IF_SET</a> : To apply the Set operation only if the timeout its in a reset state.</li>
<li><a class="el" href="group__qfsm.html#gac93b670decc866ef1148f59648f1efd2" title="This timeout-specification option its used setup the timeout in periodic mode.">QSM_TSOPT_PERIODIC</a> : To put the timeout in periodic mode.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Data associated to timeout signals should be set to <code>NULL</code>. Any other value will be ignored and will be passed as <code>NULL</code> to the FSM handler. </dd></dl>
<dl class="section attention"><dt>Attention</dt><dd>The user is responsible for writing timeout specifications correctly. Care must be taken that the specifications do not collide between hierarchical states to avoid overwriting operations. </dd></dl>
<dl class="section note"><dt>Note</dt><dd>You can increase the number of available timeouts instances by changing the <code>Q_FSM_MAX_TIMEOUTS</code> configuration macro inside <code>qconfig.h</code>.</dd></dl>
<h2><a class="anchor" id="q_fsm_example2"></a>
Demonstrative example using transition tables</h2>
<p >The following example shows the implementation of the led-button FSM presented above by using the transition table approach with signal-queue and a timeout specification.</p>
<p >Before getting started, the required variables should be defined:</p>
<div class="fragment"><div class="line"><span class="comment">/*define the FSM application event-signals*/</span></div>
<div class="line"><span class="preprocessor">#define SIGNAL_BUTTON_PRESSED   ( (qSM_SigId_t)1 )</span></div>
<div class="line"><span class="preprocessor">#define SIGNAL_TIMEOUT          ( QSM_SIGNAL_TIMEOUT(0) )</span></div>
<div class="line"><span class="preprocessor">#define SIGNAL_BLINK            ( QSM_SIGNAL_TIMEOUT(1) )</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_task__t.html">qTask_t</a> LED_Task; <span class="comment">/*The task node*/</span></div>
<div class="line"><a class="code hl_struct" href="structq_s_m__t.html">qSM_t</a> LED_FSM; <span class="comment">/*The state-machine handler*/</span></div>
<div class="line"><a class="code hl_struct" href="structq_s_m___state__t.html">qSM_State_t</a> State_LEDOff, State_LEDOn, State_LEDBlink;</div>
<div class="line"><a class="code hl_struct" href="structq_queue__t.html">qQueue_t</a> LEDsigqueue; <span class="comment">/*the signal-queue*/</span> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___signal__t.html">qSM_Signal_t</a> led_sig_stack[ 5 ];  <span class="comment">/*the signal-queue storage area*/</span></div>
<div class="line"><a class="code hl_struct" href="structq_s_m___timeout_spec__t.html">qSM_TimeoutSpec_t</a> tm_spectimeout;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*create the transition tables for every state*/</span></div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> LEDOff_transitions[] = {</div>
<div class="line">    { SIGNAL_BUTTON_PRESSED, NULL, &amp;State_LEDOn    , 0, NULL}</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> LEDOn_transitions[] = {</div>
<div class="line">    { SIGNAL_TIMEOUT,        NULL, &amp;State_LEDOff   , 0, NULL},</div>
<div class="line">    { SIGNAL_BUTTON_PRESSED, NULL, &amp;State_LEDBlink , 0, NULL}</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> LEDBlink_transitions[] = {</div>
<div class="line">    { SIGNAL_TIMEOUT,        NULL, &amp;State_LEDOff   , 0, NULL},</div>
<div class="line">    { SIGNAL_BUTTON_PRESSED, NULL, &amp;State_LEDOff   , 0, NULL}</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*define the timeout specifications */</span></div>
<div class="line"><a class="code hl_struct" href="structq_s_m___timeout_state_definition__t.html">qSM_TimeoutStateDefinition_t</a> LedOn_Timeouts[] = {</div>
<div class="line">    { 10.0f,  <a class="code hl_define" href="group__qfsm.html#gab629172b64616333ffd6c69206a52538">QSM_TSOPT_INDEX</a>(0) | <a class="code hl_define" href="group__qfsm.html#gae435e391de4b3994106042603697b663">QSM_TSOPT_SET_ENTRY</a> | <a class="code hl_define" href="group__qfsm.html#ga92cba13d703eed68d7534c1ab188c8cd">QSM_TSOPT_RST_EXIT</a>  },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___timeout_state_definition__t.html">qSM_TimeoutStateDefinition_t</a> LEDBlink_timeouts[] = {</div>
<div class="line">    { 10.0f,  <a class="code hl_define" href="group__qfsm.html#gab629172b64616333ffd6c69206a52538">QSM_TSOPT_INDEX</a>(0) | <a class="code hl_define" href="group__qfsm.html#gae435e391de4b3994106042603697b663">QSM_TSOPT_SET_ENTRY</a> | <a class="code hl_define" href="group__qfsm.html#ga92cba13d703eed68d7534c1ab188c8cd">QSM_TSOPT_RST_EXIT</a>  },</div>
<div class="line">    { 0.5f,   <a class="code hl_define" href="group__qfsm.html#gab629172b64616333ffd6c69206a52538">QSM_TSOPT_INDEX</a>(1) | <a class="code hl_define" href="group__qfsm.html#gae435e391de4b3994106042603697b663">QSM_TSOPT_SET_ENTRY</a> | <a class="code hl_define" href="group__qfsm.html#ga92cba13d703eed68d7534c1ab188c8cd">QSM_TSOPT_RST_EXIT</a> | <a class="code hl_define" href="group__qfsm.html#gac93b670decc866ef1148f59648f1efd2">QSM_TSOPT_PERIODIC</a>  }</div>
<div class="line">};</div>
<div class="ttc" id="agroup__qfsm_html_ga92cba13d703eed68d7534c1ab188c8cd"><div class="ttname"><a href="group__qfsm.html#ga92cba13d703eed68d7534c1ab188c8cd">QSM_TSOPT_RST_EXIT</a></div><div class="ttdeci">#define QSM_TSOPT_RST_EXIT</div><div class="ttdoc">This timeout-specification option its used to specify that the engine should reset the timeout when t...</div><div class="ttdef"><b>Definition:</b> qfsm.h:126</div></div>
<div class="ttc" id="agroup__qfsm_html_gab629172b64616333ffd6c69206a52538"><div class="ttname"><a href="group__qfsm.html#gab629172b64616333ffd6c69206a52538">QSM_TSOPT_INDEX</a></div><div class="ttdeci">#define QSM_TSOPT_INDEX(index)</div><div class="ttdoc">Timeout-specification option. Should be used to specify the timeout index.</div><div class="ttdef"><b>Definition:</b> qfsm.h:100</div></div>
<div class="ttc" id="agroup__qfsm_html_gac93b670decc866ef1148f59648f1efd2"><div class="ttname"><a href="group__qfsm.html#gac93b670decc866ef1148f59648f1efd2">QSM_TSOPT_PERIODIC</a></div><div class="ttdeci">#define QSM_TSOPT_PERIODIC</div><div class="ttdoc">This timeout-specification option its used setup the timeout in periodic mode.</div><div class="ttdef"><b>Definition:</b> qfsm.h:138</div></div>
<div class="ttc" id="agroup__qfsm_html_gae435e391de4b3994106042603697b663"><div class="ttname"><a href="group__qfsm.html#gae435e391de4b3994106042603697b663">QSM_TSOPT_SET_ENTRY</a></div><div class="ttdeci">#define QSM_TSOPT_SET_ENTRY</div><div class="ttdoc">This timeout-specification option its used to specify that the engine should set the timeout when the...</div><div class="ttdef"><b>Definition:</b> qfsm.h:108</div></div>
<div class="ttc" id="astructq_queue__t_html"><div class="ttname"><a href="structq_queue__t.html">qQueue_t</a></div><div class="ttdoc">A Queue object.</div><div class="ttdef"><b>Definition:</b> qqueues.h:53</div></div>
<div class="ttc" id="astructq_s_m___signal__t_html"><div class="ttname"><a href="structq_s_m___signal__t.html">qSM_Signal_t</a></div><div class="ttdoc">The type to be used as a container variable for a signal.</div><div class="ttdef"><b>Definition:</b> qfsm.h:166</div></div>
<div class="ttc" id="astructq_s_m___timeout_spec__t_html"><div class="ttname"><a href="structq_s_m___timeout_spec__t.html">qSM_TimeoutSpec_t</a></div><div class="ttdoc">A FSM Timeout-specification object.</div><div class="ttdef"><b>Definition:</b> qfsm.h:369</div></div>
<div class="ttc" id="astructq_s_m___timeout_state_definition__t_html"><div class="ttname"><a href="structq_s_m___timeout_state_definition__t.html">qSM_TimeoutStateDefinition_t</a></div><div class="ttdoc">This structure should be used to define an item for a timeout-specification table.</div><div class="ttdef"><b>Definition:</b> qfsm.h:320</div></div>
<div class="ttc" id="astructq_s_m___transition__t_html"><div class="ttname"><a href="structq_s_m___transition__t.html">qSM_Transition_t</a></div><div class="ttdoc">This structure should be used to define an item for a state transition table.</div><div class="ttdef"><b>Definition:</b> qfsm.h:414</div></div>
</div><!-- fragment --><p >Then, we define the callback for the states.</p>
<div class="fragment"><div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> State_LEDOff_Callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a185fb13f4184b5f4cc05b01059e31964">Signal</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062">QSM_SIGNAL_ENTRY</a>:</div>
<div class="line">            BSP_LED_OFF();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> State_LEDOn_Callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a185fb13f4184b5f4cc05b01059e31964">Signal</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062">QSM_SIGNAL_ENTRY</a>:</div>
<div class="line">            BSP_LED_ON();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> State_LEDBlink_Callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a185fb13f4184b5f4cc05b01059e31964">Signal</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> SIGNAL_BLINK:</div>
<div class="line">            BSP_LED_TOGGLE();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p >In the previous code snippet, we assumed that <code>SIGNAL_BUTTON_PRESSED</code> can be delivered from either the interrupt context or another task.</p>
<p >To finish the setup, a task is added to handle the FSM and then, the transition table can be installed with the other required objects.</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="group__qfsm.html#gabf14a12eeeb56b06ffca7341c302293c">qStateMachine_Setup</a>( &amp;LED_FSM, NULL, &amp;State_LEDOff, NULL, NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;LED_FSM, &amp;State_LEDOff, <a class="code hl_define" href="group__qfsm.html#ga07476c08b51bd61cdb87e161ae717d6c">QSM_STATE_TOP</a>, State_LEDOff_Callback, NULL, NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;LED_FSM, &amp;State_LEDOn, <a class="code hl_define" href="group__qfsm.html#ga07476c08b51bd61cdb87e161ae717d6c">QSM_STATE_TOP</a>, State_LEDOn_Callback, NULL, NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;LED_FSM, &amp;State_LEDBlink, <a class="code hl_define" href="group__qfsm.html#ga07476c08b51bd61cdb87e161ae717d6c">QSM_STATE_TOP</a>, State_LEDBlink_Callback, NULL, NULL );</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__qqueues.html#gac7b44df16c76bdf45d82f3b7621eec63">qQueue_Setup</a>( &amp;LEDsigqueue, led_sig_stack, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="structq_s_m___signal__t.html">qSM_Signal_t</a>), <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(led_sig_stack) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga238feabe2db7825556f716c6a403a556">qStateMachine_InstallSignalQueue</a>( &amp;LED_FSM, &amp;LEDsigqueue );</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga81a3c55cd5811420bdbb4383eabd542a">qStateMachine_InstallTimeoutSpec</a>( &amp;LED_FSM, &amp;tm_spectimeout );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#gacb92e74ae8f68e2535a81860600f876f">qStateMachine_Set_StateTimeouts</a>( &amp;State_LEDOn, LedOn_Timeouts, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(LedOn_Timeouts) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#gacb92e74ae8f68e2535a81860600f876f">qStateMachine_Set_StateTimeouts</a>( &amp;State_LEDBlink, LEDBlink_timeouts, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(LEDBlink_timeouts) );</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;State_LEDOff, LEDOff_transitions, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(LEDOff_transitions) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;State_LEDOn, LEDOn_transitions, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(LEDOn_transitions) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;State_LEDBlink, LEDBlink_transitions, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(LEDBlink_transitions) );</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__qtaskcreation.html#gaeea76a6e287011694689c658f7e204ca">qOS_Add_StateMachineTask</a>( &amp;LED_Task, &amp;LED_FSM, <a class="code hl_define" href="group__qtaskcreation.html#ga13bec7f4284d45c97f512c83ed9b7744">qMedium_Priority</a>, 0.1f, <a class="code hl_define" href="group__qtypes.html#ga1743f4a545347fa50ab81f1e4e21b095">qEnabled</a>, NULL );</div>
<div class="ttc" id="agroup__qflm_html_gacb974430bc61fdee7a601e8ea98b0f18"><div class="ttname"><a href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a></div><div class="ttdeci">#define qFLM_ArraySize(x)</div><div class="ttdoc">Returns the number of elements in an array x.</div><div class="ttdef"><b>Definition:</b> qflm.h:234</div></div>
<div class="ttc" id="agroup__qfsm_html_ga07476c08b51bd61cdb87e161ae717d6c"><div class="ttname"><a href="group__qfsm.html#ga07476c08b51bd61cdb87e161ae717d6c">QSM_STATE_TOP</a></div><div class="ttdeci">#define QSM_STATE_TOP</div><div class="ttdoc">This macro can be used to reference the top state when using the qStateMachine_StateSubscribe() API.</div><div class="ttdef"><b>Definition:</b> qfsm.h:57</div></div>
<div class="ttc" id="agroup__qfsm_html_ga238feabe2db7825556f716c6a403a556"><div class="ttname"><a href="group__qfsm.html#ga238feabe2db7825556f716c6a403a556">qStateMachine_InstallSignalQueue</a></div><div class="ttdeci">qBool_t qStateMachine_InstallSignalQueue(qSM_t *const m, qQueue_t *q)</div><div class="ttdoc">Install a signal queue to the provided Finite State Machine (FSM).</div><div class="ttdef"><b>Definition:</b> qfsm.c:601</div></div>
<div class="ttc" id="agroup__qfsm_html_ga243c71753d0b5d1a402c9bda5c7bc727"><div class="ttname"><a href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a></div><div class="ttdeci">qBool_t qStateMachine_Set_StateTransitions(qSM_State_t *const s, qSM_Transition_t *const table, const size_t n)</div><div class="ttdoc">Installs a table with the outgoing transitions for the supplied state.</div><div class="ttdef"><b>Definition:</b> qfsm.c:586</div></div>
<div class="ttc" id="agroup__qfsm_html_ga81a3c55cd5811420bdbb4383eabd542a"><div class="ttname"><a href="group__qfsm.html#ga81a3c55cd5811420bdbb4383eabd542a">qStateMachine_InstallTimeoutSpec</a></div><div class="ttdeci">qBool_t qStateMachine_InstallTimeoutSpec(qSM_t *const m, qSM_TimeoutSpec_t *const ts)</div><div class="ttdoc">Install the Timeout-specification object to target FSM to allow timed signals within states ( See the...</div><div class="ttdef"><b>Definition:</b> qfsm.c:789</div></div>
<div class="ttc" id="agroup__qfsm_html_gacb92e74ae8f68e2535a81860600f876f"><div class="ttname"><a href="group__qfsm.html#gacb92e74ae8f68e2535a81860600f876f">qStateMachine_Set_StateTimeouts</a></div><div class="ttdeci">qBool_t qStateMachine_Set_StateTimeouts(qSM_State_t *const s, qSM_TimeoutStateDefinition_t *tdef, const size_t n)</div><div class="ttdoc">Setup fixed timeouts for the specified state using a lookup-table.</div><div class="ttdef"><b>Definition:</b> qfsm.c:808</div></div>
<div class="ttc" id="agroup__qqueues_html_gac7b44df16c76bdf45d82f3b7621eec63"><div class="ttname"><a href="group__qqueues.html#gac7b44df16c76bdf45d82f3b7621eec63">qQueue_Setup</a></div><div class="ttdeci">qBool_t qQueue_Setup(qQueue_t *const q, void *pData, const size_t itemSize, const size_t itemsCount)</div><div class="ttdoc">Configures a Queue. Here, the RAM used to hold the queue data pData is statically allocated at compil...</div><div class="ttdef"><b>Definition:</b> qqueues.c:32</div></div>
<div class="ttc" id="agroup__qtaskcreation_html_ga13bec7f4284d45c97f512c83ed9b7744"><div class="ttname"><a href="group__qtaskcreation.html#ga13bec7f4284d45c97f512c83ed9b7744">qMedium_Priority</a></div><div class="ttdeci">#define qMedium_Priority</div><div class="ttdoc">A macro directive to indicate the medium priority level.</div><div class="ttdef"><b>Definition:</b> qkernel.h:74</div></div>
</div><!-- fragment --><h2><a class="anchor" id="qfsm_happroach"></a>
Using the hierarchical approach</h2>
<p >In conventional state machine designs, all states are considered at the same level. The design does not capture the commonality that exists among states. In real life, many states handle most transitions in similar fashion and differ only in a few key components. Even when the actual handling differs, there is still some commonality. It is in these situations where the hierarchical designs makes the most sense.</p>
<p >A hierarchical state-machine is characterized by having compound states. A composite state is defined as state that has inner states and can be used as a decomposition mechanism that allows factoring of common behaviors and their reuse. And this is the biggest advantage of this design, because it captures the commonality by organizing the states as a hierarchy. The states at the higher level in hierarchy perform the common handling, while the lower level states inherit the commonality from higher level ones and perform the state specific functions.</p>
<h3><a class="anchor" id="q_fsm_example3"></a>
Example usign a hierarchical FSM</h3>
<p >This example takes the "Cruise Control" study case, a real-time system that manages the speed of an automobile based on inputs from the driver.</p>
<center>  
<!DOCTYPE html>
<html>
<head>
<title>hsm</title>
<meta charset="utf-8"/>
</head>
<body><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;zoom&quot;:1.2,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-10-19T16:51:35.501Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\&quot; etag=\&quot;QdIZd3r2DwtN3vC1hyVB\&quot; version=\&quot;20.2.2\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;Ucjj-E1xw4AO6E8yxrXi\&quot; name=\&quot;Página-1\&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
</body>
</html>
 <em>Cruise control FSM example</em> </center><p >The behavior of this system is state-dependent in that the executed actions correspond not only to the driver input, but also on the current state of the system and with the status of the engine and the brake. The figure above illustrate the modeling of this system with the "Automated Control" state acting as composite.</p>
<p >Before getting started, the required user-defined signals, variables, and entries of the transition table should be defined:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define  SIGNAL_ENGINE_ON           ( (qSM_SigId_t)(1) )</span></div>
<div class="line"><span class="preprocessor">#define  SIGNAL_ACCEL               ( (qSM_SigId_t)(2) )</span></div>
<div class="line"><span class="preprocessor">#define  SIGNAL_RESUME              ( (qSM_SigId_t)(3) )</span></div>
<div class="line"><span class="preprocessor">#define  SIGNAL_OFF                 ( (qSM_SigId_t)(4) )</span></div>
<div class="line"><span class="preprocessor">#define  SIGNAL_BRAKE_PRESSED       ( (qSM_SigId_t)(5) )</span></div>
<div class="line"><span class="preprocessor">#define  SIGNAL_CRUISE              ( (qSM_SigId_t)(6) )</span></div>
<div class="line"><span class="preprocessor">#define  SIGNAL_REACHED_CRUISING    ( (qSM_SigId_t)(7) )</span></div>
<div class="line"><span class="preprocessor">#define  SIGNAL_ENGINE_OFF          ( (qSM_SigId_t)(8) )</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_task__t.html">qTask_t</a> CruiseControlTask;</div>
<div class="line"><a class="code hl_struct" href="structq_s_m__t.html">qSM_t</a> Top_SM;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*highest level states*/</span></div>
<div class="line"><a class="code hl_struct" href="structq_s_m___state__t.html">qSM_State_t</a> state_idle, state_initial, state_cruisingoff, state_automatedcontrol;</div>
<div class="line"><span class="comment">/*states inside the state_automatedcontrol*/</span></div>
<div class="line"><a class="code hl_struct" href="structq_s_m___state__t.html">qSM_State_t</a> state_accelerating, state_cruising, state_resuming;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_queue__t.html">qQueue_t</a> top_sigqueue;</div>
<div class="line"><a class="code hl_struct" href="structq_s_m___signal__t.html">qSM_Signal_t</a> topsm_sig_stack[ 10 ];</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*=======================================================================*/</span></div>
<div class="line"><span class="comment">/*                             TRANSITION TABLES                         */</span></div>
<div class="line"><span class="comment">/*=======================================================================*/</span></div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> idle_transitions[] =</div>
<div class="line">{</div>
<div class="line">{ SIGNAL_ENGINE_ON, SigAct_ClearDesiredSpeed, &amp;state_initial      , 0, NULL }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> initial_transitions[] =</div>
<div class="line">{</div>
<div class="line">{ SIGNAL_ACCEL,     SigAct_BrakeOff,          &amp;state_accelerating , 0, NULL }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> accel_transitions[] =</div>
<div class="line">{</div>
<div class="line">{ SIGNAL_CRUISE,     NULL,                    &amp;state_cruising     , 0, NULL }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> cruising_transitions[] =</div>
<div class="line">{</div>
<div class="line">{ SIGNAL_OFF,       NULL,                     &amp;state_cruisingoff  , 0, NULL },</div>
<div class="line">{ SIGNAL_ACCEL,     NULL,                     &amp;state_accelerating , 0, NULL }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> resuming_transitions[] =</div>
<div class="line">{</div>
<div class="line">{ SIGNAL_ACCEL,      NULL,                    &amp;state_accelerating , 0, NULL }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> cruisingoff_transitions[] =</div>
<div class="line">{</div>
<div class="line">{ SIGNAL_ACCEL,      SigAct_BrakeOff,         &amp;state_accelerating , 0, NULL },</div>
<div class="line">{ SIGNAL_RESUME,     SigAct_BrakeOff,         &amp;state_resuming     , 0, NULL },</div>
<div class="line">{ SIGNAL_ENGINE_OFF, NULL,                    &amp;state_idle         , 0, NULL }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> automated_transitions[] =</div>
<div class="line">{</div>
<div class="line">{ SIGNAL_BRAKE_PRESSED,   NULL,               &amp;state_cruisingoff  , 0, NULL }</div>
<div class="line">};</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------*/</span></div>
</div><!-- fragment --><p >Then, signal-actions and state callbacks are later defined</p>
<div class="fragment"><div class="line"><span class="comment">/*=======================================================================*/</span></div>
<div class="line"><span class="comment">/*                      EVENT-SIGNAL ACTIONS AND GUARDS                  */</span></div>
<div class="line"><span class="comment">/*=======================================================================*/</span></div>
<div class="line"><a class="code hl_typedef" href="group__qtypes.html#ga131b2258b5135d0b1e3ded5ecbe309d7">qBool_t</a> SigAct_ClearDesiredSpeed( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    (void)h;</div>
<div class="line">    Speed_ClearDesired();</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_define" href="group__qtypes.html#ga9cd31c446d7a5ead8f65aa28e4d1f2cd">qTrue</a>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------*/</span></div>
<div class="line"><a class="code hl_typedef" href="group__qtypes.html#ga131b2258b5135d0b1e3ded5ecbe309d7">qBool_t</a> SigAct_BrakeOff( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    (void)h; <span class="comment">/*unused*/</span></div>
<div class="line">    <span class="keywordflow">return</span> ( BSP_BREAK_READ() == OFF )? <a class="code hl_define" href="group__qtypes.html#ga9cd31c446d7a5ead8f65aa28e4d1f2cd">qTrue</a> : <a class="code hl_define" href="group__qtypes.html#gabcfc51cee68e399f81b5c109c8e615c7">qFalse</a>;  <span class="comment">/*check guard*/</span></div>
<div class="line">}</div>
<div class="line"><span class="comment">/*=======================================================================*/</span></div>
<div class="line"><span class="comment">/*                  STATE CALLBACK FOR THE TOP FSM                      */</span></div>
<div class="line"><span class="comment">/*=======================================================================*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> state_top_callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> RetVal = <a class="code hl_enumvalue" href="group__qfsm.html#ggae3b8425bb28440f3b2d9decfb65ec5bbae0589365d6a41f782f97d53348e542c9">qSM_STATUS_EXIT_SUCCESS</a>;</div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a185fb13f4184b5f4cc05b01059e31964">Signal</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga66ead48ca76fb2f583f2c7aef8371062">QSM_SIGNAL_ENTRY</a>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga79160319d03d53c51e372bf6c8319e33">QSM_SIGNAL_EXIT</a>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">return</span> RetVal;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*=======================================================================*/</span></div>
<div class="line"><span class="comment">/*                  CALLBACKS FOR THE STATES ABOVE TOP                    */</span></div>
<div class="line"><span class="comment">/*=======================================================================*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> state_idle_callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="comment">/*TODO : state activities*/</span></div>
<div class="line">    <span class="keywordflow">return</span> qSM_EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> state_initial_callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="comment">/*TODO : state activities*/</span></div>
<div class="line">    <span class="keywordflow">return</span> qSM_EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> state_cruisingoff_callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="comment">/*TODO : state activities*/</span></div>
<div class="line">    <span class="keywordflow">return</span> qSM_EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> state_automatedcontrol_callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="comment">/*TODO : state activities*/</span></div>
<div class="line">    <span class="keywordflow">return</span> qSM_EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*=======================================================================*/</span></div>
<div class="line"><span class="comment">/*          STATE CALLBACKS FOR THE AUTOMATED CONTROL FSM                */</span></div>
<div class="line"><span class="comment">/*=======================================================================*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> state_accelerating_callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_s_m___handler__t.html#a185fb13f4184b5f4cc05b01059e31964">Signal</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_define" href="group__qfsm.html#ga79160319d03d53c51e372bf6c8319e33">QSM_SIGNAL_EXIT</a>:</div>
<div class="line">            Speed_SelectDesired();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            Speed_Increase();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> qSM_EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> state_resuming_callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    Cruising_Resume();</div>
<div class="line">    <span class="keywordflow">return</span> qSM_EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qfsm.html#gae3b8425bb28440f3b2d9decfb65ec5bb">qSM_Status_t</a> state_cruising_callback( <a class="code hl_struct" href="structq_s_m___handler__t.html">qSM_Handler_t</a> h ) {</div>
<div class="line">    Speed_Maintain();</div>
<div class="line">    <span class="keywordflow">return</span> qSM_EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qtypes_html_gabcfc51cee68e399f81b5c109c8e615c7"><div class="ttname"><a href="group__qtypes.html#gabcfc51cee68e399f81b5c109c8e615c7">qFalse</a></div><div class="ttdeci">#define qFalse</div><div class="ttdoc">A boolean value that represents false/failure/Off or Low.</div><div class="ttdef"><b>Definition:</b> qtypes.h:157</div></div>
</div><!-- fragment --><p >Finally, the dedicated task for the FSM and related objects are configured.</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="group__qfsm.html#gabf14a12eeeb56b06ffca7341c302293c">qStateMachine_Setup</a>( &amp;Top_SM, state_top_callback, &amp;state_idle, NULL, NULL );</div>
<div class="line"><span class="comment">/*subscribe to the highest level states*/</span></div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;Top_SM, &amp;state_idle, <a class="code hl_define" href="group__qfsm.html#ga07476c08b51bd61cdb87e161ae717d6c">QSM_STATE_TOP</a>, state_idle_callback, NULL, NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;Top_SM, &amp;state_initial, <a class="code hl_define" href="group__qfsm.html#ga07476c08b51bd61cdb87e161ae717d6c">QSM_STATE_TOP</a>, state_initial_callback, NULL, NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;Top_SM, &amp;state_cruisingoff, <a class="code hl_define" href="group__qfsm.html#ga07476c08b51bd61cdb87e161ae717d6c">QSM_STATE_TOP</a>, state_cruisingoff_callback, NULL, NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;Top_SM, &amp;state_automatedcontrol, <a class="code hl_define" href="group__qfsm.html#ga07476c08b51bd61cdb87e161ae717d6c">QSM_STATE_TOP</a>, state_automatedcontrol_callback, NULL, NULL );</div>
<div class="line"><span class="comment">/*subscribe to the states within the state_automatedcontrol*/</span></div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;Top_SM, &amp;state_accelerating, &amp;state_automatedcontrol, state_accelerating_callback, NULL, NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;Top_SM, &amp;state_resuming, &amp;state_automatedcontrol, state_resuming_callback, NULL, NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;Top_SM, &amp;state_cruising, &amp;state_automatedcontrol, state_cruising_callback, NULL, NULL );</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__qqueues.html#gac7b44df16c76bdf45d82f3b7621eec63">qQueue_Setup</a>( &amp;top_sigqueue, topsm_sig_stack, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="structq_s_m___signal__t.html">qSM_Signal_t</a>), <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(topsm_sig_stack) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga238feabe2db7825556f716c6a403a556">qStateMachine_InstallSignalQueue</a>( &amp;Top_SM, &amp;top_sigqueue );</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;state_idle, idle_transitions, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(idle_transitions) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;state_initial, initial_transitions, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(initial_transitions) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;state_cruisingoff, cruisingoff_transitions, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(cruisingoff_transitions) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;state_automatedcontrol, automated_transitions, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(automated_transitions) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;state_accelerating, accel_transitions, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(accel_transitions) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;state_resuming, resuming_transitions, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(resuming_transitions) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;state_cruising, cruising_transitions, <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(cruising_transitions) );</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__qtaskcreation.html#gaeea76a6e287011694689c658f7e204ca">qOS_Add_StateMachineTask</a>(  &amp;CruiseControlTask, &amp;Top_SM, <a class="code hl_define" href="group__qtaskcreation.html#ga13bec7f4284d45c97f512c83ed9b7744">qMedium_Priority</a>, 0.1f, <a class="code hl_define" href="group__qtypes.html#ga1743f4a545347fa50ab81f1e4e21b095">qEnabled</a>, NULL );</div>
</div><!-- fragment --><h3><a class="anchor" id="q_fsm_example4"></a>
Example with history pseudo-states</h3>
<p >State transitions defined in high-level composite states often deal with events that require immediate attention; however, after handling them, the system should return to the most recent substate of the given composite state. UML statecharts address this situation with two kinds of history pseudostates: <em>"shallow history"</em> and <em>"deep history"</em>( denoted as the circled <code>H</code> and <code>H*</code> icon respectively in figure).</p>
<center>  
<!DOCTYPE html>
<html>
<head>
<title>fsmhist</title>
<meta charset="utf-8"/>
</head>
<body><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;zoom&quot;:1.2,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-10-19T18:43:21.516Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\&quot; etag=\&quot;Ch7yXC-GbSBqROWlSNdq\&quot; version=\&quot;20.4.1\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;sgRdDsJHhmN2pV4VL9Bt\&quot; name=\&quot;Página-1\&quot;&gt;7Vtbb+o4EP41vKzUKLbjXB4bWrYr7UpH6sOe87TKIS5YJ8QoMS3tr18bbHKxUQM9AUoDEoonyRjP92VmPHZGaLxY/1kky/k/LCXZCLrpeoTuRhBi6ItfKXjdCm5QEG4ls4KmWxmoBI/0jSihq6QrmpKycSFnLON02RROWZ6TKW/IkqJgL83LnljW7HWZzIgheJwmmSn9l6Z8rqTAj6oTD4TO5qrrEAbbE4tEX6xGUs6TlL3UROh+hMYFY3x7tFiPSSaNp+2yvW+y5+zujxUk511u8P5b+GGcv/21uP1RrPO3+/U4vlFanpNspQas/ix/1RYo2CpPiVTijlD8MqecPC6TqTz7IjAXsjlfZKIFxGHJC/aLjFnGis3dKHTlV5x5olmm5TnLiRSxnE+SBc0kOf5eTWmaiK7HLC+Z7Fwp02YXBouTjM5ycZyRJ64UKMoAV7VtfatBkoKT9V7rgR0mgsyELQgvXsUl6gYUKRgVkQF0PQcqLr/UmKHhntdIAYDneJ4ipSLkbNdFhZk4ULAdACG0QOhn0jw/xcFMHjzyhBOsxaKX3ZlToC3k9778tiF/INkz4XSaWLHuEUwPBC0wgRVMLzSx1Pj+dhxRRxz9Acf9OAb+eUH0Bn96LHRRN+hAX9Dh96EjeXorcwrRmmZJWdJpE60mtLuA73bA5h3Tx5uvjRCuG0wmEyu6JU8Krv+w4shGNqHSNJv/JYakWnIAZE35d3nGiVyk2j9E+8Z1XAHYVnC31vfKxmut8Y0UVIBBCiXbGpCkRor1LktqJMCWgKplBckSTp+b6m3MUD18Y1R0XJHQEwMF7u4DWpT0oBOhaPcJm/pLtiqmRKmsJ16WXoJaLzonNpyWViwgmhFuKBZIJq+1y5bygtLg/c6Kxz8K/uDFjvViqHMi0ZsjC0z0cDwZ4TsDRDFw3kSqZUppHBHXs1slXtA03YBQkJK+JT83iqQtFReFVhzLnoSmFWelQsGggIbajr4CL+zoNvvC1sNtdxBZsbX4p97yi/C6gxQTA2sFKWAGqVxY8nu98WMTsrBuVgFq09IR6uKjUdQmHEROFB0ZdPwOys4eaCILnW1zHm+Y8+wtRICweyGiN7+kg9m7SKIByR2S7gVWIcBQETwavgvI/YCtGnhFCUKnWeylB3qEjdgcOQE8LtCjCDhu7QPbpGxR7ewxH9gKnVdE0S+dwyLQKm6AMDye2m1lECAnAJfGZ1vN15b6wCH1qWJnO4nF0AicMDhpBmvWfx9Mv5RldFmSPoCx2/9R9Q36xQNDIxVFju+ZkNgWN6O+EDHLkA9/fGFIPMsjclI8LIXFYWrQzb0FHd0bwL4RLn8fgLbqoS1SgSFSaSj9NpTQtVeBTzpJt9XNhiexE3ywM3xR1OOmHVu97IomQd1Wm690EmSSDoOjJ0HYa+cBGDog2rsqffb5EOxQQfzM1P7S83sfeo29DKiV58i1iCNXrN5RXY+7l8P1odx6PNf1ZiO5uQh7o2q3kev4eHRte42wTCfcoPLbLXqHwPGA3y7jHhwtdHmsrlcvVFzOY2MpAeP4ftiicug8028nGsA9+xYV2GEP7OATP2v8N/ZIQviB1DZsK0OXndpa9gjj+HbwW4fWNoP2Aqj9ZZrT+i3LrlccxwO4HwZ3z76Ik4Jr3RQ7HsD9MLg4dPCZsT1sU6yy6SfJNqr0aH/BYZdGDJOwj03CEIC9TMKk3subhFkWEXB8N7jEg12i8SYb6Mshimb1wviWCNVr9+j+fw==&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
</body>
</html>
 <em>Example with history pseudo-states</em> </center><ul>
<li><em>Shallow</em> <em>history</em> : A transition to the shallow history state in a composite state invokes the last state that was active, at the same depth as the history state itself, prior to the most recent exit of the composite state.</li>
<li><em>Deep</em> <em>history</em> : A transition to the deep history state within a composite state invokes the state that was active, immediately before the most recent exit of the composite state. The last active state can be nested at any depth.</li>
</ul>
<p >Here, the way to specify this type of transitions in QuarkTS is very straightforward, you only need to assign the history-mode in the last entry of the transition as shown below:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define SIGNAL_A ( (qSM_SigId_t)(1) )</span></div>
<div class="line"><span class="preprocessor">#define SIGNAL_B ( (qSM_SigId_t)(2) )</span></div>
<div class="line"><span class="preprocessor">#define SIGNAL_C ( (qSM_SigId_t)(3) )</span></div>
<div class="line"><span class="preprocessor">#define SIGNAL_D ( (qSM_SigId_t)(4) )</span></div>
<div class="line"><span class="preprocessor">#define SIGNAL_E ( (qSM_SigId_t)(5) )</span></div>
<div class="line"><span class="preprocessor">#define SIGNAL_F ( (qSM_SigId_t)(6) )</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_queue__t.html">qQueue_t</a> sigqueue;</div>
<div class="line"><a class="code hl_struct" href="structq_s_m___signal__t.html">qSM_Signal_t</a> topsm_sig_stack[ 10 ];</div>
<div class="line"><a class="code hl_struct" href="structq_s_m__t.html">qSM_t</a> super;</div>
<div class="line"><a class="code hl_struct" href="structq_s_m___state__t.html">qSM_State_t</a> state1 , state2 , state3 , state4 , state5 , state6;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> state1_transitions [] = {</div>
<div class="line">    { SIGNAL_A , NULL , &amp;state2 , <a class="code hl_enumvalue" href="group__qfsm.html#ggaa410ec930ead4964eaf0d75fc24d230ba713b2659619305f641ed9531081573e9">qSM_TRANSITION_SHALLOW_HISTORY</a>, NULL },</div>
<div class="line">    { SIGNAL_B , NULL , &amp;state2 , <a class="code hl_enumvalue" href="group__qfsm.html#ggaa410ec930ead4964eaf0d75fc24d230ba4dfa279e192e2c5df451d33f87389253">qSM_TRANSITION_DEEP_HISTORY</a>, NULL },</div>
<div class="line">    { SIGNAL_C , NULL , &amp;state2 , <a class="code hl_enumvalue" href="group__qfsm.html#ggaa410ec930ead4964eaf0d75fc24d230bab923ff14a3651b5af267827a6ad08dd7">qSM_TRANSITION_NO_HISTORY</a>, NULL }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> state2_transitions [] = {</div>
<div class="line">    { SIGNAL_D , NULL , &amp;state1 , 0, NULL }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> state3_transitions [] = {</div>
<div class="line">    { SIGNAL_E , NULL , &amp;state4 , 0, NULL }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_s_m___transition__t.html">qSM_Transition_t</a> state5_transitions [] = {</div>
<div class="line">    { SIGNAL_F , NULL , &amp;state6 , 0, NULL }</div>
<div class="line">};</div>
<div class="ttc" id="agroup__qfsm_html_ggaa410ec930ead4964eaf0d75fc24d230ba4dfa279e192e2c5df451d33f87389253"><div class="ttname"><a href="group__qfsm.html#ggaa410ec930ead4964eaf0d75fc24d230ba4dfa279e192e2c5df451d33f87389253">qSM_TRANSITION_DEEP_HISTORY</a></div><div class="ttdeci">@ qSM_TRANSITION_DEEP_HISTORY</div><div class="ttdef"><b>Definition:</b> qfsm.h:191</div></div>
<div class="ttc" id="agroup__qfsm_html_ggaa410ec930ead4964eaf0d75fc24d230ba713b2659619305f641ed9531081573e9"><div class="ttname"><a href="group__qfsm.html#ggaa410ec930ead4964eaf0d75fc24d230ba713b2659619305f641ed9531081573e9">qSM_TRANSITION_SHALLOW_HISTORY</a></div><div class="ttdeci">@ qSM_TRANSITION_SHALLOW_HISTORY</div><div class="ttdef"><b>Definition:</b> qfsm.h:190</div></div>
<div class="ttc" id="agroup__qfsm_html_ggaa410ec930ead4964eaf0d75fc24d230bab923ff14a3651b5af267827a6ad08dd7"><div class="ttname"><a href="group__qfsm.html#ggaa410ec930ead4964eaf0d75fc24d230bab923ff14a3651b5af267827a6ad08dd7">qSM_TRANSITION_NO_HISTORY</a></div><div class="ttdeci">@ qSM_TRANSITION_NO_HISTORY</div><div class="ttdef"><b>Definition:</b> qfsm.h:189</div></div>
</div><!-- fragment --><p >Next, the configuration and topology of the state-machine is presented, including the default transitions (the small circles filled with black). Please do not forget to define the callbacks for each state.</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="group__qfsm.html#gabf14a12eeeb56b06ffca7341c302293c">qStateMachine_Setup</a>( &amp;super , state_top_callback , &amp;state1 , NULL , NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;super , &amp;state1 , <a class="code hl_define" href="group__qfsm.html#ga07476c08b51bd61cdb87e161ae717d6c">QSM_STATE_TOP</a> , state1_callback , NULL , NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;super , &amp;state2 , <a class="code hl_define" href="group__qfsm.html#ga07476c08b51bd61cdb87e161ae717d6c">QSM_STATE_TOP</a> , state2_callback , &amp;state3 , NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;super , &amp;state3 , &amp;state2 , state3_callback , NULL , NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;super , &amp;state4 , &amp;state2 , state4_callback , &amp;state5 , NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;super , &amp;state5 , &amp;state4 , state5_callback , NULL , NULL );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga723ec7aca70eb94880625d78bbe3cac3">qStateMachine_StateSubscribe</a>( &amp;super , &amp;state6 , &amp;state4 , state6_callback , NULL , NULL );</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="group__qqueues.html#gac7b44df16c76bdf45d82f3b7621eec63">qQueue_Setup</a>( &amp;sigqueue , topsm_sig_stack , <span class="keyword">sizeof</span>(<a class="code hl_struct" href="structq_s_m___signal__t.html">qSM_Signal_t</a>), <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>(topsm_sig_stack ) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga238feabe2db7825556f716c6a403a556">qStateMachine_InstallSignalQueue</a>( &amp;super , &amp;sigqueue );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;state1 , state1_transitions , <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>( state1_transitions ) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;state2 , state2_transitions , <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>( state2_transitions ) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;state3 , state3_transitions , <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>( state3_transitions ) );</div>
<div class="line"><a class="code hl_function" href="group__qfsm.html#ga243c71753d0b5d1a402c9bda5c7bc727">qStateMachine_Set_StateTransitions</a>( &amp;state5 , state5_transitions , <a class="code hl_define" href="group__qflm.html#gacb974430bc61fdee7a601e8ea98b0f18">qFLM_ArraySize</a>( state5_transitions ) );</div>
<div class="line"><a class="code hl_function" href="group__qtaskcreation.html#gaeea76a6e287011694689c658f7e204ca">qOS_Add_StateMachineTask</a>( &amp;SMTask , &amp;super , <a class="code hl_define" href="group__qtaskcreation.html#ga13bec7f4284d45c97f512c83ed9b7744">qMedium_Priority</a> , 0.1f, <a class="code hl_define" href="group__qtypes.html#ga1743f4a545347fa50ab81f1e4e21b095">qEnabled</a> , NULL );</div>
</div><!-- fragment --><h1><a class="anchor" id="q_qcoroutines"></a>
Co-Routines</h1>
<p >A task coded as a Co-Routine, is just a task that allows multiple entry points for suspending and resuming execution at certain locations, this feature can bring benefits by improving the task cooperative scheme and providing a linear code execution for event-driven systems without complex state machines or full multithreading.</p>
<center>  
<!DOCTYPE html>
<html>
<head>
<title>coroutines</title>
<meta charset="utf-8"/>
</head>
<body><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;zoom&quot;:1.2,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-10-19T18:53:51.655Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\&quot; etag=\&quot;TUBuhUjvMgM2ZADYfpx0\&quot; version=\&quot;20.4.1\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;9UbcoEgD98S6Um2omTv-\&quot; name=\&quot;Página-1\&quot;&gt;7Vhdb5swFP01PC4yEELy2NBk1bpO1TJp614mB1ywauzMOF/79bsOhmBI0mZVtapqeIjvse+9vj72scDxo3zzUeJFdiMSwhwPJRvHv3Q8z3VRAH8a2VbIoARSSRMD7YEZ/UMMiAy6pAkprIFKCKbowgZjwTmJlYVhKcXaHnYvmJ11gVPSAWYxZl30O01UVlcx2ndcEZpmJvXQC8uOHFeDTSVFhhOxbkD+xPEjKYQqW/kmIkwvXrUupd/0SG89MUm4eorDdZwOiPfz+svlchV94jdzMbr9YKKsMFuagh1vgPOF44/5vNB/v6Ovv8YkpRyGOeEYuhmkG88ltFLdajvocY9DvV7vFYbSxd5RovfIe6UvNL0QdhnS6Se8TL47HGpbnTgpljwhetMi6F5nVJHZAse6dw0aA1imcgaWC81CSfFAIsGE3Hn7CIXTKRyB8T1lrMK54ERDgqspzinTWvR5GdMEQ+pI8ELo5CZYdcw949EIPkT6MfjMTLm2S+1ytY0ZTTkYjNyrusYVkYpsjp5et9YEEFMicqLkFoYYh6FRESOjo8DI6LohSmhYYllDj1yvb8TQCGFah95rBTSMXJwhHV5HOr7h4gGQi+dR2iQO1jyKJkFJ6BEuTm+BiiWgWFdj74ErwlZE0RgfJb9yd1+Awj56IoWDF2LQfxf/N6eubz7U+/XxL9rj9Uev7f7oH7s/nsnpm70/Ohz+9wskOHCBtKgjPLnQr2FgzZmIH75lcJlYfNnk1m9J6Aknrn1uWhSPd88hilvkV6yVkoClqqYsoLQKm1JWTRmKalobqn402nd69r0wMOblxlSzM7bGKBeKJJ23z0d3Q4PtAHXJrjBJGFZ0ZYc/tANMhltBIXG92dxw2EONn+fbey90e31/VP+GdvxCLGVMTMjmO2k3ixXWRSGyI8HKp0R1IgFBeNsYttADipPltBIhdHJmXjBsF3zWeBe5pxN0Z3S2Q/+8ElzU/kLwqMPg3CkFlgM0SqL2ElNv5EOqA+b+e0g5fP9VyZ/8BQ==&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
</body>
</html>
 <em>Coroutines in QuarkTS</em> </center><p >The QuarkTS implementation uses the Duff's device approach, and is heavily inspired by the Knuth method, <a href="https://www.chiark.greenend.org.uk/~sgtatham/coroutines.html" style="font-weight:bold">Simon Tatham's Co-Routines in C</a> and <a href="http://dunkels.com/adam/pt/index.html" style="font-weight:bold">Adam Dunkels Protothreads</a> . This means that a local-continuation variable is used to preserve the current state of execution at a particular place of the Co-Routine scope but without any call history or local variables. This brings benefits to lower RAM usage, but at the cost of some restrictions on how a Co-routine can be used.</p>
<p ><b> Limitations and restrictions </b></p>
<ul>
<li>The stack of a Co-Routine is not maintained when a yield is performed. This means variables allocated on the stack will loose their values. To overcome this, a variable that must maintain its value across a blocking call must be declared as <code>static</code>.</li>
<li>Calls to API functions that could cause the Co-Routine to block, can only be made from the Co-Routine function itself - not from within a function called by the Co-Routine.</li>
<li>The implementation does not permit yielding or blocking calls to be made from within a <code>switch</code> statement.</li>
</ul>
<h2><a class="anchor" id="q_coroutine_code"></a>
Coding a Co-Routine</h2>
<p >The application writer just needs to create the body of the Co-Routine . This means starting a Co-Routine segment with <a class="el" href="group__qcoroutines.html#gac742b61272ef52115b85293aebc933b1" title="Defines a Coroutine segment. The qCR_Begin statement is used to declare the starting point of a Corou...">qCR_Begin</a> and end with <a class="el" href="group__qcoroutines.html#ga06034cac3e4ed8d4153d5dd6e356ebbc" title="Ends a Coroutine segment. Only one segment is allowed inside a task. The qCR_End statement is used to...">qCR_End</a> statement . From now on, yields and blocking calls from the Co-Routine scope are allowed.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> CoroutineTask_Callback( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e ) {</div>
<div class="line">    <a class="code hl_define" href="group__qcoroutines.html#gac742b61272ef52115b85293aebc933b1">qCR_Begin</a> {</div>
<div class="line">        <span class="keywordflow">if</span> ( EventNotComing() ) {</div>
<div class="line">            <a class="code hl_define" href="group__qcoroutines.html#ga6501ee13abbc4bf144b4819112ee592f">qCR_Yield</a>;</div>
<div class="line">        }</div>
<div class="line">        DoTheEventProcessing();</div>
<div class="line">        <a class="code hl_define" href="group__qcoroutines.html#ga6f93776d66aefb50a0bc97090d5f2f2c">qCR_Delay</a>( WAIT_TIME_S );</div>
<div class="line">        PerformActions();</div>
<div class="line">    } <a class="code hl_define" href="group__qcoroutines.html#ga06034cac3e4ed8d4153d5dd6e356ebbc">qCR_End</a>;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qcoroutines_html_ga06034cac3e4ed8d4153d5dd6e356ebbc"><div class="ttname"><a href="group__qcoroutines.html#ga06034cac3e4ed8d4153d5dd6e356ebbc">qCR_End</a></div><div class="ttdeci">#define qCR_End</div><div class="ttdoc">Ends a Coroutine segment. Only one segment is allowed inside a task. The qCR_End statement is used to...</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:259</div></div>
<div class="ttc" id="agroup__qcoroutines_html_ga6501ee13abbc4bf144b4819112ee592f"><div class="ttname"><a href="group__qcoroutines.html#ga6501ee13abbc4bf144b4819112ee592f">qCR_Yield</a></div><div class="ttdeci">#define qCR_Yield</div><div class="ttdoc">This statement is only allowed inside a Coroutine segment. qCR_Yield return the CPU control back to t...</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:268</div></div>
<div class="ttc" id="agroup__qcoroutines_html_ga6f93776d66aefb50a0bc97090d5f2f2c"><div class="ttname"><a href="group__qcoroutines.html#ga6f93776d66aefb50a0bc97090d5f2f2c">qCR_Delay</a></div><div class="ttdeci">#define qCR_Delay(tValue)</div><div class="ttdoc">Delay a coroutine for a given number of time.</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:410</div></div>
<div class="ttc" id="agroup__qcoroutines_html_gac742b61272ef52115b85293aebc933b1"><div class="ttname"><a href="group__qcoroutines.html#gac742b61272ef52115b85293aebc933b1">qCR_Begin</a></div><div class="ttdeci">#define qCR_Begin</div><div class="ttdoc">Defines a Coroutine segment. The qCR_Begin statement is used to declare the starting point of a Corou...</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:222</div></div>
</div><!-- fragment --><p >The <a class="el" href="group__qcoroutines.html#gac742b61272ef52115b85293aebc933b1" title="Defines a Coroutine segment. The qCR_Begin statement is used to declare the starting point of a Corou...">qCR_Begin</a> statement should be placed at the start of the task function in which the Co-routine runs. All C statements above the <a class="el" href="group__qcoroutines.html#gac742b61272ef52115b85293aebc933b1" title="Defines a Coroutine segment. The qCR_Begin statement is used to declare the starting point of a Corou...">qCR_Begin</a> will be executed as if they were in an endless-loop each time the task is scheduled.</p>
<p >A <a class="el" href="group__qcoroutines.html#ga6501ee13abbc4bf144b4819112ee592f" title="This statement is only allowed inside a Coroutine segment. qCR_Yield return the CPU control back to t...">qCR_Yield</a> statement return the CPU control back to the scheduler but saving the execution progress, thereby allowing other processing tasks to take place in the system. With the next task activation, the Co-Routine will resume the execution after the last <a class="el" href="group__qcoroutines.html#ga6501ee13abbc4bf144b4819112ee592f" title="This statement is only allowed inside a Coroutine segment. qCR_Yield return the CPU control back to t...">qCR_Yield</a> statement.</p>
<dl class="section note"><dt>Note</dt><dd>Co-Routine statements can only be invoked from the scope of the Co-Routine. </dd></dl>
<dl class="section remark"><dt>Remarks</dt><dd>Do not use an endless-loop inside a Co-routine ,this behavior it's already hardcoded within the segment definition.</dd></dl>
<h2><a class="anchor" id="q_coroutine_blocking"></a>
Blocking calls in a Co-routine</h2>
<p >Blocking calls inside a Co-Routine should be made with the provided statements, all of them with a common feature: an implicit yield.</p>
<p >A widely used procedure is to wait for a fixed period of time. For this, the <a class="el" href="group__qcoroutines.html#ga6f93776d66aefb50a0bc97090d5f2f2c" title="Delay a coroutine for a given number of time.">qCR_Delay</a> should be used. This statement makes an apparent blocking over the application flow, but to be precise, a yield is performed until the requested time expires, this allows other tasks to be executed until the blocking call finish. This "yielding until condition meet" behavior its the common pattern among the other blocking statements.</p>
<p >Another common blocking call is <a class="el" href="group__qcoroutines.html#ga0605e4d3163a374c51073896903d2ea7" title="Yields until the logical condition being true.">qCR_WaitUntil</a>. This statement takes a condition argument, a logical expression that will be performed when the Co-Routine resumes their execution. As mentioned before, this type of statement exposes the expected behavior, yielding until the condition is met.</p>
<p >An additional wait statement <a class="el" href="group__qcoroutines.html#ga3b15b3de92651cdc83dbc50bf1c4fe04" title="Yields until the logical condition being true or the specified timeout expires.">qCR_TimedWaitUntil</a> is also provided. This one sets a timeout for the logical condition to be met, with a similar behavior of <a class="el" href="group__qcoroutines.html#ga0605e4d3163a374c51073896903d2ea7" title="Yields until the logical condition being true.">qCR_WaitUntil</a>.</p>
<p >Optionally, the Do-Until structure gives to application writer the ability to perform a multi-line job before the yield, allowing more complex actions to being performed after the Co-Routine resumes:</p>
<div class="fragment"><div class="line"><a class="code hl_define" href="group__qcoroutines.html#ga72540d286b976fa69359bdec344af224">qCR_Do</a>{</div>
<div class="line">    <span class="comment">/* Job : a set of instructions*/</span></div>
<div class="line">} <a class="code hl_define" href="group__qcoroutines.html#gad3c43098c3c7da786fd0dec0e3714da7">qCR_Until</a>( Condition );</div>
<div class="ttc" id="agroup__qcoroutines_html_ga72540d286b976fa69359bdec344af224"><div class="ttname"><a href="group__qcoroutines.html#ga72540d286b976fa69359bdec344af224">qCR_Do</a></div><div class="ttdeci">#define qCR_Do</div><div class="ttdoc">This statement start a blocking Job segment.</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:317</div></div>
<div class="ttc" id="agroup__qcoroutines_html_gad3c43098c3c7da786fd0dec0e3714da7"><div class="ttname"><a href="group__qcoroutines.html#gad3c43098c3c7da786fd0dec0e3714da7">qCR_Until</a></div><div class="ttdeci">#define qCR_Until(bCondition)</div><div class="ttdoc">This statement ends a blocking Job segment starting with the qCR_Do statement.</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:334</div></div>
</div><!-- fragment --><h2><a class="anchor" id="q_coroutine_example1"></a>
Co-Routine usage example</h2>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Sender_Task( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e ) {</div>
<div class="line">    <span class="keyword">static</span> <a class="code hl_struct" href="structq_s_timer__t.html">qSTimer_t</a> timeout;</div>
<div class="line">    <a class="code hl_define" href="group__qcoroutines.html#gac742b61272ef52115b85293aebc933b1">qCR_Begin</a> {</div>
<div class="line">        Send_Packet();</div>
<div class="line">        <span class="comment">/* Wait until an acknowledgment has been received, or until</span></div>
<div class="line"><span class="comment">         * the timer expires. If the timer expires, we should send</span></div>
<div class="line"><span class="comment">         * the packet again.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code hl_function" href="group__qstimers.html#ga3eb4d7620b2b14a28ea7bbe39935976a">qSTimer_Set</a>( &amp;timeout, TIMEOUT_TIME );</div>
<div class="line">        <a class="code hl_define" href="group__qcoroutines.html#ga0605e4d3163a374c51073896903d2ea7">qCR_WaitUntil</a>( PacketACK_Received() || <a class="code hl_function" href="group__qstimers.html#ga0d76c7505a0aa2f10af0f867843afa5a">qSTimer_Expired</a>(&amp;timeout));</div>
<div class="line">    }<a class="code hl_define" href="group__qcoroutines.html#ga06034cac3e4ed8d4153d5dd6e356ebbc">qCR_End</a>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> Receiver_Task( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e ) {</div>
<div class="line">    <a class="code hl_define" href="group__qcoroutines.html#gac742b61272ef52115b85293aebc933b1">qCR_Begin</a> {</div>
<div class="line">        <span class="comment">/* Wait until a packet has been received*/</span></div>
<div class="line">        <a class="code hl_define" href="group__qcoroutines.html#ga0605e4d3163a374c51073896903d2ea7">qCR_WaitUntil</a>( Packet_Received() );</div>
<div class="line">        Send_Acknowledgement();</div>
<div class="line">    } <a class="code hl_define" href="group__qcoroutines.html#ga06034cac3e4ed8d4153d5dd6e356ebbc">qCR_End</a>;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qcoroutines_html_ga0605e4d3163a374c51073896903d2ea7"><div class="ttname"><a href="group__qcoroutines.html#ga0605e4d3163a374c51073896903d2ea7">qCR_WaitUntil</a></div><div class="ttdeci">#define qCR_WaitUntil(bCondition)</div><div class="ttdoc">Yields until the logical condition being true.</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:288</div></div>
</div><!-- fragment --><h2><a class="anchor" id="q_coroutine_positions"></a>
Positional jumps</h2>
<p >This feature provides positional local jumps, control flow that deviates from the usual Co-Routine call.</p>
<p >The complementary statements <a class="el" href="group__qcoroutines.html#ga4ea91c30d31877c5aaed2b7c9263b775" title="Labels the current position and saves it to p so it can be later restored by qCR_PositionRestore.">qCR_PositionGet</a> and <a class="el" href="group__qcoroutines.html#ga4b91b9b71c066a015ebe8d7096f2aa4d" title="Restores the Co-Routine position saved in p.">qCR_PositionRestore</a> provide this functionality. The first one saves the Co-Routine state at some point of their execution into <code>CRPos</code>, a variable of type <a class="el" href="group__qcoroutines.html#gacd57e0fda0a5e65cc208419f1c36d7f9">qCR_Position_t</a> , that can be used at some later point of program execution by <a class="el" href="group__qcoroutines.html#ga4b91b9b71c066a015ebe8d7096f2aa4d" title="Restores the Co-Routine position saved in p.">qCR_PositionRestore</a> to restore the Co-Routine state to the one saved by <a class="el" href="group__qcoroutines.html#ga4ea91c30d31877c5aaed2b7c9263b775" title="Labels the current position and saves it to p so it can be later restored by qCR_PositionRestore.">qCR_PositionGet</a> into CRPos. This process can be imagined to be a "jump" back to the point of program execution where <a class="el" href="group__qcoroutines.html#ga4ea91c30d31877c5aaed2b7c9263b775" title="Labels the current position and saves it to p so it can be later restored by qCR_PositionRestore.">qCR_PositionGet</a> saved the Co-Routine environment.</p>
<h2><a class="anchor" id="q_coroutine_semaphores"></a>
Semaphores</h2>
<p >This extension implements counting semaphores on top of Co-Routines. Semaphores are a synchronization primitive that provide two operations: <em>wait</em> and <em>signal</em>. The <em>wait</em> operation checks the semaphore counter and blocks the Co-Routine if the counter is zero. The <em>signal</em> operation increases the semaphore counter but does not block. If another Co-Routine has blocked waiting for the semaphore that is signaled, the blocked Co-Routines will become runnable again.</p>
<p >Semaphores are referenced by handles, a variable of type <a class="el" href="structq_c_r___semaphore__t.html" title="A typedef to instantiate a Co-Routine Semaphore.">qCR_Semaphore_t</a> and must be initialized with <a class="el" href="group__qcoroutines.html#gacddf33244c5a11f79ae40eaf6d57ab34" title="Initializes a semaphore with a value for the counter. Internally, the semaphores use an &quot;unsigned int...">qCR_SemInit</a> before any usage. Here, a value for the counter is required. Internally, semaphores use an <code>uint32_t</code> to represent the counter, therefore the value argument should be within range of this data-type.</p>
<p >To perform the |a wait operation, the <a class="el" href="group__qcoroutines.html#ga48a737b34a6764159b2f1109f4543f99" title="Carries out the &quot;wait&quot; operation on the semaphore. The wait operation causes the Co-routine to block ...">qCR_SemWait</a> statement should be used. The wait operation causes the Co-routine to block while the counter is zero. When the counter reaches a value larger than zero, the Co-Routine will continue.</p>
<p >Finally, <a class="el" href="group__qcoroutines.html#ga1d8e6eae9ea20351034545a918b0f692" title="Carries out the &quot;signal&quot; operation on the semaphore. The signal operation increments the counter insi...">qCR_SemSignal</a> carries out the <em>signal</em> operation on the semaphore. This signaling increments the counter inside the semaphore, which eventually will cause waiting Coroutines to continue executing.</p>
<h2><a class="anchor" id="q_coroutine_example2"></a>
Co-Routine example with semaphores.</h2>
<p >The following example shows how to implement the bounded buffer problem using Co-Routines and semaphores. The example uses two tasks: one that produces items and other that consumes items.</p>
<p >Note that there is no need for a mutex to guard the <code>add_to_buffer()</code> and <code>get_from_buffer()</code> functions because of the implicit locking semantics of Co-Routines, so it will never be preempted and will never block except in an explicit <a class="el" href="group__qcoroutines.html#ga48a737b34a6764159b2f1109f4543f99" title="Carries out the &quot;wait&quot; operation on the semaphore. The wait operation causes the Co-routine to block ...">qCR_SemWait</a> statement.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;HAL.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;QuarkTS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;AppLibrary.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define NUM_ITEMS 32</span></div>
<div class="line"><span class="preprocessor">#define BUFSIZE 8</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_task__t.html">qTask_t</a> ProducerTask, ConsumerTask;</div>
<div class="line"><a class="code hl_struct" href="structq_c_r___semaphore__t.html">qCR_Semaphore_t</a> mutex, full, empty;</div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> ProducerTask_Callback( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e ) {</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> produced;</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_define" href="group__qcoroutines.html#gac742b61272ef52115b85293aebc933b1">qCR_Begin</a> {</div>
<div class="line">        <span class="keywordflow">for</span> ( produced = 0; produced &lt; NUM_ITEMS; ++produced ) {</div>
<div class="line">            <a class="code hl_define" href="group__qcoroutines.html#ga48a737b34a6764159b2f1109f4543f99">qCR_SemWait</a>( &amp;full );</div>
<div class="line">            <a class="code hl_define" href="group__qcoroutines.html#ga48a737b34a6764159b2f1109f4543f99">qCR_SemWait</a>( &amp;mutex );</div>
<div class="line">    </div>
<div class="line">            add_to_buffer( produce_item() );</div>
<div class="line">      </div>
<div class="line">            <a class="code hl_define" href="group__qcoroutines.html#ga1d8e6eae9ea20351034545a918b0f692">qCR_SemSignal</a>( &amp;mutex );</div>
<div class="line">            <a class="code hl_define" href="group__qcoroutines.html#ga1d8e6eae9ea20351034545a918b0f692">qCR_SemSignal</a>( &amp;empty );</div>
<div class="line">        }</div>
<div class="line">    } <a class="code hl_define" href="group__qcoroutines.html#ga06034cac3e4ed8d4153d5dd6e356ebbc">qCR_End</a>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> ConsumerTask_Callback( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e ) {</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> consumed;</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_define" href="group__qcoroutines.html#gac742b61272ef52115b85293aebc933b1">qCR_Begin</a> {</div>
<div class="line">        <span class="keywordflow">for</span> ( consumed = 0; consumed &lt; NUM_ITEMS; ++consumed ) {</div>
<div class="line">            <a class="code hl_define" href="group__qcoroutines.html#ga48a737b34a6764159b2f1109f4543f99">qCR_SemWait</a>( &amp;empty );</div>
<div class="line">            <a class="code hl_define" href="group__qcoroutines.html#ga48a737b34a6764159b2f1109f4543f99">qCR_SemWait</a>( &amp;mutex );</div>
<div class="line">    </div>
<div class="line">            consume_item( get_from_buffer() );</div>
<div class="line">            <a class="code hl_define" href="group__qcoroutines.html#ga1d8e6eae9ea20351034545a918b0f692">qCR_SemSignal</a>( &amp;mutex );</div>
<div class="line">            <a class="code hl_define" href="group__qcoroutines.html#ga1d8e6eae9ea20351034545a918b0f692">qCR_SemSignal</a>( &amp;full );</div>
<div class="line">        }</div>
<div class="line">    } <a class="code hl_define" href="group__qcoroutines.html#ga06034cac3e4ed8d4153d5dd6e356ebbc">qCR_End</a>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> IdleTask_Callback( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e ) {</div>
<div class="line">    <span class="comment">/*nothing to do*/</span></div>
<div class="line">} </div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div>
<div class="line">    HAL_Init();</div>
<div class="line">  </div>
<div class="line">    <a class="code hl_function" href="group__qtaskcreation.html#gac97ca3bd669135e0adcf07fcc2852313">qOS_Setup</a>( HAL_GetTick, 0.001, IdleTask_Callback );</div>
<div class="line">    <a class="code hl_define" href="group__qcoroutines.html#gacddf33244c5a11f79ae40eaf6d57ab34">qCR_SemInit</a>( &amp;empty, 0 );</div>
<div class="line">    <a class="code hl_define" href="group__qcoroutines.html#gacddf33244c5a11f79ae40eaf6d57ab34">qCR_SemInit</a>( &amp;full, BUFSIZE );</div>
<div class="line">    <a class="code hl_define" href="group__qcoroutines.html#gacddf33244c5a11f79ae40eaf6d57ab34">qCR_SemInit</a>( &amp;mutex, 1 );</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_function" href="group__qtaskcreation.html#ga261c858990773b834e8129940ceef1e2">qOS_Add_Task</a>( &amp;ProducerTask, ProducerTask_Callback,</div>
<div class="line">                  <a class="code hl_define" href="group__qtaskcreation.html#ga13bec7f4284d45c97f512c83ed9b7744">qMedium_Priority</a>, 0.1, <a class="code hl_define" href="group__qtaskcreation.html#gae3758e719245db560b090d90fce96301">qPeriodic</a>, <a class="code hl_define" href="group__qtypes.html#ga1743f4a545347fa50ab81f1e4e21b095">qEnabled</a>, NULL );</div>
<div class="line">    <a class="code hl_function" href="group__qtaskcreation.html#ga261c858990773b834e8129940ceef1e2">qOS_Add_Task</a>( &amp;ConsumerTask, ConsumerTask_Callback,</div>
<div class="line">                  <a class="code hl_define" href="group__qtaskcreation.html#ga13bec7f4284d45c97f512c83ed9b7744">qMedium_Priority</a>, 0.1, <a class="code hl_define" href="group__qtaskcreation.html#gae3758e719245db560b090d90fce96301">qPeriodic</a>, <a class="code hl_define" href="group__qtypes.html#ga1743f4a545347fa50ab81f1e4e21b095">qEnabled</a>, NULL );</div>
<div class="line">    <a class="code hl_function" href="group__qtaskcreation.html#gabd4b43371d39c5eb82b87f0900f2895a">qOS_Run</a>();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qcoroutines_html_ga1d8e6eae9ea20351034545a918b0f692"><div class="ttname"><a href="group__qcoroutines.html#ga1d8e6eae9ea20351034545a918b0f692">qCR_SemSignal</a></div><div class="ttdeci">#define qCR_SemSignal(pSem)</div><div class="ttdoc">Carries out the &quot;signal&quot; operation on the semaphore. The signal operation increments the counter insi...</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:371</div></div>
<div class="ttc" id="agroup__qcoroutines_html_ga48a737b34a6764159b2f1109f4543f99"><div class="ttname"><a href="group__qcoroutines.html#ga48a737b34a6764159b2f1109f4543f99">qCR_SemWait</a></div><div class="ttdeci">#define qCR_SemWait(pSem)</div><div class="ttdoc">Carries out the &quot;wait&quot; operation on the semaphore. The wait operation causes the Co-routine to block ...</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:358</div></div>
<div class="ttc" id="agroup__qcoroutines_html_gacddf33244c5a11f79ae40eaf6d57ab34"><div class="ttname"><a href="group__qcoroutines.html#gacddf33244c5a11f79ae40eaf6d57ab34">qCR_SemInit</a></div><div class="ttdeci">#define qCR_SemInit(pSem, sValue)</div><div class="ttdoc">Initializes a semaphore with a value for the counter. Internally, the semaphores use an &quot;unsigned int...</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:346</div></div>
<div class="ttc" id="agroup__qtaskcreation_html_ga261c858990773b834e8129940ceef1e2"><div class="ttname"><a href="group__qtaskcreation.html#ga261c858990773b834e8129940ceef1e2">qOS_Add_Task</a></div><div class="ttdeci">qBool_t qOS_Add_Task(qTask_t *const Task, qTaskFcn_t callbackFcn, const qPriority_t p, const qTime_t t, const qIteration_t n, const qState_t init, void *arg)</div><div class="ttdoc">Add a task to the scheduling scheme. The task is scheduled to run every t seconds,...</div><div class="ttdef"><b>Definition:</b> qkernel.c:409</div></div>
<div class="ttc" id="agroup__qtaskcreation_html_gabd4b43371d39c5eb82b87f0900f2895a"><div class="ttname"><a href="group__qtaskcreation.html#gabd4b43371d39c5eb82b87f0900f2895a">qOS_Run</a></div><div class="ttdeci">qBool_t qOS_Run(void)</div><div class="ttdoc">Executes the scheduling scheme. It must be called once after the task pool has been defined.</div><div class="ttdef"><b>Definition:</b> qkernel.c:668</div></div>
<div class="ttc" id="agroup__qtaskcreation_html_gac97ca3bd669135e0adcf07fcc2852313"><div class="ttname"><a href="group__qtaskcreation.html#gac97ca3bd669135e0adcf07fcc2852313">qOS_Setup</a></div><div class="ttdeci">qBool_t qOS_Setup(const qGetTickFcn_t tFcn, const qTimingBase_t t, qTaskFcn_t idleCallback)</div><div class="ttdoc">Task Scheduler Setup. This function is required and must be called once in the application main threa...</div><div class="ttdef"><b>Definition:</b> qkernel.c:124</div></div>
<div class="ttc" id="agroup__qtaskcreation_html_gae3758e719245db560b090d90fce96301"><div class="ttname"><a href="group__qtaskcreation.html#gae3758e719245db560b090d90fce96301">qPeriodic</a></div><div class="ttdeci">#define qPeriodic</div><div class="ttdoc">A directive indicating that the task will run every time its timeout has expired.</div><div class="ttdef"><b>Definition:</b> qkernel.h:80</div></div>
<div class="ttc" id="astructq_c_r___semaphore__t_html"><div class="ttname"><a href="structq_c_r___semaphore__t.html">qCR_Semaphore_t</a></div><div class="ttdoc">A typedef to instantiate a Co-Routine Semaphore.</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:45</div></div>
</div><!-- fragment --><h2><a class="anchor" id="q_coroutine_ext"></a>
External control</h2>
<p >There are several circumstances where becomes necessary to control the flow of execution outside the segment that defines the Co-routine itself. This is usually used to defer the job of the Co-routine or resume it in response to specific occurrences that arises in other contexts, either tasks or interrupts.</p>
<p >To code this specific situations, a handler to the Co-routine should be defined, a variable of type <a class="el" href="group__qcoroutines.html#gafc285a882ecb225cffa4f5dee1479aa5">qCR_Handle_t</a>. In addition to this, the scope of the target Co-routine must be started with the <a class="el" href="group__qcoroutines.html#ga644e5aee7ee2555bf064cce65116e0b8" title="Defines a Coroutine segment with a supplied external handle. The qCR_BeginWithHandle statement is use...">qCR_BeginWithHandle</a> statement instead of <a class="el" href="group__qcoroutines.html#gac742b61272ef52115b85293aebc933b1" title="Defines a Coroutine segment. The qCR_Begin statement is used to declare the starting point of a Corou...">qCR_Begin</a>.</p>
<div class="fragment"><div class="line"><a class="code hl_typedef" href="group__qcoroutines.html#gafc285a882ecb225cffa4f5dee1479aa5">qCR_Handle_t</a> xHandleCR = NULL; <span class="comment">/*NULL initialization are strictly necessary*/</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> AnotherTask_Callback( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e) {</div>
<div class="line">    <span class="keywordtype">int</span> UserInput = 0;</div>
<div class="line">    <span class="keywordflow">if</span> ( e-&gt;<a class="code hl_variable" href="structq_event__t.html#a7b0ca3c3b637735eeee1f1e9d1105726">FirstIteration</a> ) {</div>
<div class="line">        <a class="code hl_function" href="group__qcoroutines.html#ga528c3a62c9ab72ba87a66c0dcec0329e">qCR_ExternControl</a>( xHandleCR, <a class="code hl_enumvalue" href="group__qcoroutines.html#gga9f8cd9253ebd062b2b6d18eb6125d9dda4fa20825a73a83717d2766e30ed5e749">qCR_RESUME</a>, 0 );</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ( e-&gt;<a class="code hl_variable" href="structq_event__t.html#af000312a956c600f57074345a75536bf">LastIteration</a> ) {</div>
<div class="line">        <a class="code hl_function" href="group__qcoroutines.html#ga528c3a62c9ab72ba87a66c0dcec0329e">qCR_ExternControl</a>( xHandleCR, <a class="code hl_enumvalue" href="group__qcoroutines.html#gga9f8cd9253ebd062b2b6d18eb6125d9dda780e5ce4a9a17017800ebb53cb559caf">qCR_SUSPEND</a>, 0 );</div>
<div class="line">    }</div>
<div class="line">    UserInput = GetTerminalInput( );</div>
<div class="line">    <span class="keywordflow">if</span> ( UserInput == USR_RESTART ) {</div>
<div class="line">        <a class="code hl_function" href="group__qcoroutines.html#ga528c3a62c9ab72ba87a66c0dcec0329e">qCR_ExternControl</a>( xHandleCR, <a class="code hl_enumvalue" href="group__qcoroutines.html#gga9f8cd9253ebd062b2b6d18eb6125d9ddaf2a8bebd046be9446caf5699b9d483dc">qCR_RESTART</a>, 0 );</div>
<div class="line">    }</div>
<div class="line">    Perform_AnotherTask_Activities();</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> CoroutineTask_Callback( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e ) {</div>
<div class="line">    <a class="code hl_define" href="group__qcoroutines.html#ga644e5aee7ee2555bf064cce65116e0b8">qCR_BeginWithHandle</a>( xHandleCR ) { <span class="comment">/*externally controlled*/</span></div>
<div class="line">        <span class="keywordflow">if</span> ( EventNotComing() ) {</div>
<div class="line">            <a class="code hl_define" href="group__qcoroutines.html#ga6501ee13abbc4bf144b4819112ee592f">qCR_Yield</a>;</div>
<div class="line">        }</div>
<div class="line">        RunFirstJob();</div>
<div class="line">        <a class="code hl_define" href="group__qcoroutines.html#ga6f93776d66aefb50a0bc97090d5f2f2c">qCR_Delay</a>( WAIT_TIME );</div>
<div class="line">        SecondJobStatus = RunSecondJob();</div>
<div class="line">        <a class="code hl_define" href="group__qcoroutines.html#ga3b15b3de92651cdc83dbc50bf1c4fe04">qCR_TimedWaitUntil</a>( JobFlag == JOB_SUCCESS, JOB_TIMEOUT );</div>
<div class="line">        CleanUpStatus = CleanupJob();</div>
<div class="line">        <a class="code hl_define" href="group__qcoroutines.html#ga0605e4d3163a374c51073896903d2ea7">qCR_WaitUntil</a>( SomeVar &gt; SomeValue );</div>
<div class="line">    } <a class="code hl_define" href="group__qcoroutines.html#ga06034cac3e4ed8d4153d5dd6e356ebbc">qCR_End</a>;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qcoroutines_html_ga3b15b3de92651cdc83dbc50bf1c4fe04"><div class="ttname"><a href="group__qcoroutines.html#ga3b15b3de92651cdc83dbc50bf1c4fe04">qCR_TimedWaitUntil</a></div><div class="ttdeci">#define qCR_TimedWaitUntil(bCondition, tValue)</div><div class="ttdoc">Yields until the logical condition being true or the specified timeout expires.</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:303</div></div>
<div class="ttc" id="agroup__qcoroutines_html_ga528c3a62c9ab72ba87a66c0dcec0329e"><div class="ttname"><a href="group__qcoroutines.html#ga528c3a62c9ab72ba87a66c0dcec0329e">qCR_ExternControl</a></div><div class="ttdeci">qBool_t qCR_ExternControl(qCR_Handle_t h, const qCR_ExternAction_t action, const qCR_ExtPosition_t pos)</div><div class="ttdoc">Perform an external action over the requested Co-routine.</div><div class="ttdef"><b>Definition:</b> qcoroutine.c:10</div></div>
<div class="ttc" id="agroup__qcoroutines_html_ga644e5aee7ee2555bf064cce65116e0b8"><div class="ttname"><a href="group__qcoroutines.html#ga644e5aee7ee2555bf064cce65116e0b8">qCR_BeginWithHandle</a></div><div class="ttdeci">#define qCR_BeginWithHandle(handle)</div><div class="ttdoc">Defines a Coroutine segment with a supplied external handle. The qCR_BeginWithHandle statement is use...</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:241</div></div>
<div class="ttc" id="agroup__qcoroutines_html_gafc285a882ecb225cffa4f5dee1479aa5"><div class="ttname"><a href="group__qcoroutines.html#gafc285a882ecb225cffa4f5dee1479aa5">qCR_Handle_t</a></div><div class="ttdeci">_qCR_Instance_t * qCR_Handle_t</div><div class="ttdoc">A typedef to instantiate a Co-Routine handle.</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:42</div></div>
<div class="ttc" id="agroup__qcoroutines_html_gga9f8cd9253ebd062b2b6d18eb6125d9dda4fa20825a73a83717d2766e30ed5e749"><div class="ttname"><a href="group__qcoroutines.html#gga9f8cd9253ebd062b2b6d18eb6125d9dda4fa20825a73a83717d2766e30ed5e749">qCR_RESUME</a></div><div class="ttdeci">@ qCR_RESUME</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:67</div></div>
<div class="ttc" id="agroup__qcoroutines_html_gga9f8cd9253ebd062b2b6d18eb6125d9dda780e5ce4a9a17017800ebb53cb559caf"><div class="ttname"><a href="group__qcoroutines.html#gga9f8cd9253ebd062b2b6d18eb6125d9dda780e5ce4a9a17017800ebb53cb559caf">qCR_SUSPEND</a></div><div class="ttdeci">@ qCR_SUSPEND</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:66</div></div>
<div class="ttc" id="agroup__qcoroutines_html_gga9f8cd9253ebd062b2b6d18eb6125d9ddaf2a8bebd046be9446caf5699b9d483dc"><div class="ttname"><a href="group__qcoroutines.html#gga9f8cd9253ebd062b2b6d18eb6125d9ddaf2a8bebd046be9446caf5699b9d483dc">qCR_RESTART</a></div><div class="ttdeci">@ qCR_RESTART</div><div class="ttdef"><b>Definition:</b> qcoroutine.h:64</div></div>
<div class="ttc" id="astructq_event__t_html_a7b0ca3c3b637735eeee1f1e9d1105726"><div class="ttname"><a href="structq_event__t.html#a7b0ca3c3b637735eeee1f1e9d1105726">qEvent_t::FirstIteration</a></div><div class="ttdeci">qBool_t FirstIteration</div><div class="ttdoc">Indicates whether current pass is the first iteration of the task. This flag will be only set when ti...</div><div class="ttdef"><b>Definition:</b> qtasks.h:193</div></div>
<div class="ttc" id="astructq_event__t_html_af000312a956c600f57074345a75536bf"><div class="ttname"><a href="structq_event__t.html#af000312a956c600f57074345a75536bf">qEvent_t::LastIteration</a></div><div class="ttdeci">qBool_t LastIteration</div><div class="ttdoc">Indicates whether current pass is the last iteration of the task. This flag will be only set when tim...</div><div class="ttdef"><b>Definition:</b> qtasks.h:201</div></div>
</div><!-- fragment --><p >As seen in the code snippet above, the Co-routine handle its globally declared to allow other contexts to access it. The example shows that another task can control the Coroutine using the <a class="el" href="group__qcoroutines.html#ga528c3a62c9ab72ba87a66c0dcec0329e" title="Perform an external action over the requested Co-routine.">qCR_ExternControl()</a> API. The actions performed by this API can be only be effective after the handle instantiation, an operation that takes place once on the first call of the Co-routine.</p>
<dl class="section note"><dt>Note</dt><dd>A <code>NULL</code> initialization its mandatory on <a class="el" href="group__qcoroutines.html#gafc285a882ecb225cffa4f5dee1479aa5">qCR_Handle_t</a> variables. Undefined behavior may occur if this step is ignored.</dd></dl>
<h1><a class="anchor" id="q_atcli"></a>
AT Command Line Interface (CLI)</h1>
<p >A command-line interface (CLI) is a way to interact directly with the software of an embedded system in the form of text commands and responses. It can be seen as a typed set of commands to produce a result, but here, the commands are typed in real-time by a user through a specific interface, for example, UART, USB, LAN, etc.</p>
<p >A CLI is often developed to aid initial driver development and debugging. This CLI might become the interface (or one of the interfaces) used by a sophisticated end-user to interact with the product. Think of typing commands to control a machine, or perhaps for low-level access to the control system as a development tool, tweaking time-constants and monitoring low-level system performance during testing.</p>
<h2><a class="anchor" id="q_atcli_components"></a>
The components of the CLI</h2>
<p >The provided development API parses and handles input commands, following a simplified form of the extended AT-commands syntax.</p>
<center>  
<!DOCTYPE html>
<html>
<head>
<title>atcli</title>
<meta charset="utf-8"/>
</head>
<body><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;zoom&quot;:1.2,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-10-19T19:31:39.234Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\&quot; etag=\&quot;iXCP-aXpe9eB9d0tPXyv\&quot; version=\&quot;20.4.1\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;o9YKW9kYFg2IcPfcP6fb\&quot; name=\&quot;Página-1\&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
</body>
</html>
 <em>AT CLI implementation</em> </center><p >As seen in figure, the CLI has a few components described below:</p>
<ul>
<li><b>Input Handler</b> : It is responsible for collecting incoming data from the input in the form of ASCII characters inside a buffer. When this buffer is ready by receiving an EOL(End-Of-Line) byte, it notifies the validator to perform the initial checks.</li>
<li><b>Validator</b> : Take the input string and perform three checks over it:<ol type="1">
<li>The input matches one of the subscribed commands.</li>
<li>The input matches one of the default commands.</li>
<li>The input is unknown</li>
</ol>
</li>
<li><b>Pre-Parser</b> : Takes the input if the validator asserts the first check. It is responsible for syntax validation and classification. Also, prepares the input argument for the next component.</li>
<li><b>Callback or Post-Parser</b> : If input at the pre-parser is valid, the respective command callback is invoked. Here, the application writer is free to handle the command execution and the output response.</li>
<li><b>Output printer</b> : Takes all the return status of the previous components to print out a response at the output.</li>
</ul>
<dl class="section remark"><dt>Remarks</dt><dd>Here, <em>Input</em> and <em>Output</em> should be provided by the application writer, for example, if a UART interface is chosen, the input should take the received bytes from an ISR and the output is a function to print out a single byte.</dd></dl>
<h2><a class="anchor" id="q_atcli_syntax"></a>
Supported syntax</h2>
<p >The syntax is straightforward and the rules are provided below:</p>
<ul>
<li>All command lines must start with AT and end with an <code>EOL</code> character. By default, the CLI uses the carriage return character. (We will use <code>CR</code> to represent a carriage return character in this document).</li>
<li>AT commands are case-insensitive</li>
<li>Only four types of AT commands are allowed:<ul>
<li>Acting (<a class="el" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa8786bb7eb59de20a6eff70589f4d1246">qATCLI_CMDTYPE_ACT</a>) : This is the simplest type of commands that can be subscribed. Its normally used to execute the action that the command should do. This type does not take arguments or modifiers, for example : <code>AT+CMD</code> </li>
<li>Read (<a class="el" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fadfb8cdf3888c18f6c79bd54393d4fa7b">qATCLI_CMDTYPE_READ</a>) : This type of command allows you to read or test a value already configured for the specified parameter. Only one argumentis allowed. for example <code>"AT+CMD?"</code> or <code>"AT+CMD?PARAM1"</code> </li>
<li>Test (<a class="el" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa18f9c75771825773c1b522c2b3428b40">qATCLI_CMDTYPE_TEST</a>) : These types of commands allow you to get the values that can be set for its parameters. No parameters are allowed here. Example <code>"AT+CMD=?"</code> </li>
<li>Parameter Set (<a class="el" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa87994a9d12f31107158d324d7193dd8e">qATCLI_CMDTYPE_PARA</a>) : These types of commands allow n arguments to be passed for setting parameters, for example: <code>AT+CMD=x</code>,y If none of the types is given at the input, the command response will be <code>ERROR</code> </li>
</ul>
</li>
<li>The possible output responses are:<ul>
<li><code>OK:</code> Indicates the successful execution of the command.</li>
<li><code>ERROR:</code> A generalized message to indicate failure in executing the command.</li>
<li><code>UNKNOWN</code> : The input command its not subscribed.</li>
<li><code>NOT ALLOWED</code> : The command syntax is not one of the allowed types.</li>
<li>User-defined: A custom output message defined by the application writer.</li>
<li><code>NONE</code> : No response.</li>
</ul>
</li>
</ul>
<p >All responses are followed by a <code>CR</code> <code>LF</code> </p>
<p >Errors generated during the execution of these AT commands could be due to the following reasons:</p><ul>
<li>Incorrect syntax/parameters of the AT command</li>
<li>Bad parameters or not allowed operations defined by the application writer.</li>
</ul>
<p >In case of an error, the string <code>ERROR</code> or <code>"ERROR:&lt;error_no&gt;"</code> are displayed.</p>
<h2><a class="anchor" id="q_atcli_setup"></a>
Setting up an AT-CLI instance</h2>
<p >Before starting the CLI development, the corresponding instance must be defined; a data structure of type <a class="el" href="structq_a_t_c_l_i__t.html">qATCLI_t</a>. The instance should be initialized using the <a class="el" href="group__qatcli.html#ga3a268bc78e828ca17067f89614f61756" title="Setup an instance of the AT Command Command Line Interface.">qATCLI_Setup()</a> API.</p>
<h2><a class="anchor" id="q_atcli_sub_commands"></a>
Subscribing commands to the parser</h2>
<p >The AT CLI is able to subscribe any number of custom AT commands. For this, the <a class="el" href="group__qatcli.html#gadc4fd0e693b7a1c36fb5c3b7f4f42c33" title="This function subscribes the CLI instance to a specific command with an associated Callback function,...">qATCLI_CmdSubscribe()</a> API should be used.</p>
<p >This function subscribes the CLI instance to a specific command with an associated callback function, so that next time the required command is sent to the CLI input, the callback function will be executed. The CLI parser only analyzes commands that follow the simplified AT-Commands syntax already described.</p>
<h2><a class="anchor" id="q_atcli_cmd_callback"></a>
Writting a command callback</h2>
<p >The command callback should be coded by the application writter. Here, the following prototype should be used:</p>
<div class="fragment"><div class="line"><a class="code hl_enumeration" href="group__qatcli.html#gac5402443a477397530af4e9b7140ebca">qATCLI_Response_t</a> CMD_Callback( <a class="code hl_struct" href="structq_a_t_c_l_i___handler__t.html">qATCLI_Handler_t</a> h ) {</div>
<div class="line">    <span class="comment">/* TODO : The command callback */</span></div>
<div class="line">}</div>
<div class="ttc" id="agroup__qatcli_html_gac5402443a477397530af4e9b7140ebca"><div class="ttname"><a href="group__qatcli.html#gac5402443a477397530af4e9b7140ebca">qATCLI_Response_t</a></div><div class="ttdeci">qATCLI_Response_t</div><div class="ttdoc">an enumeration to define the possible values that can be returned from the callback of a command.</div><div class="ttdef"><b>Definition:</b> qatcli.h:31</div></div>
<div class="ttc" id="astructq_a_t_c_l_i___handler__t_html"><div class="ttname"><a href="structq_a_t_c_l_i___handler__t.html">qATCLI_Handler_t</a></div><div class="ttdoc">The command argument with all the regarding information of the incoming AT command.</div><div class="ttdef"><b>Definition:</b> qatcli.h:99</div></div>
</div><!-- fragment --><p >The callback takes one argument of type <a class="el" href="structq_a_t_c_l_i___handler__t.html">qATCLI_Handler_t</a> and returns a single value. The input argument it's just a pointer to public data of the CLI instance where the command it subscribed to. From the callback context, can be used to print out extra information as a command response, parse the command parameters, and query properties with crucial information about the detected command, like the type, the number of arguments, and the subsequent string after the command text. To see more details please check the <a class="el" href="structq_a_t_c_l_i___handler__t.html">qATCLI_Handler_t</a> struct reference.</p>
<p >The return value (an enum of type <a class="el" href="group__qatcli.html#gac5402443a477397530af4e9b7140ebca">qATCLI_Response_t</a>) determines the response shown by the Output printer component. The possible allowed values are:</p>
<ul>
<li><a class="el" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaa7b3a3d2e9097e42a2b738a09b2f79247">qATCLI_OK</a> : as expected, print out the OK string.</li>
<li><a class="el" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac69cfec92bd21e6abddce5501c2a19df">qATCLI_ERROR</a> : as expected, print out the ERROR string.</li>
<li><a class="el" href="group__qatcli.html#gaf24e23cde8cd2566c1971a161b4b689a" title="Used to indicate an error code as return value inside a command-callback. This code is defined by the...">qATCLI_ERRORCODE(no)</a> : Used to indicate an error code. This code is defined by the application writer and should be a value between <code>1</code> and <code>32766</code>. For example, a return value of <code>QATCLI_ERRORCODE(15)</code>, will print out the string <code>ERROR:15</code>.</li>
<li><a class="el" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac8726c56f12c1314e75544f5454550b6">qATCLI_NORESPONSE</a> : No response will be printed out.</li>
</ul>
<p >A simple example of how the command callback should be coded is showed below:</p>
<div class="fragment"><div class="line"><a class="code hl_enumeration" href="group__qatcli.html#gac5402443a477397530af4e9b7140ebca">qATCLI_Response_t</a> CMD_Callback( <a class="code hl_struct" href="structq_a_t_c_l_i___handler__t.html">qATCLI_Handler_t</a> h ) {</div>
<div class="line">    <a class="code hl_enumeration" href="group__qatcli.html#gac5402443a477397530af4e9b7140ebca">qATCLI_Response_t</a> Response = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac8726c56f12c1314e75544f5454550b6">qATCLI_NORESPONSE</a>;</div>
<div class="line">    <span class="keywordtype">int</span> arg1 = 0;</div>
<div class="line">    <span class="keywordtype">float</span> arg2 = 0;</div>
<div class="line">    <span class="comment">/*check the command-type*/</span></div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#ace2594f0621470e85de85c9c5ee9c06d">Type</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa87994a9d12f31107158d324d7193dd8e">qATCLI_CMDTYPE_PARA</a>:</div>
<div class="line">            <span class="keywordflow">if</span> ( h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#a4e0dcf7af0c2eddf1d9e3e88adda2ff2">NumArgs</a> &gt; 0 ) {</div>
<div class="line">                 arg1 = h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#a24ac6c293d1f9fcd96c4df2395ae495c">GetArgInt</a>( 1 ); <span class="comment">/*get the first argument as integer*/</span></div>
<div class="line">                 <span class="keywordflow">if</span> ( h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#a4e0dcf7af0c2eddf1d9e3e88adda2ff2">NumArgs</a> &gt; 1 ) {</div>
<div class="line">                     arg2 = h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#ab14ba7f0bc38949d572f65e399820e88">GetArgFlt</a>( 2 ); <span class="comment">/*get the second argument as float*/</span></div>
<div class="line">                 }</div>
<div class="line">            }</div>
<div class="line">            sprintf( h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#a36853d82cd782a15d6909ec210081791">Output</a>, <span class="stringliteral">&quot;arg1 = %d arg2 = %f&quot;</span>, arg1, arg2 );</div>
<div class="line">            Response = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac8726c56f12c1314e75544f5454550b6">qATCLI_NORESPONSE</a>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa18f9c75771825773c1b522c2b3428b40">qATCLI_CMDTYPE_TEST</a>:</div>
<div class="line">            h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#acf3fe8ee21670552de2e333b26ea9f9b">puts</a>( <span class="stringliteral">&quot;inmediate message&quot;</span> );</div>
<div class="line">            Response = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaa7b3a3d2e9097e42a2b738a09b2f79247">qATCLI_OK</a>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fadfb8cdf3888c18f6c79bd54393d4fa7b">qATCLI_CMDTYPE_READ</a>:</div>
<div class="line">            strcpy( h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#a36853d82cd782a15d6909ec210081791">Output</a> , <span class="stringliteral">&quot;Test message after the callback&quot;</span>);</div>
<div class="line">            Response = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaa7b3a3d2e9097e42a2b738a09b2f79247">qATCLI_OK</a>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa8786bb7eb59de20a6eff70589f4d1246">qATCLI_CMDTYPE_ACT</a>:</div>
<div class="line">            Response = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaa7b3a3d2e9097e42a2b738a09b2f79247">qATCLI_OK</a>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            Response = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac69cfec92bd21e6abddce5501c2a19df">qATCLI_ERROR</a>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> Response;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qatcli_html_gga5e73b1b723c5a2d924eb0221f76e288fa18f9c75771825773c1b522c2b3428b40"><div class="ttname"><a href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa18f9c75771825773c1b522c2b3428b40">qATCLI_CMDTYPE_TEST</a></div><div class="ttdeci">@ qATCLI_CMDTYPE_TEST</div><div class="ttdef"><b>Definition:</b> qatcli.h:81</div></div>
<div class="ttc" id="agroup__qatcli_html_gga5e73b1b723c5a2d924eb0221f76e288fa8786bb7eb59de20a6eff70589f4d1246"><div class="ttname"><a href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa8786bb7eb59de20a6eff70589f4d1246">qATCLI_CMDTYPE_ACT</a></div><div class="ttdeci">@ qATCLI_CMDTYPE_ACT</div><div class="ttdef"><b>Definition:</b> qatcli.h:83</div></div>
<div class="ttc" id="agroup__qatcli_html_gga5e73b1b723c5a2d924eb0221f76e288fa87994a9d12f31107158d324d7193dd8e"><div class="ttname"><a href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa87994a9d12f31107158d324d7193dd8e">qATCLI_CMDTYPE_PARA</a></div><div class="ttdeci">@ qATCLI_CMDTYPE_PARA</div><div class="ttdef"><b>Definition:</b> qatcli.h:80</div></div>
<div class="ttc" id="agroup__qatcli_html_gga5e73b1b723c5a2d924eb0221f76e288fadfb8cdf3888c18f6c79bd54393d4fa7b"><div class="ttname"><a href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fadfb8cdf3888c18f6c79bd54393d4fa7b">qATCLI_CMDTYPE_READ</a></div><div class="ttdeci">@ qATCLI_CMDTYPE_READ</div><div class="ttdef"><b>Definition:</b> qatcli.h:82</div></div>
<div class="ttc" id="agroup__qatcli_html_ggac5402443a477397530af4e9b7140ebcaa7b3a3d2e9097e42a2b738a09b2f79247"><div class="ttname"><a href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaa7b3a3d2e9097e42a2b738a09b2f79247">qATCLI_OK</a></div><div class="ttdeci">@ qATCLI_OK</div><div class="ttdef"><b>Definition:</b> qatcli.h:35</div></div>
<div class="ttc" id="agroup__qatcli_html_ggac5402443a477397530af4e9b7140ebcaac69cfec92bd21e6abddce5501c2a19df"><div class="ttname"><a href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac69cfec92bd21e6abddce5501c2a19df">qATCLI_ERROR</a></div><div class="ttdeci">@ qATCLI_ERROR</div><div class="ttdef"><b>Definition:</b> qatcli.h:32</div></div>
<div class="ttc" id="agroup__qatcli_html_ggac5402443a477397530af4e9b7140ebcaac8726c56f12c1314e75544f5454550b6"><div class="ttname"><a href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac8726c56f12c1314e75544f5454550b6">qATCLI_NORESPONSE</a></div><div class="ttdeci">@ qATCLI_NORESPONSE</div><div class="ttdef"><b>Definition:</b> qatcli.h:34</div></div>
<div class="ttc" id="astructq_a_t_c_l_i___handler__t_html_a24ac6c293d1f9fcd96c4df2395ae495c"><div class="ttname"><a href="structq_a_t_c_l_i___handler__t.html#a24ac6c293d1f9fcd96c4df2395ae495c">qATCLI_Handler_t::GetArgInt</a></div><div class="ttdeci">int(* GetArgInt)(qIndex_t n)</div><div class="ttdoc">Helper method to get the n argument parsed as integer from the incoming AT command.</div><div class="ttdef"><b>Definition:</b> qatcli.h:124</div></div>
<div class="ttc" id="astructq_a_t_c_l_i___handler__t_html_a36853d82cd782a15d6909ec210081791"><div class="ttname"><a href="structq_a_t_c_l_i___handler__t.html#a36853d82cd782a15d6909ec210081791">qATCLI_Handler_t::Output</a></div><div class="ttdeci">char * Output</div><div class="ttdoc">The CLI output buffer. Can be written by the user.</div><div class="ttdef"><b>Definition:</b> qatcli.h:169</div></div>
<div class="ttc" id="astructq_a_t_c_l_i___handler__t_html_a4e0dcf7af0c2eddf1d9e3e88adda2ff2"><div class="ttname"><a href="structq_a_t_c_l_i___handler__t.html#a4e0dcf7af0c2eddf1d9e3e88adda2ff2">qATCLI_Handler_t::NumArgs</a></div><div class="ttdeci">size_t NumArgs</div><div class="ttdoc">Number of arguments, only available if Type = qATCLI_CMDTYPE_PARA.</div><div class="ttdef"><b>Definition:</b> qatcli.h:181</div></div>
<div class="ttc" id="astructq_a_t_c_l_i___handler__t_html_ab14ba7f0bc38949d572f65e399820e88"><div class="ttname"><a href="structq_a_t_c_l_i___handler__t.html#ab14ba7f0bc38949d572f65e399820e88">qATCLI_Handler_t::GetArgFlt</a></div><div class="ttdeci">qFloat32_t(* GetArgFlt)(qIndex_t n)</div><div class="ttdoc">Helper method to get the n argument parsed as float from the incoming AT command.</div><div class="ttdef"><b>Definition:</b> qatcli.h:133</div></div>
<div class="ttc" id="astructq_a_t_c_l_i___handler__t_html_ace2594f0621470e85de85c9c5ee9c06d"><div class="ttname"><a href="structq_a_t_c_l_i___handler__t.html#ace2594f0621470e85de85c9c5ee9c06d">qATCLI_Handler_t::Type</a></div><div class="ttdeci">qATCLI_CommandType_t Type</div><div class="ttdoc">The incoming command type. *.</div><div class="ttdef"><b>Definition:</b> qatcli.h:185</div></div>
<div class="ttc" id="astructq_a_t_c_l_i___handler__t_html_acf3fe8ee21670552de2e333b26ea9f9b"><div class="ttname"><a href="structq_a_t_c_l_i___handler__t.html#acf3fe8ee21670552de2e333b26ea9f9b">qATCLI_Handler_t::puts</a></div><div class="ttdeci">void(* puts)(const char *s)</div><div class="ttdoc">Writes a string to CLI output without the EOF string appended at the end.</div><div class="ttdef"><b>Definition:</b> qatcli.h:165</div></div>
</div><!-- fragment --><h2><a class="anchor" id="q_atcli_inputh"></a>
Handling the input</h2>
<p >Input handling is simplified using the provided APIs. The <a class="el" href="group__qatcli.html#gaa3787e31d4bfa59317e79097bc23a6c2" title="Feed the CLI input with a single character. This call is mandatory from an interrupt context....">qATCLI_ISRHandler()</a> and <a class="el" href="group__qatcli.html#ga514944cd933323378b33d3f3a557f1a2" title="Feed the CLI input with a string. This call is mandatory from an interrupt context....">qATCLI_ISRHandlerBlock()</a> functions are intended to be used from the interrupt context. This avoids any kind of polling implementation and allows the CLI application to be designed using an event-driven pattern.</p>
<p >Both functions feed the parser input, the first one with a single character and the second with a string. The application writer should call one of these functions from the desired hardware interface, for example, from a UART receive ISR.</p>
<p >If there are no intention to feed the input from the ISR context, the APIs <a class="el" href="group__qatcli.html#ga21fa53455d7bfaedcff0269ae7e1e455" title="Sends a command to the specified AT Command Line Interface instance.">qATCLI_Raise()</a> or <a class="el" href="group__qatcli.html#ga0410b5b7dd03a4ea0225e3d72021bbdb" title="Try to execute the requested command.">qATCLI_Exec()</a> can be called at demand from the base context. As expected, both functions send the string to the specified CLI. The difference between both APIs is that <a class="el" href="group__qatcli.html#ga21fa53455d7bfaedcff0269ae7e1e455" title="Sends a command to the specified AT Command Line Interface instance.">qATCLI_Raise()</a> sends the command through the input, marking it as ready for parsing and acting as the Input handler component.</p>
<p >The <a class="el" href="group__qatcli.html#ga0410b5b7dd03a4ea0225e3d72021bbdb" title="Try to execute the requested command.">qATCLI_Exec()</a>, on the other hand, executes the components of Pre-parsing and Postparsing bypassing the other components, including the Output printer, so that it must be handled by the application writer.</p>
<dl class="section note"><dt>Note</dt><dd>All functions involved with the component Input-handler, ignores non-graphic characters and cast any uppercase to lowercase.</dd></dl>
<h2><a class="anchor" id="q_atcli_run"></a>
Running the CLI parser</h2>
<p >The parser can be invoked directly using the <a class="el" href="group__qatcli.html#gaa6cb92f56f3bfd470c76fee6d68d5e6a" title="Run the AT Command Line Interface when the input is ready.">qATCLI_Run()</a> API. Almost all the components that make up the CLI are performed by this API, except for the Input Handler, that should be managed by the application writer itself.</p>
<p >In this way, the writer of the application must implement the logic that leads this function to be called when the input-ready condition is given.</p>
<p >The simple approach for this is to check the return value of any of the input feeder APIs and set a notification variable when they report a ready input. Later in the base context, a polling job should be performed over this notification variable, running the parser when their value is true, then clearing the value after to avoid unnecessary overhead.</p>
<p >The recommended implementation is to leave this job be handled by a task instead of coding the logic to know when the CLI should run. For this, the <a class="el" href="group__qtaskcreation.html#gaf0b51d7213c21c0afbfd4dbce865c6e2" title="Add a task to the scheduling scheme running an AT Command Line Interface. Task will be scheduled as e...">qOS_Add_ATCLITask()</a> is provided. This API add a task to the scheduling scheme running an AT Command Line Interface and treated as an event-triggered task. The address of the parser instance will be stored in the <code>TaskData</code> storage-Pointer.</p>
<p >After invoked, both CLI and task are linked together in such a way that when an input-ready condition is given, a notification event is sent to the task launching the CLI components. As the task is event-triggered, there is no additional overhead and the writer of the application can assign a priority value to balance the application against other tasks in the scheduling scheme.</p>
<h2><a class="anchor" id="q_atcli_example1"></a>
A CLI example</h2>
<p >The following example demonstrates the usage of a simple command-line interface using the UART peripheral with two subscribed commands :</p><ul>
<li>A command to write and read the state of a GPIO pin <code>"at+gpio"</code>.</li>
<li><p class="startli">A command to retrieve the compilation timestamp <code>"at+info"</code>. First, lets get started defining the required objects to setup the CLI instance:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define CLI_MAX_INPUT_BUFF_SIZE         ( 128 )</span></div>
<div class="line"><span class="preprocessor">#define CLI_MAX_OUTPUT_BUFF_SIZE        ( 128 )</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_task__t.html">qTask_t</a> CLI_Task;</div>
<div class="line"><a class="code hl_struct" href="structq_a_t_c_l_i__t.html">qATCLI_t</a> CLI_Object;</div>
<div class="line"><a class="code hl_struct" href="structq_a_t_c_l_i___command__t.html">qATCLI_Command_t</a> AT_GPIO, AT_INFO;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">char</span> CLI_Input[ AT_CLI_MAX_INPUT_BUFF_SIZE ];</div>
<div class="line"><span class="keywordtype">char</span> CLI_Output[ AT_CLI_MAX_OUTPUT_BUFF_SIZE ];</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*Command callbacks*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qatcli.html#gac5402443a477397530af4e9b7140ebca">qATCLI_Response_t</a> AT_GPIO_Callback( <a class="code hl_struct" href="structq_a_t_c_l_i___handler__t.html">qATCLI_Handler_t</a> h );</div>
<div class="line"><a class="code hl_enumeration" href="group__qatcli.html#gac5402443a477397530af4e9b7140ebca">qATCLI_Response_t</a> AT_INFO_Callback( <a class="code hl_struct" href="structq_a_t_c_l_i___handler__t.html">qATCLI_Handler_t</a> h );</div>
<div class="ttc" id="astructq_a_t_c_l_i___command__t_html"><div class="ttname"><a href="structq_a_t_c_l_i___command__t.html">qATCLI_Command_t</a></div><div class="ttdoc">An AT-Command object.</div><div class="ttdef"><b>Definition:</b> qatcli.h:255</div></div>
<div class="ttc" id="astructq_a_t_c_l_i__t_html"><div class="ttname"><a href="structq_a_t_c_l_i__t.html">qATCLI_t</a></div><div class="ttdoc">An AT Command Line Interface (CLI) object.</div><div class="ttdef"><b>Definition:</b> qatcli.h:202</div></div>
</div><!-- fragment --></li>
</ul>
<p >Then the CLI instance its configured by subscribing commands and adding the task to the OS. A wrapper function its required here to make the UART output-function compatible with the CLI API.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> CLI_OutputChar_Wrapper( <span class="keywordtype">void</span> *sp, <span class="keyword">const</span> <span class="keywordtype">char</span> c ) { <span class="comment">/*CLI output function*/</span></div>
<div class="line">    (void)sp; <span class="comment">/*unused*/</span></div>
<div class="line">    HAL_UART_WriteChar( UART1, c );</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*==================================================================*/</span></div>
<div class="line"><span class="keywordtype">int</span> main( <span class="keywordtype">void</span> ) {</div>
<div class="line">    HAL_Setup();</div>
<div class="line">    <a class="code hl_function" href="group__qtaskcreation.html#gac97ca3bd669135e0adcf07fcc2852313">qOS_Setup</a>( HAL_GetTick, TIMER_TICK, NULL );</div>
<div class="line">    <a class="code hl_function" href="group__qatcli.html#ga3a268bc78e828ca17067f89614f61756">qATCLI_Setup</a>( &amp;CLI_Object, BSP_UART_PUTC, CLI_Input, <span class="keyword">sizeof</span>(CLI_Input), </div>
<div class="line">                  CLI_Output, <span class="keyword">sizeof</span>(CLI_Output) );</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_function" href="group__qatcli.html#gadc4fd0e693b7a1c36fb5c3b7f4f42c33">qATCLI_CmdSubscribe</a>( &amp;CLI_Object, &amp;AT_GPIO, <span class="stringliteral">&quot;at+gpio&quot;</span>, AT_GPIO_Callback, </div>
<div class="line">                         QATCLI_CMDTYPE_ACT | QATCLI_CMDTYPE_READ | </div>
<div class="line">                         QATCLI_CMDTYPE_TEST | QATCLI_CMDTYPE_PARA | 0x22, NULL );</div>
<div class="line">    <a class="code hl_function" href="group__qatcli.html#gadc4fd0e693b7a1c36fb5c3b7f4f42c33">qATCLI_CmdSubscribe</a>( &amp;CLI_Object, &amp;AT_INFO, <span class="stringliteral">&quot;at+info&quot;</span>, AT_INFO_Callback, </div>
<div class="line">                         QATCLI_CMDTYPE_ACT, NULL );</div>
<div class="line">    <a class="code hl_function" href="group__qtaskcreation.html#gaf0b51d7213c21c0afbfd4dbce865c6e2">qOS_Add_ATCLITask</a>( &amp;CLI_Task, &amp;CLI_Object, <a class="code hl_define" href="group__qtaskcreation.html#ga33bd7afc6bdd5e8a995d2cb50e006e3a">qLowest_Priority</a> );</div>
<div class="line">    <a class="code hl_function" href="group__qtaskcreation.html#gabd4b43371d39c5eb82b87f0900f2895a">qOS_Run</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qatcli_html_ga3a268bc78e828ca17067f89614f61756"><div class="ttname"><a href="group__qatcli.html#ga3a268bc78e828ca17067f89614f61756">qATCLI_Setup</a></div><div class="ttdeci">qBool_t qATCLI_Setup(qATCLI_t *const cli, const qPutChar_t outFcn, char *pInput, const size_t sizeInput, char *pOutput, const size_t sizeOutput)</div><div class="ttdoc">Setup an instance of the AT Command Command Line Interface.</div><div class="ttdef"><b>Definition:</b> qatcli.c:112</div></div>
<div class="ttc" id="agroup__qatcli_html_gadc4fd0e693b7a1c36fb5c3b7f4f42c33"><div class="ttname"><a href="group__qatcli.html#gadc4fd0e693b7a1c36fb5c3b7f4f42c33">qATCLI_CmdSubscribe</a></div><div class="ttdeci">qBool_t qATCLI_CmdSubscribe(qATCLI_t *const cli, qATCLI_Command_t *const cmd, char *textCommand, const qATCLI_CommandCallback_t cFcn, qATCLI_Options_t cmdOpt, void *param)</div><div class="ttdoc">This function subscribes the CLI instance to a specific command with an associated Callback function,...</div><div class="ttdef"><b>Definition:</b> qatcli.c:154</div></div>
<div class="ttc" id="agroup__qtaskcreation_html_ga33bd7afc6bdd5e8a995d2cb50e006e3a"><div class="ttname"><a href="group__qtaskcreation.html#ga33bd7afc6bdd5e8a995d2cb50e006e3a">qLowest_Priority</a></div><div class="ttdeci">#define qLowest_Priority</div><div class="ttdoc">A macro directive to indicate the lowest priority level.</div><div class="ttdef"><b>Definition:</b> qkernel.h:71</div></div>
<div class="ttc" id="agroup__qtaskcreation_html_gaf0b51d7213c21c0afbfd4dbce865c6e2"><div class="ttname"><a href="group__qtaskcreation.html#gaf0b51d7213c21c0afbfd4dbce865c6e2">qOS_Add_ATCLITask</a></div><div class="ttdeci">qBool_t qOS_Add_ATCLITask(qTask_t *const Task, qATCLI_t *cli, const qPriority_t p, void *arg)</div><div class="ttdoc">Add a task to the scheduling scheme running an AT Command Line Interface. Task will be scheduled as e...</div><div class="ttdef"><b>Definition:</b> qkernel.c:536</div></div>
</div><!-- fragment --><p >The CLI input its feeded from the interrupt context by using the UART receive ISR:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> interrupt HAL_UART_RxInterrupt( <span class="keywordtype">void</span> ) {</div>
<div class="line">    <span class="keywordtype">char</span> received;</div>
<div class="line">    </div>
<div class="line">    received = HAL_HUART_GetChar( UART1 );</div>
<div class="line">    <a class="code hl_function" href="group__qatcli.html#gaa3787e31d4bfa59317e79097bc23a6c2">qATCLI_ISRHandler</a>( &amp;CLI_Object, received ); <span class="comment">/*Feed the CLI input*/</span></div>
<div class="line">}</div>
<div class="ttc" id="agroup__qatcli_html_gaa3787e31d4bfa59317e79097bc23a6c2"><div class="ttname"><a href="group__qatcli.html#gaa3787e31d4bfa59317e79097bc23a6c2">qATCLI_ISRHandler</a></div><div class="ttdeci">qBool_t qATCLI_ISRHandler(qATCLI_t *const cli, const char c)</div><div class="ttdoc">Feed the CLI input with a single character. This call is mandatory from an interrupt context....</div><div class="ttdef"><b>Definition:</b> qatcli.c:218</div></div>
</div><!-- fragment --><p >Finally, the command-callbacks are later defined to perform the requested operations.</p>
<div class="fragment"><div class="line"><a class="code hl_enumeration" href="group__qatcli.html#gac5402443a477397530af4e9b7140ebca">qATCLI_Response_t</a> AT_GPIO_Callback( <a class="code hl_struct" href="structq_a_t_c_l_i___handler__t.html">qATCLI_Handler_t</a> h ) {</div>
<div class="line">    <a class="code hl_enumeration" href="group__qatcli.html#gac5402443a477397530af4e9b7140ebca">qATCLI_Response_t</a> RetValue = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac69cfec92bd21e6abddce5501c2a19df">qATCLI_ERROR</a>;</div>
<div class="line">    <span class="keywordtype">int</span> pin, value;</div>
<div class="line">   </div>
<div class="line">    <span class="keywordflow">switch</span> ( h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#ace2594f0621470e85de85c9c5ee9c06d">Type</a> ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa8786bb7eb59de20a6eff70589f4d1246">qATCLI_CMDTYPE_ACT</a>: <span class="comment">/*&lt; AT+gpio */</span></div>
<div class="line">            RetValue = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaa7b3a3d2e9097e42a2b738a09b2f79247">qATCLI_OK</a>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa18f9c75771825773c1b522c2b3428b40">qATCLI_CMDTYPE_TEST</a>: <span class="comment">/*&lt; AT+gpio=? */</span></div>
<div class="line">            h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#acf3fe8ee21670552de2e333b26ea9f9b">puts</a>( <span class="stringliteral">&quot;+gpio=&lt;pin&gt;,&lt;value&gt;\r\n&quot;</span> );</div>
<div class="line">            h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#acf3fe8ee21670552de2e333b26ea9f9b">puts</a>( <span class="stringliteral">&quot;+gpio?\r\n&quot;</span> );</div>
<div class="line">            RetValue = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac8726c56f12c1314e75544f5454550b6">qATCLI_NORESPONSE</a>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fadfb8cdf3888c18f6c79bd54393d4fa7b">qATCLI_CMDTYPE_READ</a>: <span class="comment">/*&lt; AT+gpio? */</span></div>
<div class="line">            sprintf( h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#a36853d82cd782a15d6909ec210081791">Output</a>, <span class="stringliteral">&quot;0x%08X&quot;</span>, HAL_GPIO_Read( GPIOA ) );</div>
<div class="line">            RetValue = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac8726c56f12c1314e75544f5454550b6">qATCLI_NORESPONSE</a>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa87994a9d12f31107158d324d7193dd8e">qATCLI_CMDTYPE_PARA</a>: <span class="comment">/*&lt; AT+gpio=&lt;pin&gt;,&lt;value&gt; */</span></div>
<div class="line">            pin = h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#a24ac6c293d1f9fcd96c4df2395ae495c">GetArgInt</a>( 1 );</div>
<div class="line">            value = h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#a24ac6c293d1f9fcd96c4df2395ae495c">GetArgInt</a>( 2 );</div>
<div class="line">            HAL_GPIO_WRITE( GPIOA, pin, value );</div>
<div class="line">            RetValue = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaa7b3a3d2e9097e42a2b738a09b2f79247">qATCLI_OK</a>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        default : <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">     </div>
<div class="line">    <span class="keywordflow">return</span> RetValue;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*==================================================================*/</span></div>
<div class="line"><a class="code hl_enumeration" href="group__qatcli.html#gac5402443a477397530af4e9b7140ebca">qATCLI_Response_t</a> AT_INFO_Callback( <a class="code hl_struct" href="structq_a_t_c_l_i___handler__t.html">qATCLI_Handler_t</a> h ) {</div>
<div class="line">    <a class="code hl_enumeration" href="group__qatcli.html#gac5402443a477397530af4e9b7140ebca">qATCLI_Response_t</a> RetValue = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac69cfec92bd21e6abddce5501c2a19df">qATCLI_ERROR</a>;</div>
<div class="line">   </div>
<div class="line">    <span class="keywordflow">switch</span> ( param-&gt;Type ) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="group__qatcli.html#gga5e73b1b723c5a2d924eb0221f76e288fa8786bb7eb59de20a6eff70589f4d1246">qATCLI_CMDTYPE_ACT</a>: <span class="comment">/*&lt; AT+info */</span></div>
<div class="line">            strcpy( h-&gt;<a class="code hl_variable" href="structq_a_t_c_l_i___handler__t.html#a36853d82cd782a15d6909ec210081791">Output</a>, <span class="stringliteral">&quot;Compilation: &quot;</span> __DATE__ <span class="stringliteral">&quot; &quot;</span> __TIME__ );</div>
<div class="line">            RetValue = <a class="code hl_enumvalue" href="group__qatcli.html#ggac5402443a477397530af4e9b7140ebcaac8726c56f12c1314e75544f5454550b6">qATCLI_NORESPONSE</a>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        default :</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> RetValue;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="q_memmang"></a>
Memory Management</h1>
<p >As the OS is targered to build safe-critical embedded applications, dynamic memory allocation its not allowed for the kernel design, because can lead to out-of-storage run-time failures, which are undesirable. However, some applications can be easily deployed using this allocation scheme, so a safe and portable implementation becomes relevant in the scope of the user-code.</p>
<p >In a typical C environment, memory can be allocated using the standard library functions <code>malloc()</code> and <code>free()</code>, but they may not be suitable in most embedded applications because they are not always available on small microcontrollers or their implementation can be relatively large, taking up valuable code space. Also, there is a range of unspecified and implementation-defined behaviour associated with dynamic memory allocation, as well as a number of other potential pitfalls. Additionally, some implementations can suffer from fragmentation.</p>
<p >To get around this problem, the OS provides its own memory-management interface for dynamic allocation as a fully kernel-independent extension. When the application requires RAM, instead of calling <code>malloc()</code>, call <a class="el" href="group__qmemmang.html#ga3f069d7c779da101ca694b5d630e6233" title="Wrapper API for qMemMang_Allocate() in order to be compatible with malloc(). Allocate a block of memo...">qMalloc()</a>. When RAM is being freed, instead of calling <code>free()</code>, use <a class="el" href="group__qmemmang.html#ga3e181f0109a557d2466895b5ea44bc98" title="Wrapper API for qMemMang_Free() in order to be compatible with free(). Deallocates the space previous...">qFree()</a>. Both functions have the same prototype as the standard C library counterparts.</p>
<h2><a class="anchor" id="q_memmang_principle"></a>
Principle of operation</h2>
<p >The allocation scheme works by subdividing a static array into smaller blocks and using the First-Fit approach.</p>
<center>  
<!DOCTYPE html>
<html>
<head>
<title>memmang</title>
<meta charset="utf-8"/>
</head>
<body><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-10-19T19:51:25.020Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36\&quot; etag=\&quot;0et5L84sQ8dq70hh7EnJ\&quot; version=\&quot;20.4.1\&quot; type=\&quot;google\&quot;&gt;&lt;diagram id=\&quot;qnkYvIl8hSz6jSiMQ8AJ\&quot; name=\&quot;Página-1\&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
</body>
</html>
 <em>First-fit allocation policy</em> </center><p >If adjacent free blocks are available, the implementation combines them into a single larger block, minimizing the risk of fragmentation, making it suitable for applications that repeatedly allocate and free different sized blocks of RAM.</p>
<dl class="section note"><dt>Note</dt><dd>Because memory is statically declared, it will make the application appear to consume a lot of RAM, even before any memory has been allocated from it.</dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>All the memory management APIs are NOT interrupt-safe. Use these APIs only from the base context.</dd></dl>
<dl class="section attention"><dt>Attention</dt><dd>The application is not exempt from memory leaks if the user does not perform adequate memory management. Here, the worst case scenario can occur in the absence of free memory.</dd></dl>
<h2><a class="anchor" id="q_memmang_pools"></a>
Memory pools</h2>
<p >A memory pool its a special resource that allows memory blocks to be dynamically allocated from a user-designated memory region. Instead of typical pools with fixedsize block allocation, the pools in QuarkTS can be of any size, thereby the user is responsible for selecting the appropriate memory pool to allocate data with the same size.</p>
<p >The default memory management unit resides in a memory pool object. Also called the <em>"default pool"</em>. The total amount of available heap space in the default memory pool is set by <code>Q_DEFAULT_HEAP_SIZE</code>, which is defined in <code>qconfig.h</code>.</p>
<p >Besides the default pool, any number of additional memory pools can be defined. Like any other object in QuarkTS, memory pools are referenced by handles, a variable of type <a class="el" href="structq_mem_mang___pool__t.html">qMemMang_Pool_t</a> and should be initialized before use with the <a class="el" href="group__qmemmang.html#gab6eda783bf043945f75582f1ad580209" title="Initializes a memory pool instance. This function should be called once before any heap memory reques...">qMemMang_Pool_Setup()</a> API function.</p>
<p >To perform operations in another memory pool, besides the default pool, an explicit switch should be performed using <a class="el" href="group__qmemmang.html#ga4d7a16afc6ea85ed3e80560d9f4877f4" title="Select the memory pool to perform heap memory requests with qMalloc() and qFree().">qMemMang_Pool_Select()</a> . Here, a pointer to the target pool should be passed as input argument. From now on, every call to <a class="el" href="group__qmemmang.html#ga3f069d7c779da101ca694b5d630e6233" title="Wrapper API for qMemMang_Allocate() in order to be compatible with malloc(). Allocate a block of memo...">qMalloc()</a>, or <a class="el" href="group__qmemmang.html#ga3e181f0109a557d2466895b5ea44bc98" title="Wrapper API for qMemMang_Free() in order to be compatible with free(). Deallocates the space previous...">qFree()</a> will run over the newly selected memory pool. To return to the default pool, a new call to <a class="el" href="group__qmemmang.html#ga4d7a16afc6ea85ed3e80560d9f4877f4" title="Select the memory pool to perform heap memory requests with qMalloc() and qFree().">qMemMang_Pool_Select()</a> is required passing <code>NULL</code> as input argument.</p>
<p >To keep track of the memory usage, the <a class="el" href="group__qmemmang.html#gaea3910a3eda04c8b30fb3332b0430afe" title="Returns the total amount of heap space that remains unallocated for the selected memory pool.">qMemMang_Get_FreeSize()</a> API function returns the number of free bytes in the memory pool at the time the function is called.</p>
<h2><a class="anchor" id="q_memmang_usage"></a>
Usage example</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;QuarkTS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;HAL.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Core.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structq_task__t.html">qTask_t</a> taskA;</div>
<div class="line"><a class="code hl_struct" href="structq_mem_mang___pool__t.html">qMemMang_Pool_t</a> another_heap;</div>
<div class="line"><span class="keywordtype">void</span> taskA_Callback( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e );</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> taskA_Callback( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e ) {</div>
<div class="line">    <span class="keywordtype">int</span> *xdata = NULL;</div>
<div class="line">    <span class="keywordtype">int</span> *ydata = NULL;</div>
<div class="line">    <span class="keywordtype">int</span> *xyoper = NULL;</div>
<div class="line">    <span class="keywordtype">int</span> n = 20;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    </div>
<div class="line">    xyoper = (<span class="keywordtype">int</span>*)<a class="code hl_function" href="group__qmemmang.html#ga3f069d7c779da101ca694b5d630e6233">qMalloc</a>( n*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) );</div>
<div class="line">    xdata = (<span class="keywordtype">int</span>*)<a class="code hl_function" href="group__qmemmang.html#ga3f069d7c779da101ca694b5d630e6233">qMalloc</a>( n*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) );</div>
<div class="line">    <a class="code hl_function" href="group__qmemmang.html#ga4d7a16afc6ea85ed3e80560d9f4877f4">qMemMang_Pool_Select</a>( &amp;another_heap ); <span class="comment">/*change the memory pool*/</span></div>
<div class="line">    <span class="comment">/*ydata will point to a segment allocated in another pool*/</span></div>
<div class="line">    ydata = (<span class="keywordtype">int</span>*)<a class="code hl_function" href="group__qmemmang.html#ga3f069d7c779da101ca694b5d630e6233">qMalloc</a>( n*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) ); </div>
<div class="line">    </div>
<div class="line">    <span class="comment">/*use the memory if could be allocated*/</span></div>
<div class="line">    <span class="keywordflow">if</span> ( xdata &amp;&amp; ydata &amp;&amp; xyoper ) {</div>
<div class="line">        <span class="keywordflow">for</span> ( i = 0 ; i &lt; n ; i++ ) {</div>
<div class="line">            xdata[ i ] = GetXData();</div>
<div class="line">            ydata[ i ] = GetYData();</div>
<div class="line">            xyoper[ i ] = xdata[ i ]*ydata[ i ];</div>
<div class="line">        }</div>
<div class="line">        UseTheMemmory(xyoper);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        qTrace_Message(<span class="stringliteral">&quot;ERROR:ALLOCATION_FAIL&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="group__qmemmang.html#ga3e181f0109a557d2466895b5ea44bc98">qFree</a>( ydata );</div>
<div class="line">    <a class="code hl_function" href="group__qmemmang.html#ga4d7a16afc6ea85ed3e80560d9f4877f4">qMemMang_Pool_Select</a>( NULL ); <span class="comment">/*return to the default pool*/</span></div>
<div class="line">    <a class="code hl_function" href="group__qmemmang.html#ga3e181f0109a557d2466895b5ea44bc98">qFree</a>( xdata );</div>
<div class="line">    <a class="code hl_function" href="group__qmemmang.html#ga3e181f0109a557d2466895b5ea44bc98">qFree</a>( xyoper );</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="keywordtype">char</span> area_another_heap[ 512 ] = { 0 };</div>
<div class="line">    <a class="code hl_function" href="group__qtrace.html#ga88f22f8c295a457f692adc670fcc391f">qTrace_Set_OutputFcn</a>( OutPutChar );</div>
<div class="line">    <span class="comment">/*Create a memory heap*/</span></div>
<div class="line">    <a class="code hl_function" href="group__qmemmang.html#gab6eda783bf043945f75582f1ad580209">qMemMang_Pool_Setup</a>( &amp;another_heap, area_another_heap, 512);</div>
<div class="line">    <a class="code hl_function" href="group__qtaskcreation.html#gac97ca3bd669135e0adcf07fcc2852313">qOS_Setup</a>( HAL_GetTick, 0.001f, IdleTaskCallback );</div>
<div class="line">    <a class="code hl_function" href="group__qtaskcreation.html#ga261c858990773b834e8129940ceef1e2">qOS_Add_Task</a>( &amp;taskA, taskA_Callback, <a class="code hl_define" href="group__qtaskcreation.html#ga33bd7afc6bdd5e8a995d2cb50e006e3a">qLowest_Priority</a>, 0.1f, <a class="code hl_define" href="group__qtaskcreation.html#gae3758e719245db560b090d90fce96301">qPeriodic</a>, <a class="code hl_define" href="group__qtypes.html#ga1743f4a545347fa50ab81f1e4e21b095">qEnabled</a>, NULL );</div>
<div class="line">    <a class="code hl_function" href="group__qtaskcreation.html#gabd4b43371d39c5eb82b87f0900f2895a">qOS_Run</a>();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qmemmang_html_ga3e181f0109a557d2466895b5ea44bc98"><div class="ttname"><a href="group__qmemmang.html#ga3e181f0109a557d2466895b5ea44bc98">qFree</a></div><div class="ttdeci">void qFree(void *ptr)</div><div class="ttdoc">Wrapper API for qMemMang_Free() in order to be compatible with free(). Deallocates the space previous...</div></div>
<div class="ttc" id="agroup__qmemmang_html_ga3f069d7c779da101ca694b5d630e6233"><div class="ttname"><a href="group__qmemmang.html#ga3f069d7c779da101ca694b5d630e6233">qMalloc</a></div><div class="ttdeci">void * qMalloc(size_t mSize)</div><div class="ttdoc">Wrapper API for qMemMang_Allocate() in order to be compatible with malloc(). Allocate a block of memo...</div></div>
<div class="ttc" id="agroup__qmemmang_html_ga4d7a16afc6ea85ed3e80560d9f4877f4"><div class="ttname"><a href="group__qmemmang.html#ga4d7a16afc6ea85ed3e80560d9f4877f4">qMemMang_Pool_Select</a></div><div class="ttdeci">qBool_t qMemMang_Pool_Select(qMemMang_Pool_t *const mPool)</div><div class="ttdoc">Select the memory pool to perform heap memory requests with qMalloc() and qFree().</div></div>
<div class="ttc" id="agroup__qmemmang_html_gab6eda783bf043945f75582f1ad580209"><div class="ttname"><a href="group__qmemmang.html#gab6eda783bf043945f75582f1ad580209">qMemMang_Pool_Setup</a></div><div class="ttdeci">qBool_t qMemMang_Pool_Setup(qMemMang_Pool_t *const mPool, void *pArea, const size_t pSize)</div><div class="ttdoc">Initializes a memory pool instance. This function should be called once before any heap memory reques...</div></div>
<div class="ttc" id="agroup__qtrace_html_ga88f22f8c295a457f692adc670fcc391f"><div class="ttname"><a href="group__qtrace.html#ga88f22f8c295a457f692adc670fcc391f">qTrace_Set_OutputFcn</a></div><div class="ttdeci">void qTrace_Set_OutputFcn(qPutChar_t fcn)</div><div class="ttdoc">This API set the output method for debug/trace messages.</div></div>
<div class="ttc" id="astructq_mem_mang___pool__t_html"><div class="ttname"><a href="structq_mem_mang___pool__t.html">qMemMang_Pool_t</a></div><div class="ttdoc">A Memory Pool object.</div><div class="ttdef"><b>Definition:</b> qmemmang.h:74</div></div>
</div><!-- fragment --><h1><a class="anchor" id="q_trace"></a>
Trace and debugging</h1>
<p >QuarkTS include some basic macros to print out debugging messages. Messages can be simple text or the value of variables in specific base-formats. To use the trace macros, a single-char output function must be defined using the <a class="el" href="group__qtrace.html#ga88f22f8c295a457f692adc670fcc391f" title="This API set the output method for debug/trace messages.">qTrace_Set_OutputFcn()</a> macro.</p>
<p >A single-char output function should follow this prototype:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SingleChar_OutputFcn ( <span class="keywordtype">void</span> *sp , <span class="keyword">const</span> <span class="keywordtype">char</span> c ) {</div>
<div class="line">    <span class="comment">/* TODO : print out the c variable using the</span></div>
<div class="line"><span class="comment">     * selected peripheral.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">}</div>
</div><!-- fragment --><p >The body of this user-defined function should have a hardware-dependent code to print out the <code>c</code> variable through a specific peripheral.</p>
<h2><a class="anchor" id="q_trace_viewvars"></a>
Viewing variables</h2>
<p >For viewing or tracing a variable (up to 32-bit data) through debug, one of the following macros are available: <a class="el" href="group__qtrace.html#ga545321ecdfacab3859e0f96585169b11" title="Output a trace message for the supplied variable (up to 32bit data)">qTrace_Var</a> or <a class="el" href="group__qtrace.html#ga0a0cd2d65d2b667c19ea20116d37d60c" title="Output a debug message for the supplied variable (up to 32bit data)">qDebug_Var</a>.</p>
<p >The only difference between qTrace_ and Debug, is that <code>qTrace_</code> macros, print out additional information provided by the <code>__FILE__</code> , <code>__LINE__</code> and <code>__func__</code> built-in preprocessing macros, mostly available in common C compilers.</p>
<h2><a class="anchor" id="q_trace_mblock"></a>
Viewing a memory block</h2>
<p >For tracing memory from a specified target address, one of the following macros are available: <a class="el" href="group__qtrace.html#gaa89bbcc66af880556169fe2b06ec8d4b" title="Output a trace message for the memory from the specified address (HEX output)">qTrace_Mem</a> or <a class="el" href="group__qtrace.html#ga9330e798a61ecb14fac4436f8a0167ca" title="Output a debug message for the memory from the specified address (HEX output)">qDebug_Mem</a>.</p>
<h2><a class="anchor" id="q_trace_usage"></a>
Usage</h2>
<p >In the example below, an UART output function is coded to act as the printer. Here, the target MCU is an ARM-Cortex M0 with the UART1 as the selected peripheral for this purpose.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> putUART1 ( <span class="keywordtype">void</span> *sp , <span class="keyword">const</span> <span class="keywordtype">char</span> c ) {</div>
<div class="line">    <span class="comment">/* hardware specific code */</span></div>
<div class="line">    UART1_D = c;</div>
<div class="line">    <span class="keywordflow">while</span> ( !( UART1_S1 &amp; UART_S1_TC_MASK ) ) {} <span class="comment">/*wait until TX is done*/</span></div>
<div class="line">}</div>
</div><!-- fragment --><p >As seen above, the function follows the required prototype. Later, in the main thread, call to <a class="el" href="group__qtrace.html#ga88f22f8c295a457f692adc670fcc391f" title="This API set the output method for debug/trace messages.">qTrace_Set_OutputFcn()</a> is used to set up the output-function.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main( <span class="keywordtype">void</span> ) {</div>
<div class="line">    <a class="code hl_function" href="group__qtrace.html#ga88f22f8c295a457f692adc670fcc391f">qTrace_Set_OutputFcn</a>( putUART1 );</div>
<div class="line">    ...</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p >After that, trace macros will be available for use.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> IO_TASK_Callback ( <a class="code hl_struct" href="structq_event__t.html">qEvent_t</a> e ) {</div>
<div class="line">    <span class="keyword">static</span> <a class="code hl_typedef" href="group__qtypes.html#ga7c9e61aae4eeb8b75a71981eebf317ed">qUINT32_t</a> Counter = 0;</div>
<div class="line">    <span class="keywordtype">float</span> Sample;</div>
<div class="line">    ...</div>
<div class="line">    ...</div>
<div class="line">    qTrace_Message( <span class="stringliteral">&quot;IO TASK running...&quot;</span> );</div>
<div class="line">    Counter++;</div>
<div class="line">    <a class="code hl_define" href="group__qtrace.html#gafcaae3d6fc24d431f13facd6a90414b5">qTrace_Variable</a>( Counter , UnsignedDecimal );</div>
<div class="line">    Sample = SensorGetSample ();</div>
<div class="line">    <a class="code hl_define" href="group__qtrace.html#gafcaae3d6fc24d431f13facd6a90414b5">qTrace_Variable</a>( Sample , Float );</div>
<div class="line">    ...</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qtrace_html_gafcaae3d6fc24d431f13facd6a90414b5"><div class="ttname"><a href="group__qtrace.html#gafcaae3d6fc24d431f13facd6a90414b5">qTrace_Variable</a></div><div class="ttdeci">#define qTrace_Variable(v, mode)</div><div class="ttdoc">Same behavior of qTrace_Var.</div><div class="ttdef"><b>Definition:</b> qtrace.h:382</div></div>
<div class="ttc" id="agroup__qtypes_html_ga7c9e61aae4eeb8b75a71981eebf317ed"><div class="ttname"><a href="group__qtypes.html#ga7c9e61aae4eeb8b75a71981eebf317ed">qUINT32_t</a></div><div class="ttdeci">uint32_t qUINT32_t</div><div class="ttdoc">Unsigned integer type with width of exactly 32 bits respectively.</div><div class="ttdef"><b>Definition:</b> qtypes.h:48</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">QuarkTS OS</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
